<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}UTS 2.0{% endblock %}</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/uts-logo.png') }}">
    <link rel="alternate icon" href="{{ url_for('static', filename='images/uts-logo.png') }}">
    <!-- Google Fonts - Google Sans -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome Free Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Custom Styles -->
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <!-- Leaflet CSS for interactive maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-gradient">
        <div class="container">
            <a class="navbar-brand fw-bold" href="{{ url_for('index') }}">
                <img src="{{ url_for('static', filename='images/uts-logo.png') }}" alt="UTS 2.0" class="navbar-logo me-2">
                UTS 2.0
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <div class="navbar-nav ms-auto">
                    {% if session.user_id %}
                        <a class="nav-link" href="{{ url_for('index') }}">
                            <i class="fas fa-chart-line me-1"></i>Dashboard
                        </a>
                        <a class="nav-link" href="{{ url_for('visualizations') }}">
                            <i class="fas fa-chart-pie me-1"></i>Visualizations
                        </a>
                        <a class="nav-link" href="{{ url_for('databases') }}">
                            <i class="fas fa-server me-1"></i>Databases
                        </a>
                        <!-- User Menu Toggle Button -->
                        <button class="btn user-menu-toggle" onclick="toggleUserPanel()" id="userMenuToggle" type="button">
                            <div class="user-menu-wrapper">
                                <i class="fas fa-user-circle user-menu-icon"></i>
                                <span class="user-menu-text">{{ session.username }}</span>
                                <i class="fas fa-chevron-right panel-caret"></i>
                            </div>
                        </button>
                    {% else %}
                        <a class="nav-link" href="{{ url_for('login') }}">
                            <i class="fas fa-sign-in-alt me-1"></i>Login
                        </a>
                        <a class="nav-link" href="{{ url_for('register') }}">
                            <i class="fas fa-user-plus me-1"></i>Register
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </nav>

    <!-- User Menu Side Panel -->
    <div class="user-panel-overlay" id="userPanelOverlay" onclick="closeUserPanel()"></div>
    <div class="user-side-panel" id="userSidePanel">
        <!-- Panel Header -->
        <div class="user-panel-header">
            <div class="panel-title">
                <i class="fas fa-user-circle me-2"></i>
                User Menu
            </div>
            <button class="btn panel-close-btn" onclick="closeUserPanel()" type="button">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- User Profile Section -->
        <div class="user-profile-section">
            <div class="user-profile-info">
                <div class="user-avatar">
                    <i class="fas fa-user-circle"></i>
                </div>
                <div class="user-details">
                    <div class="user-name">{{ session.username }}</div>
                    <div class="user-role">Administrator</div>
                    <div class="user-status">
                        <span class="status-indicator online"></span>
                        Online
                    </div>
                </div>
            </div>
        </div>

        <!-- Panel Content -->
        <div class="user-panel-content">
            <!-- Account Management -->
            <div class="menu-section">
                <div class="menu-section-title">Account</div>
                <div class="menu-items">
                    <a class="panel-menu-item" href="{{ url_for('profile') }}">
                        <i class="fas fa-user me-3"></i>
                        <div class="menu-item-content">
                            <span class="menu-item-title">My Profile</span>
                            <small class="menu-item-desc">Manage your account</small>
                        </div>
                        <i class="fas fa-chevron-right item-arrow"></i>
                    </a>
                    <a class="panel-menu-item" href="{{ url_for('config') }}">
                        <i class="fas fa-cog me-3"></i>
                        <div class="menu-item-content">
                            <span class="menu-item-title">Settings</span>
                            <small class="menu-item-desc">Platform configuration</small>
                        </div>
                        <i class="fas fa-chevron-right item-arrow"></i>
                    </a>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="menu-section">
                <div class="menu-section-title">Quick Actions</div>
                <div class="menu-items">
                    <a class="panel-menu-item" href="{{ url_for('databases') }}">
                        <i class="fas fa-database me-3"></i>
                        <div class="menu-item-content">
                            <span class="menu-item-title">Manage Databases</span>
                            <small class="menu-item-desc">View & configure databases</small>
                        </div>
                        <i class="fas fa-chevron-right item-arrow"></i>
                    </a>
                    <a class="panel-menu-item" href="{{ url_for('visualizations') }}">
                        <i class="fas fa-chart-pie me-3"></i>
                        <div class="menu-item-content">
                            <span class="menu-item-title">Data Visualizations</span>
                            <small class="menu-item-desc">Charts & analytics</small>
                        </div>
                        <i class="fas fa-chevron-right item-arrow"></i>
                    </a>
                </div>
            </div>

            <!-- Help & Support -->
            <div class="menu-section">
                <div class="menu-section-title">Help & Support</div>
                <div class="menu-items">
                    <a class="panel-menu-item" href="#" onclick="showHelp(); return false;">
                        <i class="fas fa-question-circle me-3"></i>
                        <div class="menu-item-content">
                            <span class="menu-item-title">Help Center</span>
                            <small class="menu-item-desc">Documentation & guides</small>
                        </div>
                        <i class="fas fa-chevron-right item-arrow"></i>
                    </a>
                    <a class="panel-menu-item" href="#" onclick="showKeyboardShortcuts(); return false;">
                        <i class="fas fa-keyboard me-3"></i>
                        <div class="menu-item-content">
                            <span class="menu-item-title">Keyboard Shortcuts</span>
                            <small class="menu-item-desc">Learn shortcuts</small>
                        </div>
                        <i class="fas fa-chevron-right item-arrow"></i>
                    </a>
                </div>
            </div>

            <!-- System Actions -->
            <div class="menu-section">
                <div class="menu-items">
                    <a class="panel-menu-item logout-panel-item" href="{{ url_for('logout') }}" onclick="return confirmLogout(event)">
                        <i class="fas fa-sign-out-alt me-3"></i>
                        <div class="menu-item-content">
                            <span class="menu-item-title">Sign Out</span>
                            <small class="menu-item-desc">Logout from Universal Tracking System</small>
                        </div>
                        <i class="fas fa-chevron-right item-arrow"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="container mt-4">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else 'warning' if category == 'warning' else 'success' }} alert-dismissible fade show" role="alert">
                        <i class="fas fa-{{ 'exclamation-triangle' if category == 'error' else 'exclamation-circle' if category == 'warning' else 'check-circle' }} me-2"></i>
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
    </div>

    <footer class="bg-light mt-5 py-4">
        <div class="container text-center">
            <p class="text-muted mb-0">UTS 2.0 - Universal Tracking System</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Leaflet JS for interactive maps -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
    // Fix dropdown menu z-index and positioning issues
    document.addEventListener('DOMContentLoaded', function() {
        // Target only the navbar dropdown menu
        const navbarDropdownToggle = document.querySelector('.navbar .dropdown-toggle');
        const navbarDropdownMenu = document.querySelector('.navbar .dropdown-menu');
        
        if (navbarDropdownToggle && navbarDropdownMenu) {
            navbarDropdownToggle.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                // Toggle dropdown
                navbarDropdownMenu.classList.toggle('show');
                
                // Apply specific styling only to navbar dropdown
                if (navbarDropdownMenu.classList.contains('show')) {
                    navbarDropdownMenu.style.zIndex = '9999';
                    navbarDropdownMenu.style.position = 'absolute';
                    navbarDropdownMenu.style.top = '100%';
                    navbarDropdownMenu.style.left = '0';
                    navbarDropdownMenu.style.marginTop = '0.125rem';
                    navbarDropdownMenu.style.visibility = 'visible';
                    navbarDropdownMenu.style.opacity = '1';
                    navbarDropdownMenu.style.display = 'block';
                    navbarDropdownMenu.style.background = 'white';
                    navbarDropdownMenu.style.border = '1px solid rgba(0, 0, 0, 0.15)';
                    navbarDropdownMenu.style.borderRadius = '0.375rem';
                    navbarDropdownMenu.style.boxShadow = '0 0.5rem 1rem rgba(0, 0, 0, 0.175)';
                    navbarDropdownMenu.style.minWidth = '200px';
                    navbarDropdownMenu.style.padding = '0.5rem';
                } else {
                    navbarDropdownMenu.style.visibility = 'hidden';
                    navbarDropdownMenu.style.opacity = '0';
                }
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.navbar .dropdown')) {
                    navbarDropdownMenu.classList.remove('show');
                    navbarDropdownMenu.style.visibility = 'hidden';
                    navbarDropdownMenu.style.opacity = '0';
                }
            });
        }
    });
    </script>

    <!-- Fix dropdown z-index issue -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Fix dropdown z-index when shown
        const dropdowns = document.querySelectorAll('.dropdown');
        dropdowns.forEach(dropdown => {
            dropdown.addEventListener('show.bs.dropdown', function() {
                const menu = this.querySelector('.dropdown-menu');
                if (menu) {
                    setTimeout(() => {
                        menu.style.zIndex = '99999';
                    }, 1);
                }
            });
            
            dropdown.addEventListener('shown.bs.dropdown', function() {
                const menu = this.querySelector('.dropdown-menu');
                if (menu) {
                    menu.style.zIndex = '99999';
                }
            });
        });
        
        // Also fix any existing dropdowns
        const existingMenus = document.querySelectorAll('.dropdown-menu');
        existingMenus.forEach(menu => {
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                        if (menu.style.zIndex && menu.style.zIndex !== '99999') {
                            menu.style.zIndex = '99999';
                        }
                    }
                });
            });
            observer.observe(menu, { attributes: true, attributeFilter: ['style'] });
        });
    });
    
    // User Side Panel Management
    function toggleUserPanel() {
        const panel = document.getElementById('userSidePanel');
        const overlay = document.getElementById('userPanelOverlay');
        const toggle = document.getElementById('userMenuToggle');
        
        if (panel.classList.contains('active')) {
            closeUserPanel();
        } else {
            openUserPanel();
        }
    }
    
    function openUserPanel() {
        const panel = document.getElementById('userSidePanel');
        const overlay = document.getElementById('userPanelOverlay');
        const toggle = document.getElementById('userMenuToggle');
        
        panel.classList.add('active');
        overlay.classList.add('active');
        toggle.classList.add('active');
        document.body.style.overflow = 'hidden'; // Prevent background scrolling
    }
    
    function closeUserPanel() {
        const panel = document.getElementById('userSidePanel');
        const overlay = document.getElementById('userPanelOverlay');
        const toggle = document.getElementById('userMenuToggle');
        
        panel.classList.remove('active');
        overlay.classList.remove('active');
        toggle.classList.remove('active');
        document.body.style.overflow = ''; // Restore scrolling
    }
    
    // Close panel on escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeUserPanel();
        }
    });
    
    // Helper Functions for Menu Items
    function showHelp() {
        alert('Help Center:\n\n• Documentation: Learn about all features\n• Tutorials: Step-by-step guides\n• FAQs: Common questions answered\n• Video guides: Visual learning resources\n\nFor immediate assistance, contact support.');
        return false;
    }
    
    function showKeyboardShortcuts() {
        const shortcuts = `
Keyboard Shortcuts:

Navigation:
• Ctrl+D - Dashboard
• Ctrl+B - Databases
• Ctrl+V - Visualizations
• Ctrl+S - Settings

General:
• Ctrl+/ - Show this help
• Ctrl+Q - Quick search
• Esc - Close modals/dropdowns
• Tab - Navigate elements

Data Operations:
• Ctrl+E - Export data
• Ctrl+R - Refresh view
• Ctrl+F - Filter data
• Enter - Execute query
        `;
        alert(shortcuts.trim());
        return false;
    }
    
    // Logout confirmation
    function confirmLogout(event) {
        const result = confirm('Are you sure you want to logout from Universal Tracking System?');
        if (!result) {
            event.preventDefault();
            return false;
        }
        return true;
    }
    </script>
    
    {% block scripts %}{% endblock %}
</body>
</html>
