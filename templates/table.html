{% extends "base.html" %}

{% block title %}{{ table_name }} - Jarvis{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-semibold text-gradient">
        <i class="fas fa-table me-2 floating"></i>Table: {{ table_name }}
    </h2>
    <div>
        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary icon-hover">
            <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
        </a>
    </div>
</div>

<!-- Main Content Tabs -->
<div class="card mb-4">
    <div class="card-header">
        <ul class="nav nav-tabs card-header-tabs" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="data-tab" data-bs-toggle="tab" data-bs-target="#data-panel" type="button" role="tab">
                    <i class="fas fa-table me-2"></i>Table Data
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="sql-tab" data-bs-toggle="tab" data-bs-target="#sql-panel" type="button" role="tab">
                    <i class="fas fa-code me-2"></i>SQL Query
                </button>
            </li>
        </ul>
    </div>
    <div class="card-body p-0">
        <div class="tab-content" id="mainTabContent">
            <!-- Table Data Tab -->
            <div class="tab-pane fade show active" id="data-panel" role="tabpanel">
                <!-- Filter Panel -->
                <div class="card mb-4 filter-panel">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 fw-semibold">
                            <i class="fas fa-filter me-2"></i>Advanced Filters
                            <span id="filterCountBadge" class="badge bg-primary ms-2 d-none">0</span>
                        </h5>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="toggleFilterPanel()">
                                <i class="fas fa-chevron-down" id="filterToggleIcon"></i>
                                <span id="filterToggleText">Show Filters</span>
                            </button>
                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="clearAllFilters()" id="clearFiltersBtn" disabled>
                                <i class="fas fa-trash me-1"></i>Clear All
                            </button>
                        </div>
                    </div>
    <div class="card-body filter-body" style="display: none;">
        <!-- Filter Builder -->
        <div id="filterBuilder">
            <!-- Main Logic Selection -->
            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label fw-semibold">Main Logic</label>
                    <select class="form-select" id="mainLogic">
                        <option value="AND">AND (All conditions must match)</option>
                        <option value="OR">OR (Any condition can match)</option>
                    </select>
                </div>
                <div class="col-md-6 d-flex align-items-end">
                    <button type="button" class="btn btn-success" onclick="addFilterGroup()">
                        <i class="fas fa-plus me-1"></i>Add Filter Group
                    </button>
                </div>
            </div>
            
            <!-- Filter Groups Container -->
            <div id="filterGroups">
                <!-- Filter groups will be dynamically added here -->
            </div>
            
            <!-- Action Buttons -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-primary" onclick="applyFilters()">
                            <i class="fas fa-search me-1"></i>Apply Filters
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="resetFilters()">
                            <i class="fas fa-undo me-1"></i>Reset
                        </button>
                        <button type="button" class="btn btn-outline-info" onclick="saveFilterPreset()">
                            <i class="fas fa-save me-1"></i>Save Preset
                        </button>
                        <button type="button" class="btn btn-outline-warning" onclick="loadFilterPreset()">
                            <i class="fas fa-upload me-1"></i>Load Preset
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Data Panel -->
<div class="card table-data-card">
    <div class="card-header data-ribbon">
        <!-- Left Section: Data Info -->
        <div class="ribbon-left">
            <h5 class="data-title mb-0 fw-semibold">
                <i class="fas fa-list me-2"></i>Data 
                <span id="dataInfo" class="data-count">
                    {% if filtered %}
                        <span class="badge bg-warning">Filtered</span>
                    {% endif %}
                    <span id="rowCountDisplay">({{ (rows|length if rows else 0) }} of {{ total_rows }} rows)</span>
                </span>
            </h5>
        </div>
            
        <!-- Center Section: View Toggle Controls -->
        <div class="ribbon-center">
            <div class="view-toggle-controls">
                <button type="button" class="view-toggle-btn active" id="tableViewBtn" onclick="switchToTableView()">
                    <i class="fas fa-table"></i>
                    <span class="d-none d-md-inline">Table</span>
                </button>
                <button type="button" class="view-toggle-btn" id="listViewBtn" onclick="switchToListView()">
                    <i class="fas fa-list"></i>
                    <span class="d-none d-md-inline">List</span>
                </button>
            </div>
        </div>
        
        <!-- Right Section: Controls -->
        <div class="ribbon-right">
            <!-- Pagination Controls -->
            <div class="pagination-controls">
            <div class="btn-group" role="group" aria-label="Rows per page">
                <a href="#" onclick="changePageSize(25)" 
                   class="btn btn-outline-primary btn-sm {{ 'active' if per_page == 25 else '' }}">25</a>
                <a href="#" onclick="changePageSize(50)" 
                   class="btn btn-outline-primary btn-sm {{ 'active' if per_page == 50 else '' }}">50</a>
                <a href="#" onclick="changePageSize(100)" 
                   class="btn btn-outline-primary btn-sm {{ 'active' if per_page == 100 else '' }}">100</a>
                <a href="#" onclick="changePageSize(250)" 
                   class="btn btn-outline-primary btn-sm {{ 'active' if per_page == 250 else '' }}">250</a>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="action-buttons">
                <button type="button" class="btn btn-success btn-sm icon-hover" onclick="tryExport()">
                <i class="fas fa-download me-1"></i>Export CSV
            </button>
            
            <button type="button" class="btn btn-outline-secondary btn-sm icon-hover" onclick="refreshData()">
                <i class="fas fa-sync-alt me-1"></i>Refresh
            </button>
            </div>
        </div>
    </div>
    
    <div class="card-body p-0">
        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="text-center py-5 d-none">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-muted">Loading data...</p>
        </div>
        
        <!-- Data Views Container -->
        <div id="dataContainer">
            {% if rows %}
                <!-- Traditional Table View -->
                <div id="tableView" class="data-view">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0" id="dataTable">
                            <thead class="table-dark sticky-top">
                                <tr>
                                    <th scope="col" style="width: 60px;">#</th>
                                    {% for column in columns %}
                                        <th scope="col" class="column-header" data-column="{{ column }}">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span>{{ column }}</span>
                                                <div class="column-actions">
                                                    <button class="btn btn-sm btn-outline-light column-filter-btn" 
                                                            onclick="quickFilter('{{ column }}')" 
                                                            title="Quick filter">
                                                        <i class="fas fa-filter"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-light column-sort-btn" 
                                                            onclick="sortColumn('{{ column }}')" 
                                                            title="Sort column">
                                                        <i class="fas fa-sort"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in rows %}
                                    <tr class="data-row">
                                        <td class="row-number">{{ (page - 1) * per_page + loop.index }}</td>
                                        {% for cell in row %}
                                            <td class="data-cell">
                                                {% if cell is none %}
                                                    <span class="text-muted font-italic null-value">NULL</span>
                                                {% elif cell == '' %}
                                                    <span class="text-muted font-italic empty-value">Empty</span>
                                                {% else %}
                                                    <span class="cell-content">{{ cell|string }}</span>
                                                {% endif %}
                                            </td>
                                        {% endfor %}
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Enhanced List View -->
                <div id="listView" class="data-view d-none">
                    <div class="list-view-container">
                        <div class="list-view-header">
                            <i class="fas fa-list-ul me-2"></i>
                            {% if view_config and view_config.list %}
                                <span>Custom view configured - click on primary value to view full details</span>
                                <small class="text-muted ms-3">
                                    <i class="fas fa-cog"></i> Using saved view configuration
                                </small>
                            {% else %}
                                <span>Showing key columns - click on primary value to view full details</span>
                                <small class="text-muted ms-3">
                                    <a href="{{ url_for('view_config') }}" class="text-decoration-none">
                                        <i class="fas fa-cog"></i> Configure custom view
                                    </a>
                                </small>
                            {% endif %}
                        </div>
                        
                        <!-- Column Headers (shown once at top) -->
                        <div class="list-view-column-headers d-none d-md-flex">
                            {% if view_config and view_config.list %}
                                <!-- Use configured primary column -->
                                <div class="list-header-primary">
                                    {{ view_config.list.primary if view_config.list.primary else (columns[0] if columns else 'Column 1') }}
                                </div>
                                <!-- Use configured secondary columns -->
                                {% for field in view_config.list.secondary %}
                                    <div class="list-header-cell">{{ field }}</div>
                                {% endfor %}
                            {% else %}
                                <!-- Default view: first 5 columns -->
                                <div class="list-header-primary">{{ columns[0] if columns else 'Column 1' }}</div>
                                {% for i in range(1, [5, (columns|length if columns else 0)]|min) %}
                                    <div class="list-header-cell">{{ columns[i] }}</div>
                                {% endfor %}
                            {% endif %}
                            <div class="list-header-actions">Actions</div>
                        </div>
                        <div class="list-view-body" id="listViewBody">
                            {% for row in rows %}
                                <div class="list-row" data-row-index="{{ loop.index0 }}">
                                    {% if view_config and view_config.list %}
                                        <!-- Primary Column (Configured) -->
                                        {% set primary_idx = columns.index(view_config.list.primary) if view_config.list.primary in columns else 0 %}
                                        <div class="list-row-primary" onclick="showRowDetails({{ loop.index0 }})">
                                            <span class="list-row-primary-content">
                                                {% if row[primary_idx] is none %}
                                                    <span class="text-muted">NULL</span>
                                                {% elif row[primary_idx] == '' %}
                                                    <span class="text-muted">Empty</span>
                                                {% else %}
                                                    {{ row[primary_idx]|string }}
                                                {% endif %}
                                            </span>
                                        </div>

                                        <!-- Secondary Columns (Configured) -->
                                        <div class="list-row-data">
                                            {% for field in view_config.list.secondary %}
                                                {% if field in columns %}
                                                    {% set field_idx = columns.index(field) %}
                                                    {% if field_idx < (row|length if row else 0) %}
                                                        <div class="list-row-cell">
                                                            <!-- Mobile label (shown only on small screens) -->
                                                            <div class="list-row-cell-label d-md-none">{{ field }}</div>
                                                            <div class="list-row-cell-value">
                                                            {% if row[field_idx] is none %}
                                                                <span class="text-muted null-value">NULL</span>
                                                            {% elif row[field_idx] == '' %}
                                                                <span class="text-muted empty-value">Empty</span>
                                                            {% else %}
                                                                {{ row[field_idx]|string|truncate(50) }}
                                                            {% endif %}
                                                            </div>
                                                        </div>
                                                    {% endif %}
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    {% else %}
                                        <!-- Default view: Primary Column (First Column) -->
                                        <div class="list-row-primary" onclick="showRowDetails({{ loop.index0 }})">
                                            <span class="list-row-primary-content">
                                                {% if row[0] is none %}
                                                    <span class="text-muted">NULL</span>
                                                {% elif row[0] == '' %}
                                                    <span class="text-muted">Empty</span>
                                                {% else %}
                                                    {{ row[0]|string }}
                                                {% endif %}
                                            </span>
                                        </div>

                                        <!-- Default view: Key Data Columns (2-5) -->
                                        <div class="list-row-data">
                                            {% for i in range(1, [5, (columns|length if columns else 0)]|min) %}
                                                {% if i < (row|length if row else 0) %}
                                                    <div class="list-row-cell">
                                                        <!-- Mobile label (shown only on small screens) -->
                                                        <div class="list-row-cell-label d-md-none">{{ columns[i] }}</div>
                                                        <div class="list-row-cell-value">
                                                        {% if row[i] is none %}
                                                            <span class="text-muted null-value">NULL</span>
                                                        {% elif row[i] == '' %}
                                                            <span class="text-muted empty-value">Empty</span>
                                                        {% else %}
                                                            {{ row[i]|string|truncate(50) }}
                                                        {% endif %}
                                                        </div>
                                                    </div>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    {% endif %}

                                    <!-- Action Buttons -->
                                    <div class="list-row-actions">
                                        <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); showRowDetails({{ loop.index0 }});">
                                            <i class="fas fa-eye"></i>
                                            <span class="d-none d-md-inline ms-1">Details</span>
                                        </button>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted fw-semibold">No data found</h5>
                    <p class="text-muted fw-medium">
                        {% if filtered %}
                            No rows match your filter criteria. Try adjusting your filters.
                        {% else %}
                            This table appears to be empty.
                        {% endif %}
                    </p>
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Pagination Footer -->
    {% if total_rows > per_page %}
    <div class="card-footer">
        <div class="d-flex justify-content-between align-items-center">
            <small class="text-muted fw-medium">
                <i class="fas fa-info-circle me-1"></i>
                Showing {{ (page - 1) * per_page + 1 }} to {{ [(page * per_page), total_rows] | min }} of {{ total_rows }} rows
                {% if filtered %}
                    <span class="badge bg-warning">Filtered</span>
                {% endif %}
            </small>
            
            <!-- Pagination Controls -->
            <nav aria-label="Table pagination">
                <ul class="pagination pagination-sm mb-0">
                    <!-- First Page -->
                    <li class="page-item {{ 'disabled' if page <= 1 else '' }}">
                        <a class="page-link" href="#" onclick="changePage(1)">
                            <i class="fas fa-angle-double-left"></i>
                        </a>
                    </li>
                    
                    <!-- Previous Page -->
                    <li class="page-item {{ 'disabled' if page <= 1 else '' }}">
                        <a class="page-link" href="#" onclick="changePage({{ page - 1 }})">
                            <i class="fas fa-angle-left"></i>
                        </a>
                    </li>
                    
                    <!-- Page Numbers -->
                    {% set start_page = [1, page - 2] | max %}
                    {% set end_page = [total_pages, page + 2] | min %}
                    
                    {% if start_page > 1 %}
                        <li class="page-item"><span class="page-link">...</span></li>
                    {% endif %}
                    
                    {% for p in range(start_page, end_page + 1) %}
                        <li class="page-item {{ 'active' if p == page else '' }}">
                            <a class="page-link" href="#" onclick="changePage({{ p }})">{{ p }}</a>
                        </li>
                    {% endfor %}
                    
                    {% if end_page < total_pages %}
                        <li class="page-item"><span class="page-link">...</span></li>
                    {% endif %}
                    
                    <!-- Next Page -->
                    <li class="page-item {{ 'disabled' if page >= total_pages else '' }}">
                        <a class="page-link" href="#" onclick="changePage({{ page + 1 }})">
                            <i class="fas fa-angle-right"></i>
                        </a>
                    </li>
                    
                    <!-- Last Page -->
                    <li class="page-item {{ 'disabled' if page >= total_pages else '' }}">
                        <a class="page-link" href="#" onclick="changePage({{ total_pages }})">
                            <i class="fas fa-angle-double-right"></i>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
    {% endif %}
                </div>
            </div>
            
            <!-- SQL Query Tab -->
            <div class="tab-pane fade" id="sql-panel" role="tabpanel">
                <div class="sql-workbench">
                    <!-- Database Explorer Sidebar -->
                    <div class="explorer-sidebar">
                        <div class="explorer-header">
                            <h6 class="mb-0">
                                <i class="fas fa-database me-2"></i>Database Explorer
                            </h6>
                            <button class="btn btn-sm btn-outline-secondary" onclick="refreshExplorer()" title="Refresh">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                        <div class="explorer-content">
                            <!-- Tables Section -->
                            <div class="explorer-section">
                                <div class="explorer-section-header" onclick="toggleExplorerSection('tables')">
                                    <i class="fas fa-table me-2"></i>Tables
                                    <i class="fas fa-chevron-down" id="tables-chevron"></i>
                                </div>
                                <div class="explorer-section-content" id="tables-content">
                                    <div class="explorer-search">
                                        <input type="text" class="form-control form-control-sm" id="tableSearch" placeholder="Search tables...">
                                    </div>
                                    <div class="explorer-list" id="tablesList">
                                        <div class="explorer-item" onclick="selectTable('{{ table_name }}')" draggable="true" ondragstart="dragTable(event, '{{ table_name }}')">
                                            <i class="fas fa-table me-2"></i>{{ table_name }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Fields Section -->
                            <div class="explorer-section">
                                <div class="explorer-section-header" onclick="toggleExplorerSection('fields')">
                                    <i class="fas fa-columns me-2"></i>Fields
                                    <i class="fas fa-chevron-down" id="fields-chevron"></i>
                                </div>
                                <div class="explorer-section-content" id="fields-content">
                                    <div class="explorer-search">
                                        <input type="text" class="form-control form-control-sm" id="fieldSearch" placeholder="Search fields...">
                                    </div>
                                    <div class="explorer-list" id="fieldsList">
                                        {% for column in columns %}
                                        <div class="explorer-item" onclick="insertField('{{ column }}')" draggable="true" ondragstart="dragField(event, '{{ column }}')">
                                            <i class="fas fa-columns me-2"></i>{{ column }}
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Query History Section -->
                            <div class="explorer-section">
                                <div class="explorer-section-header" onclick="toggleExplorerSection('history')">
                                    <i class="fas fa-history me-2"></i>Query History
                                    <i class="fas fa-chevron-down" id="history-chevron"></i>
                                </div>
                                <div class="explorer-section-content" id="history-content">
                                    <div class="explorer-list" id="historyList">
                                        <div class="explorer-empty">
                                            <small>No queries executed yet</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Main Editor Area -->
                    <div class="editor-main">
                        <!-- SQL Editor Toolbar -->
                        <div class="editor-toolbar">
                            <div class="toolbar-left">
                                <button class="btn btn-sm btn-success" onclick="executeSQL()" id="executeSQLBtn">
                                    <i class="fas fa-play me-1"></i>Execute
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="clearSQL()">
                                    <i class="fas fa-trash me-1"></i>Clear
                                </button>
                                <button class="btn btn-sm btn-outline-info" onclick="formatSQL()">
                                    <i class="fas fa-magic me-1"></i>Format
                                </button>
                                <div class="toolbar-divider"></div>
                                <button class="btn btn-sm btn-outline-secondary" onclick="saveQuery()">
                                    <i class="fas fa-save me-1"></i>Save
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="loadQuery()">
                                    <i class="fas fa-folder-open me-1"></i>Load
                                </button>
                            </div>
                            <div class="toolbar-right">
                                <span class="toolbar-info" id="editorInfo">Line 1, Column 1</span>
                            </div>
                        </div>
                        
                        <!-- SQL Editor -->
                        <div class="sql-editor-wrapper">
                            <div class="editor-lines" id="editorLines"></div>
                            <textarea id="sqlEditor" class="sql-editor" placeholder="Enter your SQL query here..." ondrop="dropIntoEditor(event)" ondragover="allowDrop(event)">SELECT * FROM {{ table_name }} LIMIT 100;</textarea>
                        </div>
                        
                        <!-- Query Results -->
                        <div class="results-panel" id="resultsPanel" style="display: none;">
                            <div class="results-header">
                                <div class="results-title">
                                    <i class="fas fa-table me-2"></i>Query Results
                                    <span class="results-count" id="resultCount">0 rows</span>
                                </div>
                                <div class="results-actions">
                                    <button class="btn btn-sm btn-outline-success" onclick="exportSQLResults()">
                                        <i class="fas fa-download me-1"></i>Export
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="copySQLResults()">
                                        <i class="fas fa-copy me-1"></i>Copy
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="toggleResultsPanel()">
                                        <i class="fas fa-times me-1"></i>Close
                                    </button>
                                </div>
                            </div>
                            <div class="results-content">
                                <div class="results-table-container" id="sqlResultsContainer">
                                    <!-- Results will be populated here -->
                                </div>
                                <div class="results-pagination" id="resultsPagination" style="display: none;">
                                    <!-- Pagination will be populated here -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Error Panel -->
                        <div class="error-panel" id="errorPanel" style="display: none;">
                            <div class="error-header">
                                <i class="fas fa-exclamation-triangle me-2"></i>Query Error
                                <button class="btn btn-sm btn-outline-secondary ms-auto" onclick="hideErrorPanel()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="error-content" id="errorMessage"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Filter Modal -->
<div class="modal fade" id="quickFilterModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-filter me-2"></i>Quick Filter: <span id="quickFilterColumn"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Operation</label>
                    <select class="form-select" id="quickFilterOperation">
                        <option value="contains">Contains</option>
                        <option value="equals">Equals</option>
                        <option value="not_contains">Does not contain</option>
                        <option value="not_equals">Does not equal</option>
                        <option value="starts_with">Starts with</option>
                        <option value="ends_with">Ends with</option>
                        <option value="is_null">Is NULL</option>
                        <option value="is_not_null">Is not NULL</option>
                    </select>
                </div>
                <div class="mb-3" id="quickFilterValueGroup">
                    <label class="form-label">Value</label>
                    <input type="text" class="form-control" id="quickFilterValue" 
                           placeholder="Enter filter value">
                    <div class="form-text">
                        <strong>Suggestions:</strong>
                        <div id="quickFilterSuggestions" class="mt-2"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="applyQuickFilter()">Apply Filter</button>
            </div>
        </div>
    </div>
</div>

<!-- Filter Preset Modal -->
<div class="modal fade" id="filterPresetModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-save me-2"></i>Save Filter Preset
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Preset Name</label>
                    <input type="text" class="form-control" id="presetName" 
                           placeholder="Enter a name for this filter preset">
                </div>
                <div class="mb-3">
                    <label class="form-label">Description (optional)</label>
                    <textarea class="form-control" id="presetDescription" rows="3"
                              placeholder="Describe what this filter does"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="savePreset()">Save Preset</button>
            </div>
        </div>
    </div>
</div>

<!-- Row Details Modal -->
<div class="modal fade detail-modal" id="rowDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-eye me-2"></i>Row Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Navigation Controls -->
                <div class="detail-navigation">
                    <button class="btn btn-outline-secondary detail-nav-btn" id="prevRowBtn" onclick="navigateRow(-1)">
                        <i class="fas fa-chevron-left me-1"></i>Previous
                    </button>
                    <div class="detail-nav-info" id="rowNavInfo">
                        Row 1 of {{ total_rows }}
                    </div>
                    <button class="btn btn-outline-secondary detail-nav-btn" id="nextRowBtn" onclick="navigateRow(1)">
                        Next<i class="fas fa-chevron-right ms-1"></i>
                    </button>
                </div>

                <!-- Row Data Content -->
                <div id="rowDetailsContent">
                    <!-- Content will be dynamically populated -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="exportRowData()" id="exportRowBtn">
                    <i class="fas fa-download me-1"></i>Export Row
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Export Panel Overlay -->
<div id="exportOverlay" class="export-overlay" onclick="closeExportPanel()"></div>

<!-- Export Panel -->
<div id="exportPanel" class="export-panel">
    <div class="export-panel-header">
        <h5 class="mb-0">
            <i class="fas fa-download me-2"></i>Export CSV
        </h5>
        <button type="button" class="btn btn-outline-light btn-sm" onclick="closeExportPanel()">
            <i class="fas fa-times"></i>
        </button>
    </div>
    
    <div class="export-panel-body">
        <!-- Export Options -->
        <div class="mb-4">
            <h6 class="fw-bold mb-3">
                <i class="fas fa-cog me-2"></i>Export Options
            </h6>
            
            <!-- Export Scope Options -->
            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="includeFilters" checked onchange="updateFilterStatus()">
                <label class="form-check-label" for="includeFilters">
                    <strong>Apply Current Filters</strong>
                    <small class="d-block text-muted" id="filterStatusText">Export only the filtered data currently displayed</small>
                </label>
            </div>
            
            <!-- Current Filter Status Display -->
            <div class="alert alert-light border" id="currentFilterStatus">
                <div class="d-flex align-items-center">
                    <i class="fas fa-filter me-2 text-primary"></i>
                    <div>
                        <small class="fw-bold text-primary">Current Filters:</small>
                        <div id="filterStatusDisplay" class="small text-muted">
                            No filters applied - will export all data
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Column Selection -->
        <div class="mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="fw-bold mb-0">
                    <i class="fas fa-columns me-2"></i>Select Columns
                </h6>
                <div>
                    <button type="button" class="btn btn-outline-primary btn-sm me-2" onclick="selectAllColumns()">
                        <i class="fas fa-check-double me-1"></i>Select All
                    </button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="deselectAllColumns()">
                        <i class="fas fa-times me-1"></i>Clear All
                    </button>
                </div>
            </div>
            
            <!-- Column Search Bar -->
            <div class="mb-3">
                <div class="input-group">
                    <span class="input-group-text">
                        <i class="fas fa-search"></i>
                    </span>
                    <input type="text" class="form-control" id="columnSearchInput" 
                           placeholder="Search columns by name..." 
                           oninput="filterExportColumns()" 
                           onkeyup="filterExportColumns()" 
                           onkeydown="handleSearchKeydown(event)"
                           autocomplete="off">
                    <button type="button" class="btn btn-outline-secondary" onclick="clearColumnSearch()" id="clearSearchBtn" style="display: none;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <small class="text-muted mt-1 d-block">
                    <span id="columnSearchStatus">Showing all columns</span>
                </small>
            </div>
            
            <div class="export-columns-container" id="exportColumnsContainer">
                <!-- Column checkboxes will be dynamically populated -->
            </div>
        </div>
        
        <!-- Export Summary -->
        <div class="export-summary mb-4" id="exportSummary">
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                <span id="exportSummaryText">Select columns to export</span>
            </div>
        </div>
    </div>
    
    <div class="export-panel-footer">
        <button type="button" class="btn btn-secondary me-2" onclick="closeExportPanel()">
            <i class="fas fa-times me-1"></i>Cancel
        </button>
        <button type="button" class="btn btn-success" onclick="executeExport()" id="executeExportBtn" disabled>
            <i class="fas fa-download me-1"></i>Export CSV
        </button>
    </div>
</div>

{% endblock %}

{% block styles %}
<style>
/* SQL Workbench Styles */
.sql-workbench {
    display: flex;
    height: 70vh;
    background: #f8f9fa;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

/* Explorer Sidebar */
.explorer-sidebar {
    width: 280px;
    background: #2d3748;
    color: #e2e8f0;
    display: flex;
    flex-direction: column;
    border-right: 1px solid #4a5568;
}

.explorer-header {
    padding: 16px 20px;
    background: #1a202c;
    border-bottom: 1px solid #4a5568;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.explorer-header h6 {
    color: #e2e8f0;
    font-weight: 600;
    margin: 0;
}

.explorer-content {
    flex: 1;
    overflow-y: auto;
}

.explorer-section {
    border-bottom: 1px solid #4a5568;
}

.explorer-section:last-child {
    border-bottom: none;
}

.explorer-section-header {
    padding: 12px 20px;
    background: #2d3748;
    cursor: pointer;
    user-select: none;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: background-color 0.2s ease;
    font-size: 14px;
    font-weight: 500;
}

.explorer-section-header:hover {
    background: #4a5568;
}

.explorer-section-header i.fa-chevron-down {
    transition: transform 0.2s ease;
    font-size: 12px;
}

.explorer-section-header.expanded i.fa-chevron-down {
    transform: rotate(180deg);
}

.explorer-section-content {
    display: none;
    background: #1a202c;
}

.explorer-section-content.show {
    display: block;
    animation: slideDown 0.3s ease;
}

@keyframes slideDown {
    from {
        opacity: 0;
        max-height: 0;
    }
    to {
        opacity: 1;
        max-height: 300px;
    }
}

.explorer-search {
    padding: 12px 20px;
    border-bottom: 1px solid #4a5568;
}

.explorer-search input {
    background: #2d3748;
    border: 1px solid #4a5568;
    color: #e2e8f0;
    border-radius: 4px;
    padding: 6px 10px;
    font-size: 12px;
    width: 100%;
}

.explorer-search input:focus {
    outline: none;
    border-color: #63b3ed;
    box-shadow: 0 0 0 2px rgba(99, 179, 237, 0.2);
}

.explorer-search input::placeholder {
    color: #a0aec0;
}

.explorer-list {
    max-height: 200px;
    overflow-y: auto;
}

.explorer-list::-webkit-scrollbar {
    width: 6px;
}

.explorer-list::-webkit-scrollbar-track {
    background: #1a202c;
}

.explorer-list::-webkit-scrollbar-thumb {
    background: #4a5568;
    border-radius: 3px;
}

.explorer-item {
    padding: 8px 20px;
    cursor: pointer;
    font-size: 13px;
    color: #e2e8f0;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    border-bottom: 1px solid #2d3748;
}

.explorer-item:hover {
    background: #4a5568;
    color: #63b3ed;
}

.explorer-item:last-child {
    border-bottom: none;
}

.explorer-item i {
    width: 16px;
    text-align: center;
    margin-right: 8px;
    font-size: 12px;
}

.explorer-empty {
    padding: 20px;
    text-align: center;
    color: #a0aec0;
    font-size: 12px;
}

/* Main Editor Area */
.editor-main {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: #ffffff;
}

/* Editor Toolbar */
.editor-toolbar {
    background: #f7fafc;
    border-bottom: 1px solid #e2e8f0;
    padding: 8px 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.toolbar-left {
    display: flex;
    align-items: center;
    gap: 8px;
}

.toolbar-right {
    display: flex;
    align-items: center;
}

.toolbar-divider {
    width: 1px;
    height: 20px;
    background: #e2e8f0;
    margin: 0 8px;
}

.toolbar-info {
    font-size: 12px;
    color: #718096;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
}

.editor-toolbar .btn {
    border-radius: 4px;
    font-size: 12px;
    font-weight: 500;
    padding: 4px 12px;
    transition: all 0.2s ease;
}

.editor-toolbar .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* SQL Editor Wrapper */
.sql-editor-wrapper {
    flex: 1;
    position: relative;
    display: flex;
    background: #ffffff;
}

.editor-lines {
    background: #f7fafc;
    color: #a0aec0;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 14px;
    line-height: 1.5;
    padding: 16px 8px;
    border-right: 1px solid #e2e8f0;
    user-select: none;
    min-width: 50px;
    text-align: right;
}

.sql-editor {
    flex: 1;
    border: none;
    padding: 16px;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 14px;
    line-height: 1.5;
    resize: none;
    outline: none;
    background: transparent;
    color: #2d3748;
    tab-size: 4;
}

.sql-editor:focus {
    background: transparent;
}

/* Results Panel */
.results-panel {
    background: #ffffff;
    border-top: 1px solid #e2e8f0;
    display: flex;
    flex-direction: column;
    max-height: 40vh;
}

.results-header {
    background: #f7fafc;
    border-bottom: 1px solid #e2e8f0;
    padding: 12px 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.results-title {
    display: flex;
    align-items: center;
    font-weight: 600;
    color: #2d3748;
}

.results-count {
    background: #3182ce;
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 11px;
    margin-left: 8px;
}

.results-actions {
    display: flex;
    gap: 8px;
}

.results-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.results-table-container {
    flex: 1;
    overflow: auto;
    background: #ffffff;
}

.results-table-container::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

.results-table-container::-webkit-scrollbar-track {
    background: #f1f5f9;
}

.results-table-container::-webkit-scrollbar-thumb {
    background: #cbd5e0;
    border-radius: 4px;
}

.results-table-container::-webkit-scrollbar-thumb:hover {
    background: #a0aec0;
}

.results-table-container table {
    margin: 0;
    border-collapse: separate;
    border-spacing: 0;
    width: 100%;
}

.results-table-container th {
    background: #f7fafc;
    border-bottom: 2px solid #e2e8f0;
    font-weight: 600;
    font-size: 12px;
    padding: 12px 16px;
    color: #4a5568;
    position: sticky;
    top: 0;
    z-index: 10;
    text-align: left;
}

.results-table-container td {
    font-size: 12px;
    padding: 10px 16px;
    border-bottom: 1px solid #f1f5f9;
    color: #2d3748;
}

.results-table-container tbody tr:hover {
    background: #f7fafc;
}

.results-pagination {
    background: #f7fafc;
    border-top: 1px solid #e2e8f0;
    padding: 12px 16px;
    display: flex;
    justify-content: center;
}

/* Error Panel */
.error-panel {
    background: #fed7d7;
    border: 1px solid #feb2b2;
    border-radius: 4px;
    margin: 8px 16px;
}

.error-header {
    background: #f56565;
    color: white;
    padding: 8px 12px;
    display: flex;
    align-items: center;
    font-weight: 600;
    font-size: 14px;
}

.error-content {
    padding: 12px;
    color: #742a2a;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 12px;
    white-space: pre-wrap;
}

/* Drag and Drop Styles */
.explorer-item[draggable="true"] {
    cursor: grab;
}

.explorer-item[draggable="true"]:active {
    cursor: grabbing;
}

.sql-editor.drag-over {
    background: #ebf8ff;
    border: 2px dashed #3182ce;
}

/* Loading States */
.btn-loading {
    position: relative;
    pointer-events: none;
}

.btn-loading::after {
    content: "";
    position: absolute;
    width: 12px;
    height: 12px;
    margin: auto;
    border: 2px solid transparent;
    border-top-color: #ffffff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Autocomplete Dropdown */
.autocomplete-dropdown {
    background: #ffffff;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
    min-width: 250px;
}

.autocomplete-item {
    padding: 8px 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    border-bottom: 1px solid #f1f5f9;
    transition: background-color 0.2s ease;
}

.autocomplete-item:last-child {
    border-bottom: none;
}

.autocomplete-item:hover,
.autocomplete-item.selected {
    background: #f7fafc;
}

.autocomplete-item i {
    width: 16px;
    text-align: center;
    margin-right: 8px;
    font-size: 12px;
    color: #718096;
}

.autocomplete-label {
    flex: 1;
    font-size: 13px;
    color: #2d3748;
}

.autocomplete-type {
    font-size: 11px;
    color: #a0aec0;
    background: #f1f5f9;
    padding: 2px 6px;
    border-radius: 3px;
    margin-left: 8px;
}

/* History Item Styles */
.history-item {
    flex: 1;
    min-width: 0;
}

.history-query {
    font-size: 12px;
    color: #e2e8f0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.history-time {
    font-size: 10px;
    color: #a0aec0;
    margin-top: 2px;
}

/* Enhanced Button Styles */
.editor-toolbar .btn {
    position: relative;
    overflow: hidden;
}

.editor-toolbar .btn:before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s;
}

.editor-toolbar .btn:hover:before {
    left: 100%;
}

/* Syntax Highlighting (Basic) */
.sql-editor {
    background: #ffffff;
    color: #2d3748;
}

/* Responsive Design */
@media (max-width: 768px) {
    .sql-workbench {
        flex-direction: column;
        height: auto;
    }
    
    .explorer-sidebar {
        width: 100%;
        max-height: 200px;
    }
    
    .editor-main {
        min-height: 400px;
    }
    
    .results-panel {
        max-height: 300px;
    }
    
    .autocomplete-dropdown {
        min-width: 200px;
    }
}

@media (max-width: 576px) {
    .toolbar-left {
        flex-wrap: wrap;
        gap: 4px;
    }
    
    .toolbar-divider {
        display: none;
    }
    
    .results-actions {
        flex-wrap: wrap;
        gap: 4px;
    }
    
    .explorer-sidebar {
        max-height: 150px;
    }
    
    .editor-lines {
        min-width: 40px;
        font-size: 12px;
    }
    
    .sql-editor {
        font-size: 12px;
    }
}
</style>
{% endblock %}

{% block scripts %}
<script>
// Global variables
let currentFilters = { logic: 'AND', groups: [] };
let groupCounter = 0;
let conditionCounter = 0;
let tableColumns = {{ (columns | tojson) if columns else '[]' }};
let currentPage = {{ page }};

// SQL Editor variables
let sqlResults = [];
let allTables = [];
let currentLimit = {{ per_page }};
let currentTableName = {{ table_name | tojson }};
let currentRowData = {{ (rows | tojson) if rows else '[]' }};
let currentColumns = {{ (columns | tojson) if columns else '[]' }};
let currentTotalRows = {{ total_rows if total_rows is defined else 0 }};
let currentRowIndex = 0;
let currentView = 'table'; // 'table' or 'list'
let serverViewConfig = {{ view_config|tojson if view_config else 'null' }};
let showTotalCount = true; // Toggle state for total count display

// Filter operations configuration
const filterOperations = {
    'text': [
        { value: 'contains', label: 'Contains' },
        { value: 'not_contains', label: 'Does not contain' },
        { value: 'equals', label: 'Equals' },
        { value: 'not_equals', label: 'Does not equal' },
        { value: 'starts_with', label: 'Starts with' },
        { value: 'ends_with', label: 'Ends with' },
        { value: 'is_null', label: 'Is NULL' },
        { value: 'is_not_null', label: 'Is not NULL' },
        { value: 'in', label: 'In (comma separated)' },
        { value: 'not_in', label: 'Not in (comma separated)' }
    ],
    'number': [
        { value: 'equals', label: 'Equals' },
        { value: 'not_equals', label: 'Does not equal' },
        { value: 'greater_than', label: 'Greater than' },
        { value: 'less_than', label: 'Less than' },
        { value: 'greater_equal', label: 'Greater than or equal' },
        { value: 'less_equal', label: 'Less than or equal' },
        { value: 'between', label: 'Between' },
        { value: 'is_null', label: 'Is NULL' },
        { value: 'is_not_null', label: 'Is not NULL' }
    ],
    'date': [
        { value: 'equals', label: 'Equals' },
        { value: 'not_equals', label: 'Does not equal' },
        { value: 'greater_than', label: 'After' },
        { value: 'less_than', label: 'Before' },
        { value: 'greater_equal', label: 'On or after' },
        { value: 'less_equal', label: 'On or before' },
        { value: 'between', label: 'Between' },
        { value: 'is_null', label: 'Is NULL' },
        { value: 'is_not_null', label: 'Is not NULL' }
    ]
};

// Note: Initialization moved to enhanced initialization below

// Filter Panel Toggle
function toggleFilterPanel(forceShow = false) {
    const filterBody = document.querySelector('.filter-body');
    const toggleIcon = document.getElementById('filterToggleIcon');
    const toggleText = document.getElementById('filterToggleText');
    
    if (forceShow || filterBody.style.display === 'none') {
        filterBody.style.display = 'block';
        toggleIcon.className = 'fas fa-chevron-up';
        toggleText.textContent = 'Hide Filters';
    } else {
        filterBody.style.display = 'none';
        toggleIcon.className = 'fas fa-chevron-down';
        toggleText.textContent = 'Show Filters';
    }
}

// Add Filter Group
function addFilterGroup() {
    const groupId = `group_${++groupCounter}`;
    const groupsContainer = document.getElementById('filterGroups');
    
    const groupHtml = `
        <div class="filter-group card mb-3" id="${groupId}">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">Filter Group ${groupCounter}</h6>
                <div class="d-flex gap-2 align-items-center">
                    <select class="form-select form-select-sm group-logic" data-group="${groupId}" onchange="updateFilters()">
                        <option value="AND">AND</option>
                        <option value="OR">OR</option>
                    </select>
                    <button type="button" class="btn btn-success btn-sm" onclick="addCondition('${groupId}')">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeFilterGroup('${groupId}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="conditions-container" id="${groupId}_conditions">
                    <!-- Conditions will be added here -->
                </div>
            </div>
        </div>
    `;
    
    groupsContainer.insertAdjacentHTML('beforeend', groupHtml);
    
    // Add first condition automatically
    addCondition(groupId);
    
    updateFilters();
}

// Remove Filter Group
function removeFilterGroup(groupId) {
    const group = document.getElementById(groupId);
    if (group) {
        group.remove();
        updateFilters();
    }
}

// Add Condition to Group
function addCondition(groupId) {
    const conditionId = `condition_${++conditionCounter}`;
    const conditionsContainer = document.getElementById(`${groupId}_conditions`);
    
    const conditionHtml = `
        <div class="condition row mb-2 align-items-end" id="${conditionId}">
            <div class="col-md-3">
                <label class="form-label">Field</label>
                <select class="form-select condition-field" data-condition="${conditionId}" onchange="updateOperations('${conditionId}')">
                    <option value="">Select field...</option>
                    ${tableColumns.map(col => `<option value="${col}">${col}</option>`).join('')}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Operation</label>
                <select class="form-select condition-operation" data-condition="${conditionId}" onchange="updateValueInput('${conditionId}')">
                    <option value="">Select operation...</option>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">Value</label>
                <div class="value-input-container" id="${conditionId}_value_container">
                    <input type="text" class="form-control condition-value" data-condition="${conditionId}" 
                           placeholder="Enter value" onchange="updateFilters()">
                </div>
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-danger btn-sm" onclick="removeCondition('${conditionId}')">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `;
    
    conditionsContainer.insertAdjacentHTML('beforeend', conditionHtml);
}

// Remove Condition
function removeCondition(conditionId) {
    const condition = document.getElementById(conditionId);
    if (condition) {
        condition.remove();
        updateFilters();
    }
}

// Update Operations based on field type
function updateOperations(conditionId) {
    const fieldSelect = document.querySelector(`[data-condition="${conditionId}"].condition-field`);
    const operationSelect = document.querySelector(`[data-condition="${conditionId}"].condition-operation`);
    
    const fieldName = fieldSelect.value;
    const fieldType = getFieldType(fieldName);
    
    operationSelect.innerHTML = '<option value="">Select operation...</option>';
    
    const operations = filterOperations[fieldType] || filterOperations.text;
    operations.forEach(op => {
        operationSelect.innerHTML += `<option value="${op.value}">${op.label}</option>`;
    });
    
    updateValueInput(conditionId);
    updateFilters();
}

// Update Value Input based on operation
function updateValueInput(conditionId) {
    const operationSelect = document.querySelector(`[data-condition="${conditionId}"].condition-operation`);
    const valueContainer = document.getElementById(`${conditionId}_value_container`);
    
    const operation = operationSelect.value;
    
    if (operation === 'is_null' || operation === 'is_not_null') {
        valueContainer.innerHTML = '<span class="form-control-plaintext text-muted">No value required</span>';
    } else if (operation === 'between') {
        valueContainer.innerHTML = `
            <div class="row">
                <div class="col-6">
                    <input type="text" class="form-control condition-value-min" data-condition="${conditionId}" 
                           placeholder="Min value" onchange="updateFilters()">
                </div>
                <div class="col-6">
                    <input type="text" class="form-control condition-value-max" data-condition="${conditionId}" 
                           placeholder="Max value" onchange="updateFilters()">
                </div>
            </div>
        `;
    } else {
        valueContainer.innerHTML = `
            <input type="text" class="form-control condition-value" data-condition="${conditionId}" 
                   placeholder="Enter value" onchange="updateFilters()" 
                   onfocus="loadColumnSuggestions('${conditionId}')">
        `;
    }
    
    updateFilters();
}

// Get field type (simplified)
function getFieldType(fieldName) {
    // You could enhance this by getting actual column types from the backend
    const numericTypes = ['integer', 'bigint', 'decimal', 'numeric', 'real', 'double'];
    const dateTypes = ['date', 'timestamp', 'timestamptz', 'time', 'timetz'];
    
    // For now, assume text type for all fields
    // This could be enhanced with actual type information from the backend
    return 'text';
}

// Load column suggestions for autocomplete
function loadColumnSuggestions(conditionId) {
    const fieldSelect = document.querySelector(`[data-condition="${conditionId}"].condition-field`);
    const fieldName = fieldSelect.value;
    
    if (!fieldName) return;
    
    fetch(`/api/table/${currentTableName}/column/${fieldName}/values?limit=20`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Add suggestions as datalist
                const valueInput = document.querySelector(`[data-condition="${conditionId}"].condition-value`);
                if (valueInput && data.values.length > 0) {
                    const datalistId = `suggestions_${conditionId}`;
                    let datalist = document.getElementById(datalistId);
                    if (!datalist) {
                        datalist = document.createElement('datalist');
                        datalist.id = datalistId;
                        valueInput.parentNode.appendChild(datalist);
                        valueInput.setAttribute('list', datalistId);
                    }
                    
                    datalist.innerHTML = data.values.map(value => 
                        `<option value="${value}">`
                    ).join('');
                }
            }
        })
        .catch(error => console.error('Error loading suggestions:', error));
}

// Update Filters Object
function updateFilters() {
    const mainLogic = document.getElementById('mainLogic').value;
    const groups = [];
    
    document.querySelectorAll('.filter-group').forEach(groupEl => {
        const groupId = groupEl.id;
        const groupLogic = document.querySelector(`[data-group="${groupId}"].group-logic`).value;
        const conditions = [];
        
        groupEl.querySelectorAll('.condition').forEach(conditionEl => {
            const conditionId = conditionEl.id;
            const field = document.querySelector(`[data-condition="${conditionId}"].condition-field`).value;
            const operation = document.querySelector(`[data-condition="${conditionId}"].condition-operation`).value;
            
            if (!field || !operation) return;
            
            let value = null;
            if (operation === 'between') {
                const minInput = document.querySelector(`[data-condition="${conditionId}"].condition-value-min`);
                const maxInput = document.querySelector(`[data-condition="${conditionId}"].condition-value-max`);
                if (minInput && maxInput && minInput.value && maxInput.value) {
                    value = { min: minInput.value, max: maxInput.value };
                }
            } else if (operation !== 'is_null' && operation !== 'is_not_null') {
                const valueInput = document.querySelector(`[data-condition="${conditionId}"].condition-value`);
                if (valueInput) {
                    value = valueInput.value;
                }
            }
            
            if (value !== null || operation === 'is_null' || operation === 'is_not_null') {
                conditions.push({ field, operation, value });
            }
        });
        
        if (conditions.length > 0) {
            groups.push({ logic: groupLogic, conditions });
        }
    });
    
    currentFilters = { logic: mainLogic, groups };
    updateFilterCountBadge();
}

// Update Filter Count Badge
function updateFilterCountBadge() {
    const badge = document.getElementById('filterCountBadge');
    const clearBtn = document.getElementById('clearFiltersBtn');
    
    let conditionCount = 0;
    currentFilters.groups.forEach(group => {
        conditionCount += group.conditions.length;
    });
    
    if (conditionCount > 0) {
        badge.textContent = conditionCount;
        badge.classList.remove('d-none');
        clearBtn.disabled = false;
    } else {
        badge.classList.add('d-none');
        clearBtn.disabled = true;
    }
}

// Apply Filters
function applyFilters() {
    if (currentFilters.groups.length === 0) {
        showToast('No filters defined', 'warning');
        return;
    }
    
    showLoading(true);
    
    const params = new URLSearchParams({
        page: 1, // Reset to first page when applying filters
        per_page: currentLimit,
        filters: JSON.stringify(currentFilters)
    });
    
    fetch(`/api/table/${currentTableName}/data?${params}`)
        .then(response => {
            console.log('Filter API Response status:', response.status);
            
            // Check for authentication errors
            if (response.status === 401) {
                console.error('Authentication required');
                showToast('Session expired. Please log in again.', 'error');
                setTimeout(() => {
                    window.location.href = '/login';
                }, 2000);
                return;
            }
            
            // Check if response is JSON
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                console.error('Filter response is not JSON, content-type:', contentType);
                return response.text().then(text => {
                    console.error('Filter response text:', text.substring(0, 200));
                    throw new Error(`Expected JSON but got ${contentType}. Response: ${text.substring(0, 100)}...`);
                });
            }
            
            return response.json();
        })
        .then(data => {
            console.log('Filter API Response data:', data);
            if (data.success) {
                updateDataTable(data);
                currentPage = 1;
                updateURL();
                showToast(`Filters applied successfully. Found ${data.total_rows} matching rows.`, 'success');
            } else {
                showToast(`Error applying filters: ${data.error}`, 'error');
            }
        })
        .catch(error => {
            console.error('Error applying filters:', error);
            showToast(`Error applying filters: ${error.message}`, 'error');
        })
        .finally(() => {
            showLoading(false);
        });
}

// Clear All Filters
function clearAllFilters() {
    currentFilters = { logic: 'AND', groups: [] };
    document.getElementById('filterGroups').innerHTML = '';
    document.getElementById('mainLogic').value = 'AND';
    updateFilterCountBadge();
    
    // Reload data without filters
    reloadData();
}

// Reset Filters (clear UI but don't apply)
function resetFilters() {
    clearAllFilters();
}

// Quick Filter
function quickFilter(columnName) {
    document.getElementById('quickFilterColumn').textContent = columnName;
    document.getElementById('quickFilterValue').value = '';
    document.getElementById('quickFilterSuggestions').innerHTML = '';
    
    // Load suggestions for this column
    fetch(`/api/table/${currentTableName}/column/${columnName}/values?limit=10`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.values.length > 0) {
                const suggestionsContainer = document.getElementById('quickFilterSuggestions');
                suggestionsContainer.innerHTML = data.values.map(value => 
                    `<span class="badge bg-light text-dark me-1 mb-1 suggestion-badge" 
                           onclick="document.getElementById('quickFilterValue').value='${value}'"
                           style="cursor: pointer;">${value}</span>`
                ).join('');
            }
        });
    
    const modal = new bootstrap.Modal(document.getElementById('quickFilterModal'));
    modal.show();
}

// Apply Quick Filter
function applyQuickFilter() {
    const column = document.getElementById('quickFilterColumn').textContent;
    const operation = document.getElementById('quickFilterOperation').value;
    const value = document.getElementById('quickFilterValue').value;
    
    if (!operation || (!value && operation !== 'is_null' && operation !== 'is_not_null')) {
        showToast('Please fill in all required fields', 'warning');
        return;
    }
    
    // Add as a new filter group
    currentFilters.groups.push({
        logic: 'AND',
        conditions: [{ field: column, operation, value }]
    });
    
    // Close modal and apply filters
    bootstrap.Modal.getInstance(document.getElementById('quickFilterModal')).hide();
    
    // Rebuild UI and apply
    rebuildFilterUI();
    applyFilters();
}

// Rebuild Filter UI from current filters
function rebuildFilterUI() {
    const groupsContainer = document.getElementById('filterGroups');
    groupsContainer.innerHTML = '';
    
    document.getElementById('mainLogic').value = currentFilters.logic;
    
    currentFilters.groups.forEach((group, groupIndex) => {
        addFilterGroup();
        const groupId = `group_${groupCounter}`;
        
        // Set group logic
        document.querySelector(`[data-group="${groupId}"].group-logic`).value = group.logic;
        
        // Remove the auto-added condition
        const autoCondition = document.querySelector(`#${groupId}_conditions .condition`);
        if (autoCondition) autoCondition.remove();
        
        // Add conditions
        group.conditions.forEach(condition => {
            addCondition(groupId);
            const conditionId = `condition_${conditionCounter}`;
            
            // Set field
            document.querySelector(`[data-condition="${conditionId}"].condition-field`).value = condition.field;
            updateOperations(conditionId);
            
            // Set operation
            document.querySelector(`[data-condition="${conditionId}"].condition-operation`).value = condition.operation;
            updateValueInput(conditionId);
            
            // Set value
            if (condition.operation === 'between' && typeof condition.value === 'object') {
                const minInput = document.querySelector(`[data-condition="${conditionId}"].condition-value-min`);
                const maxInput = document.querySelector(`[data-condition="${conditionId}"].condition-value-max`);
                if (minInput && maxInput) {
                    minInput.value = condition.value.min;
                    maxInput.value = condition.value.max;
                }
            } else if (condition.operation !== 'is_null' && condition.operation !== 'is_not_null') {
                const valueInput = document.querySelector(`[data-condition="${conditionId}"].condition-value`);
                if (valueInput) {
                    valueInput.value = condition.value;
                }
            }
        });
    });
}

// Pagination and Data Management
function changePage(page) {
    if (page < 1) return;
    currentPage = page;
    reloadData();
}

function changePageSize(limit) {
    currentLimit = limit;
    currentPage = 1; // Reset to first page
    reloadData();
}

function reloadData() {
    showLoading(true);
    
    const params = new URLSearchParams({
        page: currentPage,
        per_page: currentLimit
    });
    
    if (currentFilters.groups.length > 0) {
        params.append('filters', JSON.stringify(currentFilters));
    }
    
    fetch(`/api/table/${currentTableName}/data?${params}`)
        .then(response => {
            console.log('API Response status:', response.status);
            console.log('API Response headers:', response.headers);
            
            // Check for authentication errors
            if (response.status === 401) {
                console.error('Authentication required');
                showToast('Session expired. Please log in again.', 'error');
                setTimeout(() => {
                    window.location.href = '/login';
                }, 2000);
                return;
            }
            
            // Check if response is JSON
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                console.error('Response is not JSON, content-type:', contentType);
                return response.text().then(text => {
                    console.error('Response text:', text.substring(0, 200));
                    throw new Error(`Expected JSON but got ${contentType}. Response: ${text.substring(0, 100)}...`);
                });
            }
            
            return response.json();
        })
        .then(data => {
            console.log('API Response data:', data);
            if (data.success) {
                updateDataTable(data);
                updateURL();
            } else {
                showToast(`Error loading data: ${data.error}`, 'error');
            }
        })
        .catch(error => {
            console.error('Error loading data:', error);
            showToast(`Error loading data: ${error.message}`, 'error');
        })
        .finally(() => {
            showLoading(false);
        });
}

function refreshData() {
    reloadData();
    showToast('Data refreshed', 'success');
}

// Update Data Table
function updateDataTable(data) {
    // Update current row data
    if (data.rows) {
        currentRowData = data.rows;
    }
    
    // Update row count display
    updateRowCountDisplay();
    
    // This would require a full page reload to update the template
    // For now, redirect with the new parameters
    const params = new URLSearchParams({
        page: currentPage,
        per_page: currentLimit
    });
    
    if (currentFilters.groups.length > 0) {
        params.append('filters', JSON.stringify(currentFilters));
    }
    
    window.location.href = `/table/${currentTableName}?${params}`;
}

// Export Panel Functions
function openExportPanel() {
    console.log('openExportPanel called');
    console.log('Current filters state:', currentFilters);
    
    const overlay = document.getElementById('exportOverlay');
    const panel = document.getElementById('exportPanel');
    
    console.log('Elements found:', { overlay: !!overlay, panel: !!panel });
    
    if (!overlay || !panel) {
        console.error('Export panel elements not found');
        showToast('Export panel not available', 'error');
        return;
    }
    
    // Always load filters from URL to ensure we have the current state
    const urlParams = new URLSearchParams(window.location.search);
    const filtersParam = urlParams.get('filters');
    if (filtersParam) {
        try {
            currentFilters = JSON.parse(filtersParam);
            console.log('Loaded filters from URL in export panel:', currentFilters);
        } catch (e) {
            console.error('Error parsing filters from URL in export panel:', e);
        }
    } else {
        console.log('No filters in URL, using current state:', currentFilters);
    }
    
    // Populate columns
    populateExportColumns();
    
    // Reset search
    const searchInput = document.getElementById('columnSearchInput');
    if (searchInput) {
        searchInput.value = '';
        filterExportColumns();
    }
    
    // Update filter status display (after loading filters)
    updateFilterStatus();
    
    // Force update of export summary to reflect current filter state
    updateExportSummary();
    
    // Show panel
    overlay.classList.add('active');
    panel.classList.add('active');
    
    // Prevent body scroll
    document.body.style.overflow = 'hidden';
    
    console.log('Export panel opened');
}

function closeExportPanel() {
    const overlay = document.getElementById('exportOverlay');
    const panel = document.getElementById('exportPanel');
    
    // Hide panel
    overlay.classList.remove('active');
    panel.classList.remove('active');
    
    // Restore body scroll
    document.body.style.overflow = '';
}

function populateExportColumns() {
    console.log('populateExportColumns called');
    const container = document.getElementById('exportColumnsContainer');
    
    if (!container) {
        console.error('Export columns container not found');
        return;
    }
    
    console.log('currentColumns:', currentColumns);
    
    if (!currentColumns || currentColumns.length === 0) {
        console.error('No columns available for export');
        container.innerHTML = '<div class="alert alert-warning">No columns available for export</div>';
        return;
    }
    
    container.innerHTML = '';
    
    currentColumns.forEach((column, index) => {
        const columnItem = document.createElement('div');
        columnItem.className = 'export-column-item d-flex align-items-center';
        
        columnItem.innerHTML = `
            <div class="form-check flex-grow-1">
                <input class="form-check-input export-column-checkbox" type="checkbox" 
                       id="exportCol_${index}" value="${column}" checked 
                       onchange="updateExportSummary()">
                <label class="form-check-label" for="exportCol_${index}">
                    ${column}
                </label>
            </div>
            <span class="column-type">Column</span>
        `;
        
        container.appendChild(columnItem);
        console.log(`Created checkbox for column ${index}: ${column}`);
    });
    
    console.log('Populated', currentColumns.length, 'columns');
    updateExportSummary();
}


function updateExportSummary() {
    console.log('updateExportSummary called');
    const checkboxes = document.querySelectorAll('.export-column-checkbox:checked');
    const allCheckboxes = document.querySelectorAll('.export-column-checkbox');
    const selectedCount = checkboxes.length;
    const totalCount = currentColumns.length;
    
    console.log('Checkboxes found:', {
        all: allCheckboxes.length,
        checked: selectedCount,
        totalColumns: totalCount
    });
    
    const summaryText = document.getElementById('exportSummaryText');
    const exportBtn = document.getElementById('executeExportBtn');
    
    console.log('Elements found:', {
        summaryText: !!summaryText,
        exportBtn: !!exportBtn
    });
    
    const includeFilters = document.getElementById('includeFilters').checked;
    const hasFilters = currentFilters.groups.length > 0;
    
    let dataScope = '';
    if (includeFilters && hasFilters) {
        dataScope = ' (filtered data only)';
    } else if (!includeFilters && hasFilters) {
        dataScope = ' (all data - filters ignored)';
    } else {
        dataScope = ' (all data)';
    }
    
    if (selectedCount === 0) {
        console.log('No columns selected, disabling export button');
        summaryText.textContent = 'No columns selected. Please select at least one column to export.';
        exportBtn.disabled = true;
    } else if (selectedCount === totalCount) {
        console.log('All columns selected, enabling export button');
        summaryText.textContent = `All ${totalCount} columns selected for export${dataScope}.`;
        exportBtn.disabled = false;
    } else {
        console.log('Some columns selected, enabling export button');
        summaryText.textContent = `${selectedCount} of ${totalCount} columns selected for export${dataScope}.`;
        exportBtn.disabled = false;
    }
}

// Filter export columns based on search input
function filterExportColumns() {
    console.log('filterExportColumns called');
    
    const searchInput = document.getElementById('columnSearchInput');
    const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';
    const columnItems = document.querySelectorAll('.export-column-item');
    const statusSpan = document.getElementById('columnSearchStatus');
    const clearBtn = document.getElementById('clearSearchBtn');
    
    console.log('Search details:', {
        searchTerm: searchTerm,
        columnItemsFound: columnItems.length,
        statusSpan: !!statusSpan,
        clearBtn: !!clearBtn
    });
    
    let visibleCount = 0;
    let totalCount = columnItems.length;
    
    columnItems.forEach((item, index) => {
        const label = item.querySelector('.form-check-label');
        const columnName = label ? label.textContent.toLowerCase().trim() : '';
        
        console.log(`Column ${index}: "${columnName}" - searching for "${searchTerm}"`);
        
        if (searchTerm === '' || columnName.includes(searchTerm)) {
            item.classList.remove('search-hidden');
            item.style.display = '';
            visibleCount++;
            console.log(`Column ${index} visible`);
        } else {
            item.classList.add('search-hidden');
            item.style.display = 'none';
            console.log(`Column ${index} hidden`);
        }
    });
    
    console.log(`Filtering complete: ${visibleCount} of ${totalCount} visible`);
    
    // Update status and clear button visibility
    if (statusSpan) {
        if (searchTerm === '') {
            statusSpan.textContent = `Showing all ${totalCount} columns`;
            if (clearBtn) clearBtn.style.display = 'none';
        } else {
            statusSpan.textContent = `Showing ${visibleCount} of ${totalCount} columns`;
            if (clearBtn) clearBtn.style.display = visibleCount === 0 ? 'none' : 'block';
        }
    }
    
    // Show no results message if no columns match
    const container = document.getElementById('exportColumnsContainer');
    if (container) {
        let noResultsMsg = container.querySelector('.no-results-message');
        
        if (visibleCount === 0 && searchTerm !== '') {
            if (!noResultsMsg) {
                noResultsMsg = document.createElement('div');
                noResultsMsg.className = 'no-results-message alert alert-warning text-center';
                noResultsMsg.innerHTML = `
                    <i class="fas fa-search me-2"></i>
                    No columns found matching "<strong>${searchTerm}</strong>"
                    <br><small class="text-muted">Try a different search term</small>
                `;
                container.appendChild(noResultsMsg);
            }
        } else if (noResultsMsg) {
            noResultsMsg.remove();
        }
    }
}

// Clear column search
function clearColumnSearch() {
    const searchInput = document.getElementById('columnSearchInput');
    searchInput.value = '';
    filterExportColumns();
    searchInput.focus();
}

// Handle keyboard shortcuts in search
function handleSearchKeydown(event) {
    if (event.key === 'Escape') {
        clearColumnSearch();
        event.preventDefault();
    }
}

// Update filter status display
function updateFilterStatus() {
    const filterStatusDisplay = document.getElementById('filterStatusDisplay');
    const filterStatusText = document.getElementById('filterStatusText');
    const includeFiltersCheckbox = document.getElementById('includeFilters');
    
    console.log('updateFilterStatus called - currentFilters:', currentFilters);
    console.log('updateFilterStatus - filter groups:', currentFilters.groups);
    console.log('updateFilterStatus - filter groups length:', currentFilters.groups.length);
    
    if (!filterStatusDisplay || !filterStatusText) {
        console.log('updateFilterStatus - Elements not found:', { filterStatusDisplay: !!filterStatusDisplay, filterStatusText: !!filterStatusText });
        return;
    }
    
    const hasFilters = currentFilters.groups.length > 0;
    const includeFilters = includeFiltersCheckbox ? includeFiltersCheckbox.checked : true;
    console.log('updateFilterStatus - hasFilters:', hasFilters, 'includeFilters:', includeFilters);
    
    if (!hasFilters) {
        filterStatusDisplay.innerHTML = '<span class="text-info"><i class="fas fa-info-circle me-1"></i>No filters applied - will export all data</span>';
        filterStatusText.textContent = 'Export all data (no filters currently active)';
    } else if (!includeFilters) {
        filterStatusDisplay.innerHTML = '<span class="text-warning"><i class="fas fa-exclamation-triangle me-1"></i>Filters disabled - will export ALL data</span>';
        filterStatusText.textContent = 'Export all data (filters will be ignored)';
    } else {
        // Show current filter summary
        let filterSummary = '';
        let conditionCount = 0;
        
        currentFilters.groups.forEach((group, groupIndex) => {
            conditionCount += group.conditions.length;
            if (groupIndex > 0) filterSummary += ` ${currentFilters.logic} `;
            
            const groupConditions = group.conditions.map(condition => {
                return `${condition.field} ${condition.operation} ${condition.value || ''}`;
            }).join(` ${group.logic} `);
            
            if (group.conditions.length > 1) {
                filterSummary += `(${groupConditions})`;
            } else {
                filterSummary += groupConditions;
            }
        });
        
        filterStatusDisplay.innerHTML = `
            <span class="text-success">
                <i class="fas fa-check-circle me-1"></i>
                ${conditionCount} filter(s) active - will export filtered data only
            </span>
            <br>
            <small class="text-muted">${filterSummary}</small>
        `;
        filterStatusText.textContent = 'Export only filtered data (matching current table filters)';
    }
    
    // Also update the export summary to reflect filter status
    updateExportSummary();
}

// Enhanced select all to work with filtered results
function selectAllColumns() {
    const visibleCheckboxes = document.querySelectorAll('.export-column-item:not(.search-hidden) .export-column-checkbox');
    console.log('selectAllColumns: found', visibleCheckboxes.length, 'visible checkboxes');
    visibleCheckboxes.forEach(checkbox => {
        checkbox.checked = true;
    });
    updateExportSummary();
}

// Enhanced deselect all to work with filtered results  
function deselectAllColumns() {
    const visibleCheckboxes = document.querySelectorAll('.export-column-item:not(.search-hidden) .export-column-checkbox');
    console.log('deselectAllColumns: found', visibleCheckboxes.length, 'visible checkboxes');
    visibleCheckboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
    updateExportSummary();
}

function executeExport() {
    console.log('executeExport called');
    console.log('currentTableName:', currentTableName);
    console.log('currentColumns:', currentColumns);
    console.log('currentTotalRows:', currentTotalRows);
    
    const selectedCheckboxes = document.querySelectorAll('.export-column-checkbox:checked');
    const includeFilters = document.getElementById('includeFilters').checked;
    
    console.log('Selected checkboxes count:', selectedCheckboxes.length);
    console.log('Include filters:', includeFilters);
    
    if (selectedCheckboxes.length === 0) {
        showToast('Please select at least one column to export', 'warning');
        return;
    }
    
    const selectedColumns = Array.from(selectedCheckboxes).map(cb => cb.value);
    console.log('Selected columns:', selectedColumns);
    
    const params = new URLSearchParams();
    
    // Add filters if checkbox is checked and filters exist
    console.log('Export: Current filters state:', currentFilters);
    console.log('Export: Filter groups count:', currentFilters.groups.length);
    console.log('Export: Include filters:', includeFilters);
    
    if (includeFilters && currentFilters.groups.length > 0) {
        params.append('filters', JSON.stringify(currentFilters));
        console.log('Export: Adding filters:', currentFilters);
        console.log('Export: Filters JSON string:', JSON.stringify(currentFilters));
    } else {
        console.log('Export: No filters to apply. includeFilters:', includeFilters, 'filterGroups:', currentFilters.groups.length);
    }
    
    // Add selected columns
    if (selectedColumns.length < currentColumns.length) {
        params.append('columns', selectedColumns.join(','));
        console.log('Export: Selected columns:', selectedColumns);
    } else {
        console.log('Export: All columns selected');
    }
    
    // Add streaming parameter for large datasets
    params.append('streaming', 'true');
    params.append('chunk_size', '2000'); // Increased chunk size for better performance
    
    const exportUrl = `/api/table/${currentTableName}/export?${params}`;
    console.log('Export URL:', exportUrl);
    console.log('Export parameters:', Object.fromEntries(params.entries()));
    
    // Test the URL first with credentials
    console.log('Testing export URL...');
    fetch(exportUrl, { 
        method: 'HEAD',
        credentials: 'same-origin'  // Include session cookies
    })
        .then(response => {
            console.log('Export URL test response:', response.status, response.statusText);
            if (response.ok) {
                console.log('Export URL is accessible, proceeding with download');
                performExport(exportUrl, selectedColumns, includeFilters);
            } else if (response.status === 401 || response.status === 403) {
                console.error('Authentication required');
                showToast('Session expired. Please refresh the page and try again.', 'error');
            } else {
                console.error('Export URL returned error:', response.status);
                showToast(`Export failed: ${response.status} ${response.statusText}`, 'error');
            }
        })
        .catch(error => {
            console.error('Export URL test failed:', error);
            showToast(`Export failed: ${error.message}`, 'error');
        });
}

function performExport(exportUrl, selectedColumns, includeFilters) {
    console.log('performExport called with URL:', exportUrl);
    console.log('currentTotalRows:', currentTotalRows);
    
    // Show progress indicator for large exports
    const estimatedRows = typeof currentTotalRows !== 'undefined' ? currentTotalRows : 0;
    const isLargeExport = estimatedRows > 1000000; // 1 million rows
    
    console.log('Export progress check:', {
        currentTotalRows: currentTotalRows,
        estimatedRows: estimatedRows,
        isLargeExport: isLargeExport
    });
    
    if (isLargeExport) {
        showToast(`Starting large export of ${estimatedRows.toLocaleString()} rows... This may take several minutes for very large datasets.`, 'info');
        
        // Show progress modal
        showExportProgress(estimatedRows);
    }
    
    // Use a direct link approach with proper authentication
    console.log('Creating download link...');
    const link = document.createElement('a');
    link.href = exportUrl;
    link.download = `${currentTableName}_export.csv`;
    link.style.display = 'none';
    document.body.appendChild(link);
    
    console.log('Triggering download...');
    link.click();
    
    // Simple direct download
    console.log('Starting direct download...');
    window.location.href = exportUrl;
    
    // Clean up after a short delay
    setTimeout(() => {
        document.body.removeChild(link);
    }, 1000);
    
    // Close panel and show success message
    closeExportPanel();
    
    const hasFilters = currentFilters.groups.length > 0;
    let message = `Export started! ${selectedColumns.length} columns will be exported`;
    
    if (includeFilters && hasFilters) {
        let conditionCount = 0;
        currentFilters.groups.forEach(group => {
            conditionCount += group.conditions.length;
        });
        message += ` with ${conditionCount} filter(s) applied (filtered data only).`;
    } else if (!includeFilters && hasFilters) {
        message += ` (all data - filters ignored).`;
    } else {
        message += ` (all data).`;
    }
    
    if (!isLargeExport) {
        showToast(message, 'success');
    }
}

// Legacy export function for backward compatibility
function exportData() {
    openExportPanel();
}

// Try export with fallback
function tryExport() {
    console.log('tryExport called');
    console.log('currentTableName in tryExport:', currentTableName);
    console.log('currentColumns in tryExport:', currentColumns);
    
    // Check if we have the required data
    if (!currentTableName) {
        console.error('No table name available');
        showToast('No table selected for export', 'error');
        return;
    }
    
    if (!currentColumns || currentColumns.length === 0) {
        console.error('No columns available');
        showToast('No columns available for export', 'error');
        return;
    }
    
    // First, let's try to open the export panel directly
    try {
        openExportPanel();
    } catch (error) {
        console.error('Error opening export panel:', error);
        console.log('Falling back to simple export');
        simpleExport();
    }
}

// Simple direct export function as fallback
function simpleExport() {
    console.log('simpleExport called');
    const params = new URLSearchParams();
    
    if (currentFilters.groups.length > 0) {
        params.append('filters', JSON.stringify(currentFilters));
    }
    
    const exportUrl = `/api/table/${currentTableName}/export?${params}`;
    console.log('Simple export URL:', exportUrl);
    
    // Test the URL first with credentials
    fetch(exportUrl, { 
        method: 'HEAD',
        credentials: 'same-origin'  // Include session cookies
    })
        .then(response => {
            console.log('Simple export URL test response:', response.status, response.statusText);
            if (response.ok) {
                console.log('Simple export URL is accessible, proceeding with download');
                performSimpleExport(exportUrl);
            } else if (response.status === 401 || response.status === 403) {
                console.error('Authentication required');
                showToast('Session expired. Please refresh the page and try again.', 'error');
            } else {
                console.error('Simple export URL returned error:', response.status);
                showToast(`Export failed: ${response.status} ${response.statusText}`, 'error');
            }
        })
        .catch(error => {
            console.error('Simple export URL test failed:', error);
            showToast(`Export failed: ${error.message}`, 'error');
        });
}

function performSimpleExport(exportUrl) {
    console.log('performSimpleExport called with URL:', exportUrl);
    
    // Use a form submission to properly handle authentication
    const form = document.createElement('form');
    form.method = 'GET';
    form.action = exportUrl;
    form.target = '_blank';
    form.style.display = 'none';
    
    // Add any necessary parameters as hidden inputs
    const params = new URLSearchParams(exportUrl.split('?')[1]);
    for (const [key, value] of params) {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = key;
        input.value = value;
        form.appendChild(input);
    }
    
    document.body.appendChild(form);
    console.log('Submitting simple export form...');
    form.submit();
    
    // Clean up after a short delay
    setTimeout(() => {
        document.body.removeChild(form);
    }, 1000);
    
    showToast('Export started', 'success');
}

// Export Progress Management
function showExportProgress(totalRows) {
    const progressModal = document.createElement('div');
    progressModal.id = 'exportProgressModal';
    progressModal.className = 'modal fade show';
    progressModal.style.display = 'block';
    progressModal.innerHTML = `
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-download me-2"></i>Exporting Data
                    </h5>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span>Exporting ${totalRows.toLocaleString()} rows...</span>
                            <span id="exportProgressText">0%</span>
                        </div>
                        <div class="progress mt-2" style="height: 20px;">
                            <div id="exportProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                            </div>
                        </div>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Large exports are processed in chunks for optimal performance. 
                        The download will start automatically when ready.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="hideExportProgress()">
                        <i class="fas fa-times me-1"></i>Close
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(progressModal);
    
    // Simulate progress (since we can't track actual progress easily with streaming)
    let progress = 0;
    const progressInterval = setInterval(() => {
        progress += Math.random() * 10;
        if (progress > 90) progress = 90; // Don't go to 100% until actually complete
        
        const progressBar = document.getElementById('exportProgressBar');
        const progressText = document.getElementById('exportProgressText');
        
        if (progressBar && progressText) {
            progressBar.style.width = `${progress}%`;
            progressBar.setAttribute('aria-valuenow', progress);
            progressText.textContent = `${Math.round(progress)}%`;
        }
    }, 1000);
    
    // Store interval ID for cleanup
    progressModal.dataset.intervalId = progressInterval;
}

function hideExportProgress() {
    const progressModal = document.getElementById('exportProgressModal');
    if (progressModal) {
        const intervalId = progressModal.dataset.intervalId;
        if (intervalId) {
            clearInterval(intervalId);
        }
        progressModal.remove();
    }
}

// URL Management
function updateURL() {
    const params = new URLSearchParams({
        page: currentPage,
        per_page: currentLimit
    });
    
    if (currentFilters.groups.length > 0) {
        params.append('filters', JSON.stringify(currentFilters));
    }
    
    const newURL = `${window.location.pathname}?${params}`;
    window.history.pushState({}, '', newURL);
}

// Filter Presets
function saveFilterPreset() {
    if (currentFilters.groups.length === 0) {
        showToast('No filters to save', 'warning');
        return;
    }
    
    const modal = new bootstrap.Modal(document.getElementById('filterPresetModal'));
    modal.show();
}

function savePreset() {
    const name = document.getElementById('presetName').value.trim();
    const description = document.getElementById('presetDescription').value.trim();
    
    if (!name) {
        showToast('Please enter a preset name', 'warning');
        return;
    }
    
    const preset = {
        name,
        description,
        filters: JSON.parse(JSON.stringify(currentFilters)),
        table: currentTableName,
        created: new Date().toISOString()
    };
    
    // Save to localStorage
    const presets = JSON.parse(localStorage.getItem('filterPresets') || '[]');
    presets.push(preset);
    localStorage.setItem('filterPresets', JSON.stringify(presets));
    
    bootstrap.Modal.getInstance(document.getElementById('filterPresetModal')).hide();
    showToast('Filter preset saved', 'success');
    
    // Clear form
    document.getElementById('presetName').value = '';
    document.getElementById('presetDescription').value = '';
}

function loadFilterPreset() {
    // This would show a modal with saved presets
    showToast('Filter preset loading coming soon', 'info');
}

function loadFilterPresets() {
    // Load presets from localStorage on page load
    const presets = JSON.parse(localStorage.getItem('filterPresets') || '[]');
    console.log('Loaded filter presets:', presets);
}

// Utility Functions
function showLoading(show) {
    const spinner = document.getElementById('loadingSpinner');
    const dataContainer = document.getElementById('dataContainer');
    
    if (show) {
        spinner.classList.remove('d-none');
        dataContainer.style.opacity = '0.5';
    } else {
        spinner.classList.add('d-none');
        dataContainer.style.opacity = '1';
    }
}

function showToast(message, type = 'info') {
    // Create toast container if it doesn't exist
    let toastContainer = document.getElementById('toastContainer');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toastContainer';
        toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
        toastContainer.style.zIndex = '1055';
        document.body.appendChild(toastContainer);
    }
    
    const iconMap = {
        'success': 'fas fa-check-circle',
        'error': 'fas fa-exclamation-circle',
        'info': 'fas fa-info-circle',
        'warning': 'fas fa-exclamation-triangle'
    };
    
    const colorMap = {
        'success': 'success',
        'error': 'danger',
        'info': 'info',
        'warning': 'warning'
    };
    
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${colorMap[type]} border-0 shadow-lg`;
    toast.setAttribute('role', 'alert');
    toast.style.borderRadius = '12px';
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i class="${iconMap[type]} me-2"></i>
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    toastContainer.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast, {
        autohide: true,
        delay: 4000
    });
    bsToast.show();
    
    toast.addEventListener('hidden.bs.toast', () => toast.remove());
}

// Sort Column (placeholder)
function sortColumn(columnName) {
    showToast(`Column sorting for "${columnName}" coming soon`, 'info');
}

// =====================================
// Dual-View System Functions
// =====================================

// Switch to Table View
function switchToTableView() {
    currentView = 'table';
    
    // Update button states
    document.getElementById('tableViewBtn').classList.add('active');
    document.getElementById('listViewBtn').classList.remove('active');
    
    // Show/hide views
    document.getElementById('tableView').classList.remove('d-none');
    document.getElementById('listView').classList.add('d-none');
    
    // Store preference
    localStorage.setItem('preferredView', 'table');
    
    showToast('Switched to table view', 'info');
}

// Switch to List View
function switchToListView() {
    currentView = 'list';
    
    // Update button states
    document.getElementById('listViewBtn').classList.add('active');
    document.getElementById('tableViewBtn').classList.remove('active');
    
    // Show/hide views
    document.getElementById('listView').classList.remove('d-none');
    document.getElementById('tableView').classList.add('d-none');
    
    // Store preference
    localStorage.setItem('preferredView', 'list');
    
    showToast('Switched to list view', 'info');
}

// Show Row Details Modal
function showRowDetails(rowIndex) {
    // Prevent multiple calls
    if (window.modalOpening) {
        return;
    }
    window.modalOpening = true;
    
    if (!Array.isArray(currentRowData) || rowIndex >= currentRowData.length) {
        showToast('Row data not available', 'error');
        window.modalOpening = false;
        return;
    }
    
    currentRowIndex = rowIndex;
    const rowData = currentRowData[rowIndex];
    
    // Update navigation info
    updateRowNavigation();
    
    // Populate modal content
    populateRowDetailsContent(rowData);
    
    // Get or create modal instance
    const modalElement = document.getElementById('rowDetailsModal');
    let modal = bootstrap.Modal.getInstance(modalElement);
    
    if (!modal) {
        modal = new bootstrap.Modal(modalElement, {
            backdrop: true,
            keyboard: true,
            focus: true
        });
    }
    
    // Add event listeners for proper cleanup
    modalElement.addEventListener('hidden.bs.modal', function() {
        window.modalOpening = false;
        // Clean up any remaining event listeners
        modalElement.removeAttribute('style');
    }, { once: true });
    
    modalElement.addEventListener('shown.bs.modal', function() {
        window.modalOpening = false;
    }, { once: true });
    
    // Show modal
    modal.show();
}

// Populate Row Details Content
function populateRowDetailsContent(rowData) {
    const contentDiv = document.getElementById('rowDetailsContent');
    
    if (!rowData || !currentColumns) {
        contentDiv.innerHTML = '<p class="text-muted">No data available</p>';
        return;
    }
    
    let groups = [];
    
    // Use view configuration partitions if available
    if (serverViewConfig && serverViewConfig.detail && serverViewConfig.detail.partitions) {
        groups = serverViewConfig.detail.partitions.map(partition => ({
            title: partition.name,
            fields: partition.fields.map(fieldName => {
                const fieldIndex = currentColumns.indexOf(fieldName);
                return {
                    name: fieldName,
                    value: fieldIndex >= 0 ? rowData[fieldIndex] : null
                };
            }).filter(field => field.value !== null) // Only include fields that exist
        })).filter(group => group.fields.length > 0); // Only include non-empty groups
    }
    
    // Fallback to default grouping if no configuration or empty configuration
    if (groups.length === 0) {
        // Ensure currentColumns is an array
        if (!Array.isArray(currentColumns)) {
            currentColumns = [];
        }
        
        const fieldsPerGroup = Math.ceil(currentColumns.length / 3);
        
        for (let i = 0; i < currentColumns.length; i += fieldsPerGroup) {
            groups.push({
                title: `Fields ${i + 1}-${Math.min(i + fieldsPerGroup, currentColumns.length)}`,
                fields: currentColumns.slice(i, i + fieldsPerGroup).map((column, idx) => ({
                    name: column,
                    value: rowData[i + idx]
                }))
            });
        }
    }
    
    // Generate HTML
    let html = '';
    groups.forEach((group, groupIndex) => {
        html += `
            <div class="detail-field-group">
                <div class="detail-field-group-title">
                    <i class="fas fa-folder-open me-2 text-primary"></i>
                    ${group.title}
                </div>
        `;
        
        group.fields.forEach(field => {
            let valueClass = '';
            let displayValue = field.value;
            
            if (field.value === null) {
                valueClass = 'null-value';
                displayValue = 'NULL';
            } else if (field.value === '') {
                valueClass = 'empty-value';
                displayValue = 'Empty';
            } else if (typeof field.value === 'string' && field.value.length > 100) {
                valueClass = 'long-text';
            }
            
            html += `
                <div class="detail-field">
                    <div class="detail-field-label">${field.name}:</div>
                    <div class="detail-field-value ${valueClass}">${displayValue || ''}</div>
                </div>
            `;
        });
        
        html += '</div>';
    });
    
    contentDiv.innerHTML = html;
}

// Update Row Navigation
function updateRowNavigation() {
    const navInfo = document.getElementById('rowNavInfo');
    const prevBtn = document.getElementById('prevRowBtn');
    const nextBtn = document.getElementById('nextRowBtn');
    
    // Ensure currentRowData is an array
    if (!Array.isArray(currentRowData)) {
        currentRowData = [];
    }
    
    const currentRowNumber = currentRowIndex + 1;
    const totalRows = currentRowData.length;
    
    navInfo.textContent = `Row ${currentRowNumber} of ${totalRows}`;
    
    // Update button states
    prevBtn.disabled = currentRowIndex === 0;
    nextBtn.disabled = currentRowIndex === totalRows - 1;
}

// Navigate between rows in detail view
function navigateRow(direction) {
    // Ensure currentRowData is an array
    if (!Array.isArray(currentRowData)) {
        currentRowData = [];
    }
    
    const newIndex = currentRowIndex + direction;
    
    if (newIndex >= 0 && newIndex < currentRowData.length) {
        currentRowIndex = newIndex;
        populateRowDetailsContent(currentRowData[currentRowIndex]);
        updateRowNavigation();
    }
}

// Export Row Data
function exportRowData() {
    // Ensure currentRowData is an array
    if (!Array.isArray(currentRowData) || currentRowIndex >= currentRowData.length) {
        showToast('No row data to export', 'error');
        return;
    }
    
    const rowData = currentRowData[currentRowIndex];
    const csvContent = generateRowCSV(rowData);
    
    // Create blob and download
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `${currentTableName}_row_${currentRowIndex + 1}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showToast('Row data exported successfully', 'success');
}

// Generate CSV for single row
function generateRowCSV(rowData) {
    let csv = 'Column,Value\\n';
    
    currentColumns.forEach((column, index) => {
        const value = rowData[index];
        const escapedValue = value === null ? 'NULL' : 
                           value === '' ? 'Empty' : 
                           String(value).replace(/"/g, '""');
        csv += `"${column}","${escapedValue}"\\n`;
    });
    
    return csv;
}

// Initialize view preference
function initializeViewPreference() {
    const savedView = localStorage.getItem('preferredView');
    
    if (savedView === 'list') {
        // Delay to ensure DOM is ready
        setTimeout(() => {
            switchToListView();
        }, 100);
    }
}

// Update Row Count Display
function updateRowCountDisplay() {
    const rowCountDisplay = document.getElementById('rowCountDisplay');
    if (!rowCountDisplay) return;
    
    const currentRows = currentRowData ? currentRowData.length : 0;
    const totalRows = {{ total_rows }};
    
    // Load setting from localStorage
    const savedState = localStorage.getItem('showTotalCount');
    const showTotalCount = savedState !== null ? savedState === 'true' : true;
    
    if (showTotalCount) {
        rowCountDisplay.textContent = `(${currentRows} of ${totalRows} rows)`;
    } else {
        rowCountDisplay.textContent = `(${currentRows} rows)`;
    }
}

// Enhanced initialization
document.addEventListener('DOMContentLoaded', function() {
    // Load any existing filters from URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const filtersParam = urlParams.get('filters');
    console.log('Loading filters from URL:', filtersParam);
    if (filtersParam) {
        try {
            currentFilters = JSON.parse(filtersParam);
            console.log('Parsed currentFilters:', currentFilters);
            updateFilterCountBadge();
            if (currentFilters.groups.length > 0) {
                toggleFilterPanel(true);
                rebuildFilterUI();
            }
        } catch (e) {
            console.error('Error parsing filters from URL:', e);
        }
    } else {
        console.log('No filters found in URL parameters');
    }
    
    // Load filter presets from localStorage
    loadFilterPresets();
    
    // Initialize view preference
    initializeViewPreference();
    
    // Initialize row count display
    updateRowCountDisplay();
    
    // Listen for setting changes from settings page
    window.addEventListener('rowCountSettingChanged', function(event) {
        console.log('Row count setting changed:', event.detail);
        updateRowCountDisplay();
    });
    
    // Add keyboard shortcuts for detail modal
    document.addEventListener('keydown', function(e) {
        const modal = document.getElementById('rowDetailsModal');
        if (modal.classList.contains('show')) {
            if (e.key === 'ArrowLeft') {
                e.preventDefault();
                navigateRow(-1);
            } else if (e.key === 'ArrowRight') {
                e.preventDefault();
                navigateRow(1);
            } else if (e.key === 'Escape') {
                bootstrap.Modal.getInstance(modal).hide();
            }
        }
    });
    
    // Add keyboard support for export panel
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const panel = document.getElementById('exportPanel');
            if (panel && panel.classList.contains('active')) {
                closeExportPanel();
            }
        }
    });
    
    // Test if export panel elements are available
    setTimeout(() => {
        const overlay = document.getElementById('exportOverlay');
        const panel = document.getElementById('exportPanel');
        console.log('Export panel elements check:', {
            overlay: !!overlay,
            panel: !!panel,
            overlayId: overlay ? overlay.id : 'not found',
            panelId: panel ? panel.id : 'not found'
        });
    }, 1000);
});

// ==================== SQL EDITOR FUNCTIONS ====================

// Toggle explorer sections
function toggleExplorerSection(section) {
    console.log('toggleExplorerSection called with:', section);
    const content = document.getElementById(section + '-content');
    const chevron = document.getElementById(section + '-chevron');
    
    console.log('Content element:', content);
    console.log('Chevron element:', chevron);
    
    if (content && chevron) {
        if (content.classList.contains('show')) {
            content.classList.remove('show');
            chevron.classList.remove('fa-chevron-up');
            chevron.classList.add('fa-chevron-down');
            console.log('Hiding section:', section);
        } else {
            content.classList.add('show');
            chevron.classList.remove('fa-chevron-down');
            chevron.classList.add('fa-chevron-up');
            console.log('Showing section:', section);
        }
    } else {
        console.error('Could not find elements for section:', section);
    }
}

// Insert field name into SQL editor
function insertField(fieldName) {
    const editor = document.getElementById('sqlEditor');
    const cursorPos = editor.selectionStart;
    const textBefore = editor.value.substring(0, cursorPos);
    const textAfter = editor.value.substring(editor.selectionEnd);
    
    editor.value = textBefore + fieldName + textAfter;
    editor.focus();
    editor.setSelectionRange(cursorPos + fieldName.length, cursorPos + fieldName.length);
}

// Select table and load its fields
function selectTable(tableName) {
    // Update the SQL editor with a basic SELECT query
    const editor = document.getElementById('sqlEditor');
    editor.value = `SELECT * FROM ${tableName} LIMIT 100;`;
    
    // Load fields for the selected table
    loadTableFields(tableName);
}

// Load fields for a specific table
async function loadTableFields(tableName) {
    try {
        const response = await fetch(`/api/visualizations/custom/columns/${tableName}`);
        const result = await response.json();
        
        if (result.success && result.columns) {
            const fieldsList = document.getElementById('fieldsList');
            fieldsList.innerHTML = '';
            
            result.columns.forEach(column => {
                const fieldItem = document.createElement('div');
                fieldItem.className = 'explorer-item';
                fieldItem.onclick = () => insertField(column.name);
                fieldItem.innerHTML = `<i class="fas fa-columns me-2"></i>${column.name}`;
                fieldsList.appendChild(fieldItem);
            });
        }
    } catch (error) {
        console.error('Error loading table fields:', error);
    }
}

// Insert SQL template
function insertTemplate(templateType) {
    const editor = document.getElementById('sqlEditor');
    const currentTable = currentTableName;
    
    let template = '';
    switch (templateType) {
        case 'select':
            template = `SELECT * FROM ${currentTable} LIMIT 100;`;
            break;
        case 'count':
            template = `SELECT COUNT(*) as total_count FROM ${currentTable};`;
            break;
        case 'join':
            template = `SELECT t1.*, t2.* 
FROM ${currentTable} t1
LEFT JOIN table2 t2 ON t1.id = t2.${currentTable}_id
LIMIT 100;`;
            break;
        case 'group':
            template = `SELECT column_name, COUNT(*) as count
FROM ${currentTable}
GROUP BY column_name
ORDER BY count DESC;`;
            break;
    }
    
    editor.value = template;
    editor.focus();
}

// Execute SQL query
async function executeSQL() {
    const editor = document.getElementById('sqlEditor');
    const query = editor.value.trim();
    
    if (!query) {
        showSQLError('Please enter a SQL query');
        return;
    }
    
    const executeBtn = document.getElementById('executeSQLBtn');
    executeBtn.disabled = true;
    executeBtn.classList.add('btn-loading');
    executeBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Executing...';
    
    // Hide previous results and errors
    hideSQLError();
    const resultsPanel = document.getElementById('resultsPanel');
    resultsPanel.style.display = 'none';
    
    try {
        // Create AbortController for timeout
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 35000); // 35 second timeout
        
        const response = await fetch('/api/sql/execute', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ query: query }),
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        const result = await response.json();
        
        if (result.success) {
            displaySQLResults(result.data, result.columns, result);
            hideSQLError();
        } else {
            showSQLError(result.error || 'Query execution failed');
        }
    } catch (error) {
        if (error.name === 'AbortError') {
            showSQLError('Query timed out after 35 seconds. Try optimizing your query or adding a LIMIT clause.');
        } else {
            showSQLError('Error executing query: ' + error.message);
        }
    } finally {
        executeBtn.disabled = false;
        executeBtn.classList.remove('btn-loading');
        executeBtn.innerHTML = '<i class="fas fa-play me-1"></i>Execute';
    }
}

// Display SQL results
function displaySQLResults(data, columns, result = null) {
    const resultsCard = document.getElementById('sqlResultsCard');
    const resultsContainer = document.getElementById('sqlResultsContainer');
    const resultCount = document.getElementById('resultCount');
    
    sqlResults = data;
    
    if (!data || data.length === 0) {
        resultsContainer.innerHTML = `
            <div class="text-center p-5 text-muted">
                <i class="fas fa-search fa-3x mb-3" style="opacity: 0.3;"></i>
                <h6>No results found</h6>
                <small>Try adjusting your query or check the table data</small>
            </div>
        `;
        resultCount.textContent = '0 rows';
        resultCount.className = 'badge bg-secondary ms-2';
    } else {
        let html = '<table class="table table-striped table-hover mb-0">';
        
        // Header
        html += '<thead><tr>';
        columns.forEach(col => {
            html += `<th scope="col">${col}</th>`;
        });
        html += '</tr></thead>';
        
        // Body
        html += '<tbody>';
        data.forEach((row, index) => {
            html += '<tr>';
            columns.forEach(col => {
                const value = row[col];
                if (value === null || value === undefined) {
                    html += '<td class="text-muted font-italic"><i class="fas fa-minus me-1"></i>NULL</td>';
                } else if (value === '') {
                    html += '<td class="text-muted font-italic"><i class="fas fa-minus me-1"></i>Empty</td>';
                } else {
                    html += `<td>${String(value)}</td>`;
                }
            });
            html += '</tr>';
        });
        html += '</tbody></table>';
        
        resultsContainer.innerHTML = html;
        resultCount.textContent = `${data.length} row${data.length !== 1 ? 's' : ''}`;
        resultCount.className = 'badge bg-success ms-2';
        
        // Show optimization information if available
        if (result && (result.optimized || result.suggestions)) {
            showOptimizationInfo(result);
        }
    }
    
    // Show results with animation
    resultsCard.style.display = 'block';
    resultsCard.style.opacity = '0';
    resultsCard.style.transform = 'translateY(20px)';
    
    setTimeout(() => {
        resultsCard.style.transition = 'all 0.3s ease';
        resultsCard.style.opacity = '1';
        resultsCard.style.transform = 'translateY(0)';
    }, 50);
}

// Show optimization information
function showOptimizationInfo(result) {
    // Create or update optimization info panel
    let infoPanel = document.getElementById('optimizationInfo');
    if (!infoPanel) {
        infoPanel = document.createElement('div');
        infoPanel.id = 'optimizationInfo';
        infoPanel.className = 'alert alert-info mt-3';
        document.getElementById('sqlResultsCard').appendChild(infoPanel);
    }
    
    let infoHtml = '<h6><i class="fas fa-lightbulb me-2"></i>Query Optimization Info</h6>';
    
    if (result.optimized) {
        infoHtml += '<div class="mb-2"><strong>Query was optimized:</strong></div>';
        infoHtml += `<div class="mb-2"><small class="text-muted">Original: <code>${result.original_query}</code></small></div>`;
        infoHtml += `<div class="mb-2"><small class="text-success">Optimized: <code>${result.optimized_query}</code></small></div>`;
    }
    
    if (result.suggestions && result.suggestions.length > 0) {
        infoHtml += '<div class="mt-3"><strong>Performance Suggestions:</strong></div>';
        result.suggestions.forEach((suggestion, index) => {
            infoHtml += `<div class="mt-2">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <small class="text-muted">${suggestion.reason}</small>
                        <br>
                        <code class="small">${suggestion.suggestion}</code>
                    </div>
                    <button class="btn btn-sm btn-outline-primary" onclick="copyToClipboard('${suggestion.suggestion.replace(/'/g, "\\'")}')">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
            </div>`;
        });
    }
    
    infoPanel.innerHTML = infoHtml;
}

// Copy text to clipboard
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        showToast('Copied to clipboard!', 'success');
    }).catch(() => {
        showToast('Failed to copy to clipboard', 'error');
    });
}

// Show SQL error
function showSQLError(message) {
    const errorAlert = document.getElementById('sqlErrorAlert');
    const errorMessage = document.getElementById('sqlErrorMessage');
    
    errorMessage.textContent = message;
    errorAlert.style.display = 'block';
}

// Hide SQL error
function hideSQLError() {
    const errorAlert = document.getElementById('sqlErrorAlert');
    errorAlert.style.display = 'none';
}

// Clear SQL editor
function clearSQL() {
    const editor = document.getElementById('sqlEditor');
    editor.value = '';
    editor.focus();
    
    // Hide results and errors
    document.getElementById('sqlResultsCard').style.display = 'none';
    hideSQLError();
}

// Format SQL (basic formatting)
function formatSQL() {
    const editor = document.getElementById('sqlEditor');
    let sql = editor.value;
    
    // Basic SQL formatting
    sql = sql
        .replace(/\bSELECT\b/gi, 'SELECT')
        .replace(/\bFROM\b/gi, '\nFROM')
        .replace(/\bWHERE\b/gi, '\nWHERE')
        .replace(/\bGROUP BY\b/gi, '\nGROUP BY')
        .replace(/\bORDER BY\b/gi, '\nORDER BY')
        .replace(/\bLIMIT\b/gi, '\nLIMIT')
        .replace(/\bJOIN\b/gi, '\nJOIN')
        .replace(/\bLEFT JOIN\b/gi, '\nLEFT JOIN')
        .replace(/\bRIGHT JOIN\b/gi, '\nRIGHT JOIN')
        .replace(/\bINNER JOIN\b/gi, '\nINNER JOIN')
        .replace(/\bON\b/gi, '\n  ON')
        .replace(/\bAND\b/gi, '\n  AND')
        .replace(/\bOR\b/gi, '\n  OR');
    
    editor.value = sql;
}

// Export SQL results
function exportSQLResults() {
    if (!sqlResults || sqlResults.length === 0) {
        alert('No results to export');
        return;
    }
    
    // Convert to CSV
    const columns = Object.keys(sqlResults[0]);
    let csv = columns.join(',') + '\n';
    
    sqlResults.forEach(row => {
        const values = columns.map(col => {
            const value = row[col];
            if (value === null || value === undefined) return 'NULL';
            if (typeof value === 'string' && value.includes(',')) {
                return `"${value}"`;
            }
            return String(value);
        });
        csv += values.join(',') + '\n';
    });
    
    // Download CSV
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'sql_results.csv';
    a.click();
    window.URL.revokeObjectURL(url);
}

// Copy SQL results
function copySQLResults() {
    if (!sqlResults || sqlResults.length === 0) {
        alert('No results to copy');
        return;
    }
    
    const columns = Object.keys(sqlResults[0]);
    let text = columns.join('\t') + '\n';
    
    sqlResults.forEach(row => {
        const values = columns.map(col => {
            const value = row[col];
            return value === null || value === undefined ? 'NULL' : String(value);
        });
        text += values.join('\t') + '\n';
    });
    
    navigator.clipboard.writeText(text).then(() => {
        alert('Results copied to clipboard');
    }).catch(err => {
        console.error('Failed to copy: ', err);
        alert('Failed to copy results');
    });
}

// Load all tables on page load
async function loadAllTables() {
    try {
        const response = await fetch('/api/tables');
        const result = await response.json();
        
        if (result.success && result.tables) {
            allTables = result.tables;
            const tablesList = document.getElementById('tablesList');
            tablesList.innerHTML = '';
            
            result.tables.forEach(table => {
                const tableItem = document.createElement('div');
                tableItem.className = 'explorer-item';
                tableItem.onclick = () => selectTable(table);
                tableItem.innerHTML = `<i class="fas fa-table me-2"></i>${table}`;
                tablesList.appendChild(tableItem);
            });
        }
    } catch (error) {
        console.error('Error loading tables:', error);
    }
}

// Modern SQL Editor Functions

// Global variables for modern SQL editor
let queryHistory = JSON.parse(localStorage.getItem('sqlQueryHistory') || '[]');
let editorCursorPosition = { line: 1, column: 1 };
let autocompleteVisible = false;
let currentAutocompleteItems = [];

// Drag and Drop Functions
function dragTable(event, tableName) {
    event.dataTransfer.setData('text/plain', `table:${tableName}`);
    event.dataTransfer.effectAllowed = 'copy';
}

function dragField(event, fieldName) {
    event.dataTransfer.setData('text/plain', `field:${fieldName}`);
    event.dataTransfer.effectAllowed = 'copy';
}

function allowDrop(event) {
    event.preventDefault();
    event.dataTransfer.dropEffect = 'copy';
}

function dropIntoEditor(event) {
    event.preventDefault();
    const data = event.dataTransfer.getData('text/plain');
    const [type, value] = data.split(':');
    
    const editor = document.getElementById('sqlEditor');
    const cursorPos = editor.selectionStart;
    const textBefore = editor.value.substring(0, cursorPos);
    const textAfter = editor.value.substring(cursorPos);
    
    let insertText = '';
    if (type === 'table') {
        insertText = value;
    } else if (type === 'field') {
        insertText = value;
    }
    
    editor.value = textBefore + insertText + textAfter;
    editor.focus();
    editor.setSelectionRange(cursorPos + insertText.length, cursorPos + insertText.length);
    
    // Update line numbers
    updateLineNumbers();
}

// Autocomplete Functions
function setupAutocomplete() {
    const editor = document.getElementById('sqlEditor');
    if (!editor) return;
    
    editor.addEventListener('input', handleAutocomplete);
    editor.addEventListener('keydown', handleAutocompleteKeydown);
}

function handleAutocomplete(event) {
    const editor = event.target;
    const cursorPos = editor.selectionStart;
    const text = editor.value;
    
    // Find current word
    const wordMatch = text.substring(0, cursorPos).match(/\b\w*$/);
    const currentWord = wordMatch ? wordMatch[0] : '';
    
    if (currentWord.length >= 2) {
        showAutocomplete(currentWord, cursorPos);
    } else {
        hideAutocomplete();
    }
}

function showAutocomplete(word, position) {
    const suggestions = getSQLSuggestions(word);
    if (suggestions.length === 0) {
        hideAutocomplete();
        return;
    }
    
    currentAutocompleteItems = suggestions;
    autocompleteVisible = true;
    
    // Create or update autocomplete dropdown
    let dropdown = document.getElementById('autocompleteDropdown');
    if (!dropdown) {
        dropdown = document.createElement('div');
        dropdown.id = 'autocompleteDropdown';
        dropdown.className = 'autocomplete-dropdown';
        document.body.appendChild(dropdown);
    }
    
    dropdown.innerHTML = suggestions.map((item, index) => 
        `<div class="autocomplete-item ${index === 0 ? 'selected' : ''}" data-value="${item.value}">
            <i class="fas ${item.icon} me-2"></i>
            <span class="autocomplete-label">${item.label}</span>
            <span class="autocomplete-type">${item.type}</span>
        </div>`
    ).join('');
    
    // Position dropdown
    const editor = document.getElementById('sqlEditor');
    const rect = editor.getBoundingClientRect();
    dropdown.style.position = 'absolute';
    dropdown.style.left = rect.left + 'px';
    dropdown.style.top = (rect.bottom + 5) + 'px';
    dropdown.style.zIndex = '1000';
    dropdown.style.display = 'block';
}

function hideAutocomplete() {
    const dropdown = document.getElementById('autocompleteDropdown');
    if (dropdown) {
        dropdown.style.display = 'none';
    }
    autocompleteVisible = false;
}

function getSQLSuggestions(word) {
    const suggestions = [];
    const lowerWord = word.toLowerCase();
    
    // SQL Keywords
    const keywords = [
        'SELECT', 'FROM', 'WHERE', 'ORDER BY', 'GROUP BY', 'HAVING', 'JOIN', 'LEFT JOIN', 'RIGHT JOIN', 'INNER JOIN',
        'INSERT', 'UPDATE', 'DELETE', 'CREATE', 'ALTER', 'DROP', 'INDEX', 'TABLE', 'DATABASE',
        'AND', 'OR', 'NOT', 'IN', 'EXISTS', 'BETWEEN', 'LIKE', 'IS NULL', 'IS NOT NULL',
        'COUNT', 'SUM', 'AVG', 'MIN', 'MAX', 'DISTINCT', 'LIMIT', 'OFFSET'
    ];
    
    keywords.forEach(keyword => {
        if (keyword.toLowerCase().startsWith(lowerWord)) {
            suggestions.push({
                value: keyword,
                label: keyword,
                type: 'keyword',
                icon: 'fa-code'
            });
        }
    });
    
    // Table names
    allTables.forEach(table => {
        if (table.toLowerCase().startsWith(lowerWord)) {
            suggestions.push({
                value: table,
                label: table,
                type: 'table',
                icon: 'fa-table'
            });
        }
    });
    
    // Column names
    currentColumns.forEach(column => {
        if (column.toLowerCase().startsWith(lowerWord)) {
            suggestions.push({
                value: column,
                label: column,
                type: 'column',
                icon: 'fa-columns'
            });
        }
    });
    
    return suggestions.slice(0, 10); // Limit to 10 suggestions
}

function handleAutocompleteKeydown(event) {
    if (!autocompleteVisible) return;
    
    const dropdown = document.getElementById('autocompleteDropdown');
    if (!dropdown) return;
    
    const items = dropdown.querySelectorAll('.autocomplete-item');
    const selected = dropdown.querySelector('.autocomplete-item.selected');
    let selectedIndex = Array.from(items).indexOf(selected);
    
    switch (event.key) {
        case 'ArrowDown':
            event.preventDefault();
            selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
            updateAutocompleteSelection(items, selectedIndex);
            break;
        case 'ArrowUp':
            event.preventDefault();
            selectedIndex = Math.max(selectedIndex - 1, 0);
            updateAutocompleteSelection(items, selectedIndex);
            break;
        case 'Enter':
            event.preventDefault();
            if (selected) {
                insertAutocompleteSuggestion(selected.dataset.value);
            }
            break;
        case 'Escape':
            hideAutocomplete();
            break;
    }
}

function updateAutocompleteSelection(items, selectedIndex) {
    items.forEach((item, index) => {
        item.classList.toggle('selected', index === selectedIndex);
    });
}

function insertAutocompleteSuggestion(value) {
    const editor = document.getElementById('sqlEditor');
    const cursorPos = editor.selectionStart;
    const text = editor.value;
    
    // Find current word
    const wordMatch = text.substring(0, cursorPos).match(/\b\w*$/);
    const wordStart = cursorPos - (wordMatch ? wordMatch[0].length : 0);
    
    const newText = text.substring(0, wordStart) + value + text.substring(cursorPos);
    editor.value = newText;
    editor.focus();
    editor.setSelectionRange(wordStart + value.length, wordStart + value.length);
    
    hideAutocomplete();
    updateLineNumbers();
}

// Query History Functions
function addToHistory(query) {
    if (!query.trim()) return;
    
    // Remove if already exists
    queryHistory = queryHistory.filter(q => q.query !== query);
    
    // Add to beginning
    queryHistory.unshift({
        query: query,
        timestamp: new Date().toISOString()
    });
    
    // Keep only last 50 queries
    queryHistory = queryHistory.slice(0, 50);
    
    // Save to localStorage
    localStorage.setItem('sqlQueryHistory', JSON.stringify(queryHistory));
    
    // Update history display
    updateHistoryDisplay();
}

function updateHistoryDisplay() {
    const historyList = document.getElementById('historyList');
    if (!historyList) return;
    
    if (queryHistory.length === 0) {
        historyList.innerHTML = '<div class="explorer-empty"><small>No queries executed yet</small></div>';
        return;
    }
    
    historyList.innerHTML = queryHistory.map((item, index) => `
        <div class="explorer-item" onclick="loadHistoryQuery(${index})" title="${item.timestamp}">
            <i class="fas fa-history me-2"></i>
            <div class="history-item">
                <div class="history-query">${item.query.substring(0, 50)}${item.query.length > 50 ? '...' : ''}</div>
                <div class="history-time">${new Date(item.timestamp).toLocaleTimeString()}</div>
            </div>
        </div>
    `).join('');
}

function loadHistoryQuery(index) {
    const query = queryHistory[index].query;
    const editor = document.getElementById('sqlEditor');
    editor.value = query;
    editor.focus();
    updateLineNumbers();
}

// Line Numbers and Cursor Position
function updateLineNumbers() {
    const editor = document.getElementById('sqlEditor');
    const linesContainer = document.getElementById('editorLines');
    if (!editor || !linesContainer) return;
    
    const lines = editor.value.split('\n');
    const lineNumbers = lines.map((_, index) => index + 1).join('\n');
    linesContainer.textContent = lineNumbers;
    
    // Update cursor position
    updateCursorPosition();
}

function updateCursorPosition() {
    const editor = document.getElementById('sqlEditor');
    const info = document.getElementById('editorInfo');
    if (!editor || !info) return;
    
    const cursorPos = editor.selectionStart;
    const textBeforeCursor = editor.value.substring(0, cursorPos);
    const lines = textBeforeCursor.split('\n');
    const line = lines.length;
    const column = lines[lines.length - 1].length + 1;
    
    editorCursorPosition = { line, column };
    info.textContent = `Line ${line}, Column ${column}`;
}

// Enhanced SQL Editor Functions
function refreshExplorer() {
    loadAllTables();
    updateHistoryDisplay();
}

function toggleResultsPanel() {
    const panel = document.getElementById('resultsPanel');
    if (panel.style.display === 'none') {
        panel.style.display = 'flex';
    } else {
        panel.style.display = 'none';
    }
}

function hideErrorPanel() {
    const panel = document.getElementById('errorPanel');
    panel.style.display = 'none';
}

function saveQuery() {
    const editor = document.getElementById('sqlEditor');
    const query = editor.value.trim();
    
    if (!query) {
        alert('No query to save');
        return;
    }
    
    const filename = prompt('Enter filename for query:', `query_${new Date().toISOString().split('T')[0]}.sql`);
    if (filename) {
        const blob = new Blob([query], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
    }
}

function loadQuery() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.sql,.txt';
    input.onchange = function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const editor = document.getElementById('sqlEditor');
                editor.value = e.target.result;
                updateLineNumbers();
            };
            reader.readAsText(file);
        }
    };
    input.click();
}

// Enhanced display functions
function displaySQLResults(data, columns) {
    const resultsPanel = document.getElementById('resultsPanel');
    const resultsContainer = document.getElementById('sqlResultsContainer');
    const resultCount = document.getElementById('resultCount');
    
    sqlResults = data;
    
    if (!data || data.length === 0) {
        resultsContainer.innerHTML = `
            <div class="text-center p-5 text-muted">
                <i class="fas fa-search fa-3x mb-3" style="opacity: 0.3;"></i>
                <h6>No results found</h6>
                <small>Try adjusting your query or check the table data</small>
            </div>
        `;
        resultCount.textContent = '0 rows';
        resultCount.className = 'results-count';
        resultCount.style.background = '#718096';
    } else {
        let html = '<table class="table table-striped table-hover mb-0">';
        
        // Header
        html += '<thead><tr>';
        columns.forEach(col => {
            html += `<th scope="col">${col}</th>`;
        });
        html += '</tr></thead>';
        
        // Body
        html += '<tbody>';
        data.forEach((row, index) => {
            html += '<tr>';
            columns.forEach(col => {
                const value = row[col];
                if (value === null || value === undefined) {
                    html += '<td class="text-muted font-italic"><i class="fas fa-minus me-1"></i>NULL</td>';
                } else if (value === '') {
                    html += '<td class="text-muted font-italic"><i class="fas fa-minus me-1"></i>Empty</td>';
                } else {
                    html += `<td>${String(value)}</td>`;
                }
            });
            html += '</tr>';
        });
        html += '</tbody></table>';
        
        resultsContainer.innerHTML = html;
        resultCount.textContent = `${data.length} row${data.length !== 1 ? 's' : ''}`;
        resultCount.className = 'results-count';
        resultCount.style.background = '#38a169';
    }
    
    // Show results panel
    resultsPanel.style.display = 'flex';
    
    // Add to history
    const editor = document.getElementById('sqlEditor');
    addToHistory(editor.value.trim());
}

function showSQLError(message) {
    const errorPanel = document.getElementById('errorPanel');
    const errorMessage = document.getElementById('errorMessage');
    
    errorMessage.textContent = message;
    errorPanel.style.display = 'block';
}

function hideSQLError() {
    const errorPanel = document.getElementById('errorPanel');
    errorPanel.style.display = 'none';
}

// Initialize SQL editor on page load
document.addEventListener('DOMContentLoaded', function() {
    // Load all tables
    loadAllTables();
    
    // Set up search functionality
    const tableSearch = document.getElementById('tableSearch');
    const fieldSearch = document.getElementById('fieldSearch');
    
    if (tableSearch) {
        tableSearch.addEventListener('input', function() {
            filterExplorerItems('tablesList', this.value);
        });
    }
    
    if (fieldSearch) {
        fieldSearch.addEventListener('input', function() {
            filterExplorerItems('fieldsList', this.value);
        });
    }
    
    // Set up SQL editor
    const sqlEditor = document.getElementById('sqlEditor');
    if (sqlEditor) {
        // Keyboard shortcuts
        sqlEditor.addEventListener('keydown', function(e) {
            // Ctrl+Enter to execute
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                executeSQL();
            }
            // Ctrl+K to clear
            else if (e.ctrlKey && e.key === 'k') {
                e.preventDefault();
                clearSQL();
            }
            // Ctrl+Shift+F to format
            else if (e.ctrlKey && e.shiftKey && e.key === 'F') {
                e.preventDefault();
                formatSQL();
            }
            // Ctrl+S to save
            else if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveQuery();
            }
        });
        
        // Cursor position tracking
        sqlEditor.addEventListener('input', function() {
            updateLineNumbers();
        });
        
        sqlEditor.addEventListener('click', function() {
            updateCursorPosition();
        });
        
        sqlEditor.addEventListener('keyup', function() {
            updateCursorPosition();
        });
        
        // Drag and drop
        sqlEditor.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.classList.add('drag-over');
        });
        
        sqlEditor.addEventListener('dragleave', function(e) {
            this.classList.remove('drag-over');
        });
        
        sqlEditor.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
        });
    }
    
    // Set up autocomplete
    setupAutocomplete();
    
    // Initialize line numbers
    updateLineNumbers();
    
    // Load query history
    updateHistoryDisplay();
    
    // Add tooltips to buttons
    const executeBtn = document.getElementById('executeSQLBtn');
    if (executeBtn) {
        executeBtn.title = 'Execute SQL Query (Ctrl+Enter)';
    }
    
    const clearBtn = document.querySelector('button[onclick="clearSQL()"]');
    if (clearBtn) {
        clearBtn.title = 'Clear Editor (Ctrl+K)';
    }
    
    const formatBtn = document.querySelector('button[onclick="formatSQL()"]');
    if (formatBtn) {
        formatBtn.title = 'Format SQL (Ctrl+Shift+F)';
    }
});

// Filter explorer items
function filterExplorerItems(listId, searchTerm) {
    const list = document.getElementById(listId);
    const items = list.querySelectorAll('.explorer-item');
    
    items.forEach(item => {
        const text = item.textContent.toLowerCase();
        if (text.includes(searchTerm.toLowerCase())) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
}

// Make functions globally accessible
window.toggleExplorerSection = toggleExplorerSection;
window.selectTable = selectTable;
window.insertField = insertField;
window.loadTableFields = loadTableFields;
window.refreshExplorer = refreshExplorer;
</script>
{% endblock %}