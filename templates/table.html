{% extends "base.html" %}

{% block title %}{{ table_name }} - DataVault Pro{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-semibold text-gradient">
        <i class="fas fa-table me-2 floating"></i>Table: {{ table_name }}
    </h2>
    <div>
        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary icon-hover">
            <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
        </a>
    </div>
</div>

<!-- Filter Panel -->
<div class="card mb-4 filter-panel">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0 fw-semibold">
            <i class="fas fa-filter me-2"></i>Advanced Filters
            <span id="filterCountBadge" class="badge bg-primary ms-2 d-none">0</span>
        </h5>
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-primary btn-sm" onclick="toggleFilterPanel()">
                <i class="fas fa-chevron-down" id="filterToggleIcon"></i>
                <span id="filterToggleText">Show Filters</span>
            </button>
            <button type="button" class="btn btn-outline-danger btn-sm" onclick="clearAllFilters()" id="clearFiltersBtn" disabled>
                <i class="fas fa-trash me-1"></i>Clear All
            </button>
        </div>
    </div>
    <div class="card-body filter-body" style="display: none;">
        <!-- Filter Builder -->
        <div id="filterBuilder">
            <!-- Main Logic Selection -->
            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label fw-semibold">Main Logic</label>
                    <select class="form-select" id="mainLogic">
                        <option value="AND">AND (All conditions must match)</option>
                        <option value="OR">OR (Any condition can match)</option>
                    </select>
                </div>
                <div class="col-md-6 d-flex align-items-end">
                    <button type="button" class="btn btn-success" onclick="addFilterGroup()">
                        <i class="fas fa-plus me-1"></i>Add Filter Group
                    </button>
                </div>
            </div>
            
            <!-- Filter Groups Container -->
            <div id="filterGroups">
                <!-- Filter groups will be dynamically added here -->
            </div>
            
            <!-- Action Buttons -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-primary" onclick="applyFilters()">
                            <i class="fas fa-search me-1"></i>Apply Filters
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="resetFilters()">
                            <i class="fas fa-undo me-1"></i>Reset
                        </button>
                        <button type="button" class="btn btn-outline-info" onclick="saveFilterPreset()">
                            <i class="fas fa-save me-1"></i>Save Preset
                        </button>
                        <button type="button" class="btn btn-outline-warning" onclick="loadFilterPreset()">
                            <i class="fas fa-upload me-1"></i>Load Preset
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Data Panel -->
<div class="card table-data-card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0 fw-semibold">
            <i class="fas fa-list me-2"></i>Data 
            <span id="dataInfo">
                {% if filtered %}
                    <span class="badge bg-warning">Filtered</span>
                {% endif %}
                ({{ rows|length }} of {{ total_rows }} rows)
            </span>
        </h5>
        <div class="d-flex gap-2 align-items-center">
            <!-- Pagination Controls -->
            <div class="btn-group" role="group" aria-label="Rows per page">
                <a href="#" onclick="changePageSize(25)" 
                   class="btn btn-outline-primary btn-sm {{ 'active' if limit == 25 else '' }}">25</a>
                <a href="#" onclick="changePageSize(50)" 
                   class="btn btn-outline-primary btn-sm {{ 'active' if limit == 50 else '' }}">50</a>
                <a href="#" onclick="changePageSize(100)" 
                   class="btn btn-outline-primary btn-sm {{ 'active' if limit == 100 else '' }}">100</a>
                <a href="#" onclick="changePageSize(250)" 
                   class="btn btn-outline-primary btn-sm {{ 'active' if limit == 250 else '' }}">250</a>
            </div>
            
            <!-- Export Button -->
            <button type="button" class="btn btn-success btn-sm icon-hover" onclick="exportData()">
                <i class="fas fa-download me-1"></i>Export CSV
            </button>
            
            <!-- Refresh Button -->
            <button type="button" class="btn btn-outline-secondary btn-sm icon-hover" onclick="refreshData()">
                <i class="fas fa-sync-alt me-1"></i>Refresh
            </button>
        </div>
    </div>
    
    <div class="card-body p-0">
        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="text-center py-5 d-none">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-muted">Loading data...</p>
        </div>
        
        <!-- Data Table -->
        <div id="dataContainer">
            {% if rows %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0" id="dataTable">
                        <thead class="table-dark sticky-top">
                            <tr>
                                <th scope="col" style="width: 60px;">#</th>
                                {% for column in columns %}
                                    <th scope="col" class="column-header" data-column="{{ column }}">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span>{{ column }}</span>
                                            <div class="column-actions">
                                                <button class="btn btn-sm btn-outline-light column-filter-btn" 
                                                        onclick="quickFilter('{{ column }}')" 
                                                        title="Quick filter">
                                                    <i class="fas fa-filter"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-light column-sort-btn" 
                                                        onclick="sortColumn('{{ column }}')" 
                                                        title="Sort column">
                                                    <i class="fas fa-sort"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in rows %}
                                <tr class="data-row">
                                    <td class="row-number">{{ (page - 1) * limit + loop.index }}</td>
                                    {% for cell in row %}
                                        <td class="data-cell">
                                            {% if cell is none %}
                                                <span class="text-muted font-italic null-value">NULL</span>
                                            {% elif cell == '' %}
                                                <span class="text-muted font-italic empty-value">Empty</span>
                                            {% else %}
                                                <span class="cell-content">{{ cell }}</span>
                                            {% endif %}
                                        </td>
                                    {% endfor %}
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted fw-semibold">No data found</h5>
                    <p class="text-muted fw-medium">
                        {% if filtered %}
                            No rows match your filter criteria. Try adjusting your filters.
                        {% else %}
                            This table appears to be empty.
                        {% endif %}
                    </p>
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Pagination Footer -->
    {% if total_rows > limit %}
    <div class="card-footer">
        <div class="d-flex justify-content-between align-items-center">
            <small class="text-muted fw-medium">
                <i class="fas fa-info-circle me-1"></i>
                Showing {{ (page - 1) * limit + 1 }} to {{ [(page * limit), total_rows] | min }} of {{ total_rows }} rows
                {% if filtered %}
                    <span class="badge bg-warning">Filtered</span>
                {% endif %}
            </small>
            
            <!-- Pagination Controls -->
            <nav aria-label="Table pagination">
                <ul class="pagination pagination-sm mb-0">
                    <!-- First Page -->
                    <li class="page-item {{ 'disabled' if page <= 1 else '' }}">
                        <a class="page-link" href="#" onclick="changePage(1)">
                            <i class="fas fa-angle-double-left"></i>
                        </a>
                    </li>
                    
                    <!-- Previous Page -->
                    <li class="page-item {{ 'disabled' if page <= 1 else '' }}">
                        <a class="page-link" href="#" onclick="changePage({{ page - 1 }})">
                            <i class="fas fa-angle-left"></i>
                        </a>
                    </li>
                    
                    <!-- Page Numbers -->
                    {% set start_page = [1, page - 2] | max %}
                    {% set end_page = [total_pages, page + 2] | min %}
                    
                    {% if start_page > 1 %}
                        <li class="page-item"><span class="page-link">...</span></li>
                    {% endif %}
                    
                    {% for p in range(start_page, end_page + 1) %}
                        <li class="page-item {{ 'active' if p == page else '' }}">
                            <a class="page-link" href="#" onclick="changePage({{ p }})">{{ p }}</a>
                        </li>
                    {% endfor %}
                    
                    {% if end_page < total_pages %}
                        <li class="page-item"><span class="page-link">...</span></li>
                    {% endif %}
                    
                    <!-- Next Page -->
                    <li class="page-item {{ 'disabled' if page >= total_pages else '' }}">
                        <a class="page-link" href="#" onclick="changePage({{ page + 1 }})">
                            <i class="fas fa-angle-right"></i>
                        </a>
                    </li>
                    
                    <!-- Last Page -->
                    <li class="page-item {{ 'disabled' if page >= total_pages else '' }}">
                        <a class="page-link" href="#" onclick="changePage({{ total_pages }})">
                            <i class="fas fa-angle-double-right"></i>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
    {% endif %}
</div>

<!-- Quick Filter Modal -->
<div class="modal fade" id="quickFilterModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-filter me-2"></i>Quick Filter: <span id="quickFilterColumn"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Operation</label>
                    <select class="form-select" id="quickFilterOperation">
                        <option value="contains">Contains</option>
                        <option value="equals">Equals</option>
                        <option value="not_contains">Does not contain</option>
                        <option value="not_equals">Does not equal</option>
                        <option value="starts_with">Starts with</option>
                        <option value="ends_with">Ends with</option>
                        <option value="is_null">Is NULL</option>
                        <option value="is_not_null">Is not NULL</option>
                    </select>
                </div>
                <div class="mb-3" id="quickFilterValueGroup">
                    <label class="form-label">Value</label>
                    <input type="text" class="form-control" id="quickFilterValue" 
                           placeholder="Enter filter value">
                    <div class="form-text">
                        <strong>Suggestions:</strong>
                        <div id="quickFilterSuggestions" class="mt-2"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="applyQuickFilter()">Apply Filter</button>
            </div>
        </div>
    </div>
</div>

<!-- Filter Preset Modal -->
<div class="modal fade" id="filterPresetModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-save me-2"></i>Save Filter Preset
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Preset Name</label>
                    <input type="text" class="form-control" id="presetName" 
                           placeholder="Enter a name for this filter preset">
                </div>
                <div class="mb-3">
                    <label class="form-label">Description (optional)</label>
                    <textarea class="form-control" id="presetDescription" rows="3"
                              placeholder="Describe what this filter does"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="savePreset()">Save Preset</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Global variables
let currentFilters = { logic: 'AND', groups: [] };
let groupCounter = 0;
let conditionCounter = 0;
let tableColumns = {{ columns | tojson }};
let currentPage = {{ page }};
let currentLimit = {{ limit }};
let currentTableName = {{ table_name | tojson }};

// Filter operations configuration
const filterOperations = {
    'text': [
        { value: 'contains', label: 'Contains' },
        { value: 'not_contains', label: 'Does not contain' },
        { value: 'equals', label: 'Equals' },
        { value: 'not_equals', label: 'Does not equal' },
        { value: 'starts_with', label: 'Starts with' },
        { value: 'ends_with', label: 'Ends with' },
        { value: 'is_null', label: 'Is NULL' },
        { value: 'is_not_null', label: 'Is not NULL' },
        { value: 'in', label: 'In (comma separated)' },
        { value: 'not_in', label: 'Not in (comma separated)' }
    ],
    'number': [
        { value: 'equals', label: 'Equals' },
        { value: 'not_equals', label: 'Does not equal' },
        { value: 'greater_than', label: 'Greater than' },
        { value: 'less_than', label: 'Less than' },
        { value: 'greater_equal', label: 'Greater than or equal' },
        { value: 'less_equal', label: 'Less than or equal' },
        { value: 'between', label: 'Between' },
        { value: 'is_null', label: 'Is NULL' },
        { value: 'is_not_null', label: 'Is not NULL' }
    ],
    'date': [
        { value: 'equals', label: 'Equals' },
        { value: 'not_equals', label: 'Does not equal' },
        { value: 'greater_than', label: 'After' },
        { value: 'less_than', label: 'Before' },
        { value: 'greater_equal', label: 'On or after' },
        { value: 'less_equal', label: 'On or before' },
        { value: 'between', label: 'Between' },
        { value: 'is_null', label: 'Is NULL' },
        { value: 'is_not_null', label: 'Is not NULL' }
    ]
};

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Load any existing filters from URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const filtersParam = urlParams.get('filters');
    if (filtersParam) {
        try {
            currentFilters = JSON.parse(filtersParam);
            updateFilterCountBadge();
            if (currentFilters.groups.length > 0) {
                toggleFilterPanel(true);
                rebuildFilterUI();
            }
        } catch (e) {
            console.error('Error parsing filters from URL:', e);
        }
    }
    
    // Load filter presets from localStorage
    loadFilterPresets();
});

// Filter Panel Toggle
function toggleFilterPanel(forceShow = false) {
    const filterBody = document.querySelector('.filter-body');
    const toggleIcon = document.getElementById('filterToggleIcon');
    const toggleText = document.getElementById('filterToggleText');
    
    if (forceShow || filterBody.style.display === 'none') {
        filterBody.style.display = 'block';
        toggleIcon.className = 'fas fa-chevron-up';
        toggleText.textContent = 'Hide Filters';
    } else {
        filterBody.style.display = 'none';
        toggleIcon.className = 'fas fa-chevron-down';
        toggleText.textContent = 'Show Filters';
    }
}

// Add Filter Group
function addFilterGroup() {
    const groupId = `group_${++groupCounter}`;
    const groupsContainer = document.getElementById('filterGroups');
    
    const groupHtml = `
        <div class="filter-group card mb-3" id="${groupId}">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">Filter Group ${groupCounter}</h6>
                <div class="d-flex gap-2 align-items-center">
                    <select class="form-select form-select-sm group-logic" data-group="${groupId}" onchange="updateFilters()">
                        <option value="AND">AND</option>
                        <option value="OR">OR</option>
                    </select>
                    <button type="button" class="btn btn-success btn-sm" onclick="addCondition('${groupId}')">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeFilterGroup('${groupId}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="conditions-container" id="${groupId}_conditions">
                    <!-- Conditions will be added here -->
                </div>
            </div>
        </div>
    `;
    
    groupsContainer.insertAdjacentHTML('beforeend', groupHtml);
    
    // Add first condition automatically
    addCondition(groupId);
    
    updateFilters();
}

// Remove Filter Group
function removeFilterGroup(groupId) {
    const group = document.getElementById(groupId);
    if (group) {
        group.remove();
        updateFilters();
    }
}

// Add Condition to Group
function addCondition(groupId) {
    const conditionId = `condition_${++conditionCounter}`;
    const conditionsContainer = document.getElementById(`${groupId}_conditions`);
    
    const conditionHtml = `
        <div class="condition row mb-2 align-items-end" id="${conditionId}">
            <div class="col-md-3">
                <label class="form-label">Field</label>
                <select class="form-select condition-field" data-condition="${conditionId}" onchange="updateOperations('${conditionId}')">
                    <option value="">Select field...</option>
                    ${tableColumns.map(col => `<option value="${col}">${col}</option>`).join('')}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Operation</label>
                <select class="form-select condition-operation" data-condition="${conditionId}" onchange="updateValueInput('${conditionId}')">
                    <option value="">Select operation...</option>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">Value</label>
                <div class="value-input-container" id="${conditionId}_value_container">
                    <input type="text" class="form-control condition-value" data-condition="${conditionId}" 
                           placeholder="Enter value" onchange="updateFilters()">
                </div>
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-danger btn-sm" onclick="removeCondition('${conditionId}')">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `;
    
    conditionsContainer.insertAdjacentHTML('beforeend', conditionHtml);
}

// Remove Condition
function removeCondition(conditionId) {
    const condition = document.getElementById(conditionId);
    if (condition) {
        condition.remove();
        updateFilters();
    }
}

// Update Operations based on field type
function updateOperations(conditionId) {
    const fieldSelect = document.querySelector(`[data-condition="${conditionId}"].condition-field`);
    const operationSelect = document.querySelector(`[data-condition="${conditionId}"].condition-operation`);
    
    const fieldName = fieldSelect.value;
    const fieldType = getFieldType(fieldName);
    
    operationSelect.innerHTML = '<option value="">Select operation...</option>';
    
    const operations = filterOperations[fieldType] || filterOperations.text;
    operations.forEach(op => {
        operationSelect.innerHTML += `<option value="${op.value}">${op.label}</option>`;
    });
    
    updateValueInput(conditionId);
    updateFilters();
}

// Update Value Input based on operation
function updateValueInput(conditionId) {
    const operationSelect = document.querySelector(`[data-condition="${conditionId}"].condition-operation`);
    const valueContainer = document.getElementById(`${conditionId}_value_container`);
    
    const operation = operationSelect.value;
    
    if (operation === 'is_null' || operation === 'is_not_null') {
        valueContainer.innerHTML = '<span class="form-control-plaintext text-muted">No value required</span>';
    } else if (operation === 'between') {
        valueContainer.innerHTML = `
            <div class="row">
                <div class="col-6">
                    <input type="text" class="form-control condition-value-min" data-condition="${conditionId}" 
                           placeholder="Min value" onchange="updateFilters()">
                </div>
                <div class="col-6">
                    <input type="text" class="form-control condition-value-max" data-condition="${conditionId}" 
                           placeholder="Max value" onchange="updateFilters()">
                </div>
            </div>
        `;
    } else {
        valueContainer.innerHTML = `
            <input type="text" class="form-control condition-value" data-condition="${conditionId}" 
                   placeholder="Enter value" onchange="updateFilters()" 
                   onfocus="loadColumnSuggestions('${conditionId}')">
        `;
    }
    
    updateFilters();
}

// Get field type (simplified)
function getFieldType(fieldName) {
    // You could enhance this by getting actual column types from the backend
    const numericTypes = ['integer', 'bigint', 'decimal', 'numeric', 'real', 'double'];
    const dateTypes = ['date', 'timestamp', 'timestamptz', 'time', 'timetz'];
    
    // For now, assume text type for all fields
    // This could be enhanced with actual type information from the backend
    return 'text';
}

// Load column suggestions for autocomplete
function loadColumnSuggestions(conditionId) {
    const fieldSelect = document.querySelector(`[data-condition="${conditionId}"].condition-field`);
    const fieldName = fieldSelect.value;
    
    if (!fieldName) return;
    
    fetch(`/api/table/${currentTableName}/column/${fieldName}/values?limit=20`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Add suggestions as datalist
                const valueInput = document.querySelector(`[data-condition="${conditionId}"].condition-value`);
                if (valueInput && data.values.length > 0) {
                    const datalistId = `suggestions_${conditionId}`;
                    let datalist = document.getElementById(datalistId);
                    if (!datalist) {
                        datalist = document.createElement('datalist');
                        datalist.id = datalistId;
                        valueInput.parentNode.appendChild(datalist);
                        valueInput.setAttribute('list', datalistId);
                    }
                    
                    datalist.innerHTML = data.values.map(value => 
                        `<option value="${value}">`
                    ).join('');
                }
            }
        })
        .catch(error => console.error('Error loading suggestions:', error));
}

// Update Filters Object
function updateFilters() {
    const mainLogic = document.getElementById('mainLogic').value;
    const groups = [];
    
    document.querySelectorAll('.filter-group').forEach(groupEl => {
        const groupId = groupEl.id;
        const groupLogic = document.querySelector(`[data-group="${groupId}"].group-logic`).value;
        const conditions = [];
        
        groupEl.querySelectorAll('.condition').forEach(conditionEl => {
            const conditionId = conditionEl.id;
            const field = document.querySelector(`[data-condition="${conditionId}"].condition-field`).value;
            const operation = document.querySelector(`[data-condition="${conditionId}"].condition-operation`).value;
            
            if (!field || !operation) return;
            
            let value = null;
            if (operation === 'between') {
                const minInput = document.querySelector(`[data-condition="${conditionId}"].condition-value-min`);
                const maxInput = document.querySelector(`[data-condition="${conditionId}"].condition-value-max`);
                if (minInput && maxInput && minInput.value && maxInput.value) {
                    value = { min: minInput.value, max: maxInput.value };
                }
            } else if (operation !== 'is_null' && operation !== 'is_not_null') {
                const valueInput = document.querySelector(`[data-condition="${conditionId}"].condition-value`);
                if (valueInput) {
                    value = valueInput.value;
                }
            }
            
            if (value !== null || operation === 'is_null' || operation === 'is_not_null') {
                conditions.push({ field, operation, value });
            }
        });
        
        if (conditions.length > 0) {
            groups.push({ logic: groupLogic, conditions });
        }
    });
    
    currentFilters = { logic: mainLogic, groups };
    updateFilterCountBadge();
}

// Update Filter Count Badge
function updateFilterCountBadge() {
    const badge = document.getElementById('filterCountBadge');
    const clearBtn = document.getElementById('clearFiltersBtn');
    
    let conditionCount = 0;
    currentFilters.groups.forEach(group => {
        conditionCount += group.conditions.length;
    });
    
    if (conditionCount > 0) {
        badge.textContent = conditionCount;
        badge.classList.remove('d-none');
        clearBtn.disabled = false;
    } else {
        badge.classList.add('d-none');
        clearBtn.disabled = true;
    }
}

// Apply Filters
function applyFilters() {
    if (currentFilters.groups.length === 0) {
        showToast('No filters defined', 'warning');
        return;
    }
    
    showLoading(true);
    
    const params = new URLSearchParams({
        page: 1, // Reset to first page when applying filters
        limit: currentLimit,
        filters: JSON.stringify(currentFilters)
    });
    
    fetch(`/api/table/${currentTableName}/data?${params}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateDataTable(data);
                currentPage = 1;
                updateURL();
                showToast(`Filters applied successfully. Found ${data.total_rows} matching rows.`, 'success');
            } else {
                showToast(`Error applying filters: ${data.error}`, 'error');
            }
        })
        .catch(error => {
            console.error('Error applying filters:', error);
            showToast('Error applying filters', 'error');
        })
        .finally(() => {
            showLoading(false);
        });
}

// Clear All Filters
function clearAllFilters() {
    currentFilters = { logic: 'AND', groups: [] };
    document.getElementById('filterGroups').innerHTML = '';
    document.getElementById('mainLogic').value = 'AND';
    updateFilterCountBadge();
    
    // Reload data without filters
    reloadData();
}

// Reset Filters (clear UI but don't apply)
function resetFilters() {
    clearAllFilters();
}

// Quick Filter
function quickFilter(columnName) {
    document.getElementById('quickFilterColumn').textContent = columnName;
    document.getElementById('quickFilterValue').value = '';
    document.getElementById('quickFilterSuggestions').innerHTML = '';
    
    // Load suggestions for this column
    fetch(`/api/table/${currentTableName}/column/${columnName}/values?limit=10`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.values.length > 0) {
                const suggestionsContainer = document.getElementById('quickFilterSuggestions');
                suggestionsContainer.innerHTML = data.values.map(value => 
                    `<span class="badge bg-light text-dark me-1 mb-1 suggestion-badge" 
                           onclick="document.getElementById('quickFilterValue').value='${value}'"
                           style="cursor: pointer;">${value}</span>`
                ).join('');
            }
        });
    
    const modal = new bootstrap.Modal(document.getElementById('quickFilterModal'));
    modal.show();
}

// Apply Quick Filter
function applyQuickFilter() {
    const column = document.getElementById('quickFilterColumn').textContent;
    const operation = document.getElementById('quickFilterOperation').value;
    const value = document.getElementById('quickFilterValue').value;
    
    if (!operation || (!value && operation !== 'is_null' && operation !== 'is_not_null')) {
        showToast('Please fill in all required fields', 'warning');
        return;
    }
    
    // Add as a new filter group
    currentFilters.groups.push({
        logic: 'AND',
        conditions: [{ field: column, operation, value }]
    });
    
    // Close modal and apply filters
    bootstrap.Modal.getInstance(document.getElementById('quickFilterModal')).hide();
    
    // Rebuild UI and apply
    rebuildFilterUI();
    applyFilters();
}

// Rebuild Filter UI from current filters
function rebuildFilterUI() {
    const groupsContainer = document.getElementById('filterGroups');
    groupsContainer.innerHTML = '';
    
    document.getElementById('mainLogic').value = currentFilters.logic;
    
    currentFilters.groups.forEach((group, groupIndex) => {
        addFilterGroup();
        const groupId = `group_${groupCounter}`;
        
        // Set group logic
        document.querySelector(`[data-group="${groupId}"].group-logic`).value = group.logic;
        
        // Remove the auto-added condition
        const autoCondition = document.querySelector(`#${groupId}_conditions .condition`);
        if (autoCondition) autoCondition.remove();
        
        // Add conditions
        group.conditions.forEach(condition => {
            addCondition(groupId);
            const conditionId = `condition_${conditionCounter}`;
            
            // Set field
            document.querySelector(`[data-condition="${conditionId}"].condition-field`).value = condition.field;
            updateOperations(conditionId);
            
            // Set operation
            document.querySelector(`[data-condition="${conditionId}"].condition-operation`).value = condition.operation;
            updateValueInput(conditionId);
            
            // Set value
            if (condition.operation === 'between' && typeof condition.value === 'object') {
                const minInput = document.querySelector(`[data-condition="${conditionId}"].condition-value-min`);
                const maxInput = document.querySelector(`[data-condition="${conditionId}"].condition-value-max`);
                if (minInput && maxInput) {
                    minInput.value = condition.value.min;
                    maxInput.value = condition.value.max;
                }
            } else if (condition.operation !== 'is_null' && condition.operation !== 'is_not_null') {
                const valueInput = document.querySelector(`[data-condition="${conditionId}"].condition-value`);
                if (valueInput) {
                    valueInput.value = condition.value;
                }
            }
        });
    });
}

// Pagination and Data Management
function changePage(page) {
    if (page < 1) return;
    currentPage = page;
    reloadData();
}

function changePageSize(limit) {
    currentLimit = limit;
    currentPage = 1; // Reset to first page
    reloadData();
}

function reloadData() {
    showLoading(true);
    
    const params = new URLSearchParams({
        page: currentPage,
        limit: currentLimit
    });
    
    if (currentFilters.groups.length > 0) {
        params.append('filters', JSON.stringify(currentFilters));
    }
    
    fetch(`/api/table/${currentTableName}/data?${params}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateDataTable(data);
                updateURL();
            } else {
                showToast(`Error loading data: ${data.error}`, 'error');
            }
        })
        .catch(error => {
            console.error('Error loading data:', error);
            showToast('Error loading data', 'error');
        })
        .finally(() => {
            showLoading(false);
        });
}

function refreshData() {
    reloadData();
    showToast('Data refreshed', 'success');
}

// Update Data Table
function updateDataTable(data) {
    // This would require a full page reload to update the template
    // For now, redirect with the new parameters
    const params = new URLSearchParams({
        page: currentPage,
        limit: currentLimit
    });
    
    if (currentFilters.groups.length > 0) {
        params.append('filters', JSON.stringify(currentFilters));
    }
    
    window.location.href = `/table/${currentTableName}?${params}`;
}

// Export Data
function exportData() {
    const params = new URLSearchParams();
    
    if (currentFilters.groups.length > 0) {
        params.append('filters', JSON.stringify(currentFilters));
    }
    
    const exportUrl = `/api/table/${currentTableName}/export?${params}`;
    
    // Create a temporary link to trigger download
    const link = document.createElement('a');
    link.href = exportUrl;
    link.download = `${currentTableName}_export.csv`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showToast('Export started', 'success');
}

// URL Management
function updateURL() {
    const params = new URLSearchParams({
        page: currentPage,
        limit: currentLimit
    });
    
    if (currentFilters.groups.length > 0) {
        params.append('filters', JSON.stringify(currentFilters));
    }
    
    const newURL = `${window.location.pathname}?${params}`;
    window.history.pushState({}, '', newURL);
}

// Filter Presets
function saveFilterPreset() {
    if (currentFilters.groups.length === 0) {
        showToast('No filters to save', 'warning');
        return;
    }
    
    const modal = new bootstrap.Modal(document.getElementById('filterPresetModal'));
    modal.show();
}

function savePreset() {
    const name = document.getElementById('presetName').value.trim();
    const description = document.getElementById('presetDescription').value.trim();
    
    if (!name) {
        showToast('Please enter a preset name', 'warning');
        return;
    }
    
    const preset = {
        name,
        description,
        filters: JSON.parse(JSON.stringify(currentFilters)),
        table: currentTableName,
        created: new Date().toISOString()
    };
    
    // Save to localStorage
    const presets = JSON.parse(localStorage.getItem('filterPresets') || '[]');
    presets.push(preset);
    localStorage.setItem('filterPresets', JSON.stringify(presets));
    
    bootstrap.Modal.getInstance(document.getElementById('filterPresetModal')).hide();
    showToast('Filter preset saved', 'success');
    
    // Clear form
    document.getElementById('presetName').value = '';
    document.getElementById('presetDescription').value = '';
}

function loadFilterPreset() {
    // This would show a modal with saved presets
    showToast('Filter preset loading coming soon', 'info');
}

function loadFilterPresets() {
    // Load presets from localStorage on page load
    const presets = JSON.parse(localStorage.getItem('filterPresets') || '[]');
    console.log('Loaded filter presets:', presets);
}

// Utility Functions
function showLoading(show) {
    const spinner = document.getElementById('loadingSpinner');
    const dataContainer = document.getElementById('dataContainer');
    
    if (show) {
        spinner.classList.remove('d-none');
        dataContainer.style.opacity = '0.5';
    } else {
        spinner.classList.add('d-none');
        dataContainer.style.opacity = '1';
    }
}

function showToast(message, type = 'info') {
    // Create toast container if it doesn't exist
    let toastContainer = document.getElementById('toastContainer');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toastContainer';
        toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
        toastContainer.style.zIndex = '1055';
        document.body.appendChild(toastContainer);
    }
    
    const iconMap = {
        'success': 'fas fa-check-circle',
        'error': 'fas fa-exclamation-circle',
        'info': 'fas fa-info-circle',
        'warning': 'fas fa-exclamation-triangle'
    };
    
    const colorMap = {
        'success': 'success',
        'error': 'danger',
        'info': 'info',
        'warning': 'warning'
    };
    
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${colorMap[type]} border-0 shadow-lg`;
    toast.setAttribute('role', 'alert');
    toast.style.borderRadius = '12px';
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i class="${iconMap[type]} me-2"></i>
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    toastContainer.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast, {
        autohide: true,
        delay: 4000
    });
    bsToast.show();
    
    toast.addEventListener('hidden.bs.toast', () => toast.remove());
}

// Sort Column (placeholder)
function sortColumn(columnName) {
    showToast(`Column sorting for "${columnName}" coming soon`, 'info');
}
</script>
{% endblock %}