{% extends "base.html" %}

{% block title %}Settings & Configuration - Jarvis{% endblock %}

{% block content %}
<div class="container-fluid settings-container">
    <div class="settings-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1>⚙️ Settings & Configuration</h1>
                <p>Control all aspects of your Jarvis platform with our enhanced settings interface</p>
            </div>
            <div class="d-flex gap-3 align-items-center">
                <!-- Settings Status Indicator -->
                <div class="status-card success d-none" id="settingsStatus">
                    <div class="d-flex align-items-center">
                        <div class="connection-indicator connected me-2"></div>
                        <small class="text-success fw-semibold">Settings Saved</small>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="saveAllSettings()">
                    <i class="fas fa-save me-2"></i>Save All Settings
                </button>
            </div>
        </div>
        
        <!-- Progress Indicator -->
        <div class="mt-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <small class="text-muted fw-semibold">Configuration Progress</small>
                <small class="text-muted" id="progressText">0% Complete</small>
            </div>
            <div class="progress-indicator" id="configProgress" style="--progress: 0%"></div>
        </div>
    </div>

    <!-- Settings Navigation Tabs -->
    <ul class="nav nav-tabs mb-4" id="settingsTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="database-tab" data-bs-toggle="tab" data-bs-target="#database" type="button" role="tab">
                <i class="fas fa-database me-2"></i>Database
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="visualization-tab" data-bs-toggle="tab" data-bs-target="#visualization" type="button" role="tab">
                <i class="fas fa-chart-bar me-2"></i>Visualization
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="user-tab" data-bs-toggle="tab" data-bs-target="#user" type="button" role="tab">
                <i class="fas fa-user-cog me-2"></i>User Preferences
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="views-tab" data-bs-toggle="tab" data-bs-target="#views" type="button" role="tab">
                <i class="fas fa-eye me-2"></i>Table Views
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="system-tab" data-bs-toggle="tab" data-bs-target="#system" type="button" role="tab">
                <i class="fas fa-cogs me-2"></i>System
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="security-tab" data-bs-toggle="tab" data-bs-target="#security" type="button" role="tab">
                <i class="fas fa-shield-alt me-2"></i>Security
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab">
                <i class="fas fa-users me-2"></i>User Management
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="cache-tab" data-bs-toggle="tab" data-bs-target="#cache" type="button" role="tab">
                <i class="fas fa-memory me-2"></i>Cache Management
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="settingsTabContent">
        
        <!-- Database Settings -->
        <div class="tab-pane fade show active" id="database" role="tabpanel" aria-labelledby="database-tab">
            <div class="row">
                <!-- Primary Database Connection -->
                <div class="col-lg-8">
                    <div class="card settings-card">
            <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-database me-2"></i>Primary Database Connection
                            </h5>
            </div>
            <div class="card-body">
                            <form id="databaseConfigForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="host" class="form-label">
                                    <i class="fas fa-server me-1"></i>Host
                                </label>
                                <input type="text" class="form-control" id="host" name="host" 
                                       value="{{ config.host }}" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="port" class="form-label">
                                    <i class="fas fa-plug me-1"></i>Port
                                </label>
                                <input type="number" class="form-control" id="port" name="port" 
                                       value="{{ config.port }}" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="database" class="form-label">
                            <i class="fas fa-database me-1"></i>Database Name
                        </label>
                        <input type="text" class="form-control" id="database" name="database" 
                               value="{{ config.database }}" required>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="user" class="form-label">
                                    <i class="fas fa-user me-1"></i>Username
                                </label>
                                <input type="text" class="form-control" id="user" name="user" 
                                       value="{{ config.user }}" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="password" class="form-label">
                                    <i class="fas fa-lock me-1"></i>Password
                                </label>
                                            <div class="input-group">
                                <input type="password" class="form-control" id="password" name="password" 
                                       value="{{ config.password }}" required>
                                                <button class="btn btn-outline-secondary" type="button" onclick="togglePassword()">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                            </div>
                        </div>
                    </div>
                    
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-outline-primary" onclick="testConnection()">
                            <i class="fas fa-vial me-1"></i>Test Connection
                        </button>
                                    <button type="button" class="btn btn-success" onclick="saveDatabaseConfig()">
                            <i class="fas fa-save me-1"></i>Save & Connect
                        </button>
                    </div>
                </form>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Connection Status & Info -->
                <div class="col-lg-4">
                    <div class="card settings-card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-wifi me-2 text-primary"></i>Connection Status
                            </h5>
                        </div>
                        <div class="card-body">
                            <!-- Connection Status Card -->
                            <div class="status-card" id="connectionStatusCard">
                                <div class="d-flex align-items-center justify-content-between">
                                    <div class="d-flex align-items-center">
                                        <div class="connection-indicator" id="connectionIndicator"></div>
                                        <div>
                                            <div class="fw-semibold" id="connectionText">Checking...</div>
                                            <small class="text-muted" id="connectionSubtext">Initializing connection</small>
                                        </div>
                                    </div>
                                    <div class="text-end">
                                        <small class="text-muted" id="lastUpdated">Just now</small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Database Information -->
                            <div class="mb-3">
                                <h6 class="d-flex align-items-center">
                                    <i class="fas fa-database me-2 text-info"></i>Database Information
                                </h6>
                                <div class="status-card" id="dbInfoCard">
                                    <div id="dbInfo">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-search text-muted me-2"></i>
                                            <small class="text-muted">Connect to see database details</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Quick Actions -->
                            <div class="mb-3">
                                <h6 class="d-flex align-items-center">
                                    <i class="fas fa-bolt me-2 text-warning"></i>Quick Actions
                                </h6>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-sm btn-outline-info" onclick="refreshConnection()">
                                        <i class="fas fa-sync-alt me-1"></i>Refresh Status
                                    </button>
                                    <button class="btn btn-sm btn-outline-warning" onclick="disconnectDatabase()">
                                        <i class="fas fa-unlink me-1"></i>Disconnect
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Visualization Settings -->
        <div class="tab-pane fade" id="visualization" role="tabpanel" aria-labelledby="visualization-tab">
            <div class="row">
                <div class="col-lg-6">
                    <div class="card settings-card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-chart-bar me-2 text-primary"></i>Chart Settings
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="defaultChartType" class="form-label">Default Chart Type</label>
                                <select class="form-select" id="defaultChartType">
                                    <option value="bar">Bar Chart</option>
                                    <option value="line">Line Chart</option>
                                    <option value="pie">Pie Chart</option>
                                    <option value="doughnut">Doughnut Chart</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="chartAnimation" class="form-label">Chart Animations</label>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="chartAnimation" checked>
                                    <label class="form-check-label" for="chartAnimation">
                                        Enable chart animations
                                    </label>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="chartColors" class="form-label">Color Scheme</label>
                                <select class="form-select" id="chartColors">
                                    <option value="default">Default</option>
                                    <option value="vibrant">Vibrant</option>
                                    <option value="pastel">Pastel</option>
                                    <option value="monochrome">Monochrome</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="maxDataPoints" class="form-label">Max Data Points</label>
                                <input type="number" class="form-control" id="maxDataPoints" value="100" min="10" max="1000">
                                <div class="form-text">Maximum number of data points to display in charts</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-6">
                    <div class="card settings-card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-map-marked-alt me-2 text-success"></i>Map Settings
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="mapProvider" class="form-label">Map Provider</label>
                                <select class="form-select" id="mapProvider">
                                    <option value="openstreetmap">OpenStreetMap</option>
                                    <option value="cartodb">CartoDB</option>
                                    <option value="esri">Esri</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="mapStyle" class="form-label">Map Style</label>
                                <select class="form-select" id="mapStyle">
                                    <option value="light">Light</option>
                                    <option value="dark">Dark</option>
                                    <option value="satellite">Satellite</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="markerSize" class="form-label">Default Marker Size</label>
                                <input type="range" class="form-range" id="markerSize" min="5" max="50" value="20">
                                <div class="d-flex justify-content-between">
                                    <small>Small</small>
                                    <small>Large</small>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="showMapLegend" checked>
                                    <label class="form-check-label" for="showMapLegend">
                                        Show map legend
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- User Preferences -->
        <div class="tab-pane fade" id="user" role="tabpanel" aria-labelledby="user-tab">
            <div class="row">
                <div class="col-lg-6">
                    <div class="card settings-card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-user me-2"></i>Profile Settings
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="username" class="form-label">Username</label>
                                <input type="text" class="form-control" id="username" value="{{ current_user.username }}" readonly>
                            </div>
                            
                            <div class="mb-3">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="email" value="{{ current_user.email or '' }}">
                            </div>
                            
                            <div class="mb-3">
                                <label for="fullName" class="form-label">Full Name</label>
                                <input type="text" class="form-control" id="fullName" value="{{ current_user.full_name or '' }}">
                            </div>
                            
                            <div class="mb-3">
                                <label for="timezone" class="form-label">Timezone</label>
                                <select class="form-select" id="timezone">
                                    <option value="UTC">UTC</option>
                                    <option value="America/New_York">Eastern Time</option>
                                    <option value="America/Chicago">Central Time</option>
                                    <option value="America/Denver">Mountain Time</option>
                                    <option value="America/Los_Angeles">Pacific Time</option>
                                    <option value="Europe/London">London</option>
                                    <option value="Europe/Paris">Paris</option>
                                    <option value="Asia/Tokyo">Tokyo</option>
                                    <option value="Asia/Kolkata">India</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-6">
                    <div class="card settings-card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-palette me-2"></i>Theme & Display
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="theme" class="form-label">Theme</label>
                                <select class="form-select" id="theme">
                                    <option value="light">Light</option>
                                    <option value="dark">Dark</option>
                                    <option value="auto">Auto (System)</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="language" class="form-label">Language</label>
                                <select class="form-select" id="language">
                                    <option value="en">English</option>
                                    <option value="es">Spanish</option>
                                    <option value="fr">French</option>
                                    <option value="de">German</option>
                                    <option value="zh">Chinese</option>
                                    <option value="ja">Japanese</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="dateFormat" class="form-label">Date Format</label>
                                <select class="form-select" id="dateFormat">
                                    <option value="MM/DD/YYYY">MM/DD/YYYY</option>
                                    <option value="DD/MM/YYYY">DD/MM/YYYY</option>
                                    <option value="YYYY-MM-DD">YYYY-MM-DD</option>
                                    <option value="DD-MM-YYYY">DD-MM-YYYY</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="numberFormat" class="form-label">Number Format</label>
                                <select class="form-select" id="numberFormat">
                                    <option value="US">US (1,234.56)</option>
                                    <option value="EU">European (1.234,56)</option>
                                    <option value="IN">Indian (1,23,456.78)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Table Views Configuration -->
        <div class="tab-pane fade" id="views" role="tabpanel" aria-labelledby="views-tab">
            <div class="row">
                <div class="col-12">
                    <div class="card settings-card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-eye me-2"></i>Table View Configuration
                            </h5>
                            <p class="text-muted mb-0">Customize how your table data is displayed in list and detail views</p>
                        </div>
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <h6 class="fw-semibold">
                                        <i class="fas fa-table me-2 text-primary"></i>
                                        Advanced View Customization
                                    </h6>
                                    <p class="text-muted mb-0">
                                        Configure custom table views with drag-and-drop field management, 
                                        custom column layouts, and organized detail view partitions for better data presentation.
                                    </p>
                                    <ul class="list-unstyled mt-2 mb-0">
                                        <li><i class="fas fa-check text-success me-2"></i>Drag & drop field organization</li>
                                        <li><i class="fas fa-check text-success me-2"></i>Custom primary and secondary columns</li>
                                        <li><i class="fas fa-check text-success me-2"></i>Organized detail view partitions</li>
                                        <li><i class="fas fa-check text-success me-2"></i>Live preview of changes</li>
                                    </ul>
                                </div>
                                <div class="col-md-4 text-center">
                                    <div class="d-grid gap-2">
                                        <a href="{{ url_for('view_config') }}" class="btn btn-primary btn-lg">
                                            <i class="fas fa-cog me-2"></i>Configure Table Views
                                        </a>
                                        <small class="text-muted">
                                            <i class="fas fa-info-circle me-1"></i>
                                            Requires active database connection
                                        </small>
                                    </div>
                                </div>
                            </div>

                            <!-- Display Settings -->
                            <div class="row mt-4">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">
                                                <i class="fas fa-cog me-2"></i>Display Settings
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-8">
                                                    <div class="d-flex align-items-center">
                                                        <div class="form-check form-switch me-3">
                                                            <input class="form-check-input" type="checkbox" id="showTotalCountToggle" 
                                                                   onchange="toggleRowCountDisplay()" checked>
                                                            <label class="form-check-label" for="showTotalCountToggle">
                                                                <strong>Show Total Records Count</strong>
                                                            </label>
                                                        </div>
                                                    </div>
                                                    <p class="text-muted mb-0 mt-2">
                                                        <i class="fas fa-info-circle me-1"></i>
                                                        When enabled, displays "(25 of 3251861 rows)". When disabled, shows only "(25 rows)".
                                                    </p>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="text-end">
                                                        <div class="badge bg-success" id="countToggleStatus">
                                                            <i class="fas fa-eye me-1"></i>Enabled
                                                        </div>
                                                        <br><br>
                                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="testToggle()">
                                                            Test Toggle
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Quick Status -->
                            <div class="row mt-4">
                                <div class="col-md-6">
                                    <div class="status-card status-card-info">
                                        <div class="status-card-icon">
                                            <i class="fas fa-list-ul"></i>
                                        </div>
                                        <div class="status-card-content">
                                            <h6>List View Configuration</h6>
                                            <p id="listViewStatus">Not configured - using default layout</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="status-card status-card-info">
                                        <div class="status-card-icon">
                                            <i class="fas fa-th-large"></i>
                                        </div>
                                        <div class="status-card-content">
                                            <h6>Detail View Configuration</h6>
                                            <p id="detailViewStatus">Not configured - using default partitions</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

            <!-- Detail View Layout Editor -->
            <div class="mt-4">
                <h6 class="fw-semibold">
                    <i class="fas fa-th-large me-2"></i>Current Detail View Layout
                </h6>
                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Select Table to Configure</label>
                        <select class="form-select" id="layoutTableSelect" onchange="loadTableLayout()">
                            <option value="">Select a table...</option>
                        </select>
                    </div>
                    <div class="col-md-6 d-flex align-items-end">
                        <button class="btn btn-success" onclick="addNewPartition()" id="addPartitionBtn" disabled>
                            <i class="fas fa-plus me-1"></i>Add Partition
                        </button>
                    </div>
                </div>
                
                <!-- Layout Display Area -->
                <div class="mt-3" id="layoutDisplayArea" style="display: none;">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">
                                        <i class="fas fa-list-ul me-2"></i>Available Fields
                                    </h6>
                                </div>
                                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                                    <div id="availableFieldsList">
                                        <!-- Available fields will be loaded here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">
                                        <i class="fas fa-th-large me-2"></i>Detail View Partitions
                                    </h6>
                                    <button class="btn btn-sm btn-primary" onclick="saveLayoutChanges()" id="saveLayoutBtn">
                                        <i class="fas fa-save me-1"></i>Save Changes
                                    </button>
                                </div>
                                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                                    <div id="partitionsEditor">
                                        <!-- Partitions editor will be loaded here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Configurations -->
            <div class="mt-4">
                <h6 class="fw-semibold">
                    <i class="fas fa-history me-2"></i>Recent Configurations
                </h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Table Name</th>
                                <th>Database</th>
                                <th>Last Modified</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recentConfigurationsTable">
                            <tr>
                                <td colspan="4" class="text-center text-muted">
                                    <i class="fas fa-info-circle me-2"></i>
                                    No configurations found. Start by creating your first table view configuration.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Settings -->
        <div class="tab-pane fade" id="system" role="tabpanel" aria-labelledby="system-tab">
            <div class="row">
                <div class="col-lg-6">
                    <div class="card settings-card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-server me-2"></i>Performance Settings
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="queryTimeout" class="form-label">Query Timeout (seconds)</label>
                                <input type="number" class="form-control" id="queryTimeout" value="30" min="5" max="300">
                            </div>
                            
                            <div class="mb-3">
                                <label for="maxRows" class="form-label">Max Rows per Query</label>
                                <input type="number" class="form-control" id="maxRows" value="1000" min="100" max="10000">
                            </div>
                            
                            <div class="mb-3">
                                <label for="cacheSize" class="form-label">Cache Size (MB)</label>
                                <input type="number" class="form-control" id="cacheSize" value="100" min="10" max="1000">
                            </div>
                            
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="enableCaching" checked>
                                    <label class="form-check-label" for="enableCaching">
                                        Enable query caching
                                    </label>
                                </div>
                            </div>
                        </div>
            </div>
        </div>
        
                <div class="col-lg-6">
                    <div class="card settings-card">
            <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-bell me-2"></i>Notifications
                </h5>
            </div>
            <div class="card-body">
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="emailNotifications" checked>
                                    <label class="form-check-label" for="emailNotifications">
                                        Email notifications
                                    </label>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="browserNotifications" checked>
                                    <label class="form-check-label" for="browserNotifications">
                                        Browser notifications
                                    </label>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="connectionAlerts" checked>
                                    <label class="form-check-label" for="connectionAlerts">
                                        Connection alerts
                                    </label>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="errorAlerts" checked>
                                    <label class="form-check-label" for="errorAlerts">
                                        Error alerts
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Security Settings -->
        <div class="tab-pane fade" id="security" role="tabpanel" aria-labelledby="security-tab">
            <div class="row">
                <div class="col-lg-6">
                    <div class="card settings-card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-key me-2"></i>Password & Security
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="currentPassword" class="form-label">Current Password</label>
                                <input type="password" class="form-control" id="currentPassword">
                            </div>
                            
                            <div class="mb-3">
                                <label for="newPassword" class="form-label">New Password</label>
                                <input type="password" class="form-control" id="newPassword">
                            </div>
                            
                            <div class="mb-3">
                                <label for="confirmPassword" class="form-label">Confirm New Password</label>
                                <input type="password" class="form-control" id="confirmPassword">
                            </div>
                            
                            <button class="btn btn-warning" onclick="changePassword()">
                                <i class="fas fa-key me-1"></i>Change Password
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-6">
                    <div class="card settings-card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-shield-alt me-2"></i>Session & Access
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="sessionTimeout" class="form-label">Session Timeout (minutes)</label>
                                <input type="number" class="form-control" id="sessionTimeout" value="60" min="5" max="480">
                            </div>
                            
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="requireReauth" checked>
                                    <label class="form-check-label" for="requireReauth">
                                        Require re-authentication for sensitive operations
                                    </label>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="logAccess" checked>
                                    <label class="form-check-label" for="logAccess">
                                        Log access attempts
                                    </label>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <button class="btn btn-outline-danger" onclick="clearAllSessions()">
                                    <i class="fas fa-sign-out-alt me-1"></i>Clear All Sessions
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- User Management -->
        <div class="tab-pane fade" id="users" role="tabpanel" aria-labelledby="users-tab">
            <div class="row">
                <!-- User Creation -->
                <div class="col-lg-6">
                    <div class="card settings-card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-user-plus me-2"></i>Create New User
                            </h5>
                        </div>
                        <div class="card-body">
                            <form id="createUserForm">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="userFullName" class="form-label">
                                                <i class="fas fa-user me-1"></i>Full Name
                                            </label>
                                            <input type="text" class="form-control" id="userFullName" name="full_name" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="userUsername" class="form-label">
                                                <i class="fas fa-at me-1"></i>Username
                                            </label>
                                            <input type="text" class="form-control" id="userUsername" name="username" required>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="userEmail" class="form-label">
                                                <i class="fas fa-envelope me-1"></i>Email Address
                                            </label>
                                            <input type="email" class="form-control" id="userEmail" name="email" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="userPhone" class="form-label">
                                                <i class="fas fa-phone me-1"></i>Phone Number
                                            </label>
                                            <input type="tel" class="form-control" id="userPhone" name="phone">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="userPosition" class="form-label">
                                                <i class="fas fa-briefcase me-1"></i>Position/Role
                                            </label>
                                            <input type="text" class="form-control" id="userPosition" name="position">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="userRole" class="form-label">
                                                <i class="fas fa-shield me-1"></i>Access Level
                                            </label>
                                            <select class="form-control" id="userRole" name="role" required>
                                                <option value="">Select Access Level</option>
                                                <option value="admin">Administrator</option>
                                                <option value="user">Standard User</option>
                                                <option value="viewer">Viewer Only</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Password Field (Editable with Auto-Generate) -->
                                <div class="mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-key me-1"></i>User Password
                                    </label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="generatedPassword" 
                                               placeholder="Enter custom password or click Generate">
                                        <button class="btn btn-outline-secondary" type="button" onclick="generatePassword()" 
                                                title="Generate secure password">
                                            <i class="fas fa-sync-alt"></i> Generate
                                        </button>
                                        <button class="btn btn-outline-success" type="button" onclick="togglePasswordVisibility()" 
                                                title="Toggle password visibility" id="passwordToggleBtn">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-outline-info" type="button" onclick="copyPassword()" 
                                                title="Copy password to clipboard">
                                            <i class="fas fa-copy"></i> Copy
                                        </button>
                                    </div>
                                    
                                    <!-- Password Strength Indicator -->
                                    <div class="mt-2">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <small class="text-muted">Password strength:</small>
                                            <small class="text-muted" id="passwordStrengthText">Enter a password</small>
                                        </div>
                                        <div class="progress" style="height: 4px;">
                                            <div class="progress-bar" id="passwordStrengthBar" role="progressbar" 
                                                 style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                        </div>
                                    </div>
                                    
                                    <small class="text-muted mt-1 d-block">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Type your own password or click "Generate" for a secure auto-generated one
                                    </small>
                                </div>
                                
                                <div class="d-grid gap-2">
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-user-plus me-2"></i>Create User
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- User List -->
                <div class="col-lg-6">
                    <div class="card settings-card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-users me-2"></i>Existing Users
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div class="input-group" style="max-width: 300px;">
                                    <span class="input-group-text">
                                        <i class="fas fa-search"></i>
                                    </span>
                                    <input type="text" class="form-control" id="userSearch" placeholder="Search users...">
                                </div>
                                <button class="btn btn-outline-primary btn-sm" onclick="refreshUserList()">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                            </div>
                            
                            <div id="userList">
                                <!-- Users will be loaded here -->
                                <div class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="sr-only">Loading...</span>
                                    </div>
                                    <p class="text-muted mt-2">Loading users...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- User Actions and Bulk Operations -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card settings-card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-cogs me-2"></i>User Management Actions
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="fw-semibold mb-3">Bulk Operations</h6>
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-outline-warning" onclick="resetAllPasswords()">
                                            <i class="fas fa-key me-2"></i>Reset All Passwords
                                        </button>
                                        <button class="btn btn-outline-info" onclick="exportUsers()">
                                            <i class="fas fa-download me-2"></i>Export User List
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="fw-semibold mb-3">System Stats</h6>
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="text-center">
                                                <h4 class="text-primary mb-0" id="totalUsers">0</h4>
                                                <small class="text-muted">Total Users</small>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="text-center">
                                                <h4 class="text-success mb-0" id="activeUsers">0</h4>
                                                <small class="text-muted">Active Users</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Settings management
let settings = {
    database: {},
    visualization: {},
    user: {},
    tableViews: {
        showTotalCount: true
    },
    system: {},
    security: {}
};

// Ensure settings object is always properly initialized
function initializeSettings() {
    if (!settings) {
        settings = {};
    }
    if (!settings.tableViews) {
        settings.tableViews = {};
    }
    if (settings.tableViews.showTotalCount === undefined) {
        settings.tableViews.showTotalCount = true;
    }
    console.log('Settings initialized:', settings);
}

// Toggle Row Count Display
function toggleRowCountDisplay() {
    console.log('=== toggleRowCountDisplay called ===');
    
    // Ensure settings is initialized
    initializeSettings();
    
    // Get elements
    const toggle = document.getElementById('showTotalCountToggle');
    const status = document.getElementById('countToggleStatus');
    
    console.log('Toggle element found:', !!toggle);
    console.log('Status element found:', !!status);
    console.log('Settings object:', settings);
    console.log('Settings.tableViews:', settings.tableViews);
    
    if (!toggle) {
        console.error('Toggle element not found!');
        alert('Toggle element not found!');
        return;
    }
    
    if (!status) {
        console.error('Status element not found!');
        alert('Status element not found!');
        return;
    }
    
    console.log('Toggle checked state:', toggle.checked);
    
    // Update settings
    settings.tableViews.showTotalCount = toggle.checked;
    
    // Update status badge
    if (toggle.checked) {
        status.className = 'badge bg-success';
        status.innerHTML = '<i class="fas fa-eye me-1"></i>Enabled';
        console.log('Status updated to: Enabled');
    } else {
        status.className = 'badge bg-secondary';
        status.innerHTML = '<i class="fas fa-eye-slash me-1"></i>Disabled';
        console.log('Status updated to: Disabled');
    }
    
    // Save to localStorage
    localStorage.setItem('showTotalCount', toggle.checked.toString());
    console.log('Saved to localStorage:', toggle.checked);
    
    // Show alert for testing
    alert(`Toggle changed to: ${toggle.checked ? 'Enabled' : 'Disabled'}`);
    
    // Notify other pages of the change
    try {
        window.dispatchEvent(new CustomEvent('rowCountSettingChanged', {
            detail: { showTotalCount: toggle.checked }
        }));
        console.log('Custom event dispatched');
    } catch (e) {
        console.error('Error dispatching custom event:', e);
    }
    
    console.log('=== toggleRowCountDisplay completed ===');
}

// Test Toggle Function
function testToggle() {
    console.log('=== testToggle called ===');
    const toggle = document.getElementById('showTotalCountToggle');
    
    if (toggle) {
        console.log('Current toggle state:', toggle.checked);
        toggle.checked = !toggle.checked;
        console.log('New toggle state:', toggle.checked);
        toggleRowCountDisplay();
    } else {
        console.error('Toggle element not found for test!');
        alert('Toggle element not found!');
    }
}

// Show Settings Status
function showSettingsStatus(message, type = 'success') {
    // Simple alert for now - can be enhanced with toast notifications later
    console.log(`${type.toUpperCase()}: ${message}`);
    
    // Update the status indicator if it exists
    const statusCard = document.getElementById('settingsStatus');
    if (statusCard) {
        statusCard.classList.remove('d-none');
        statusCard.querySelector('small').textContent = message;
        
        // Hide after 3 seconds
        setTimeout(() => {
            statusCard.classList.add('d-none');
        }, 3000);
    }
}

// Load Toggle State
function loadToggleState() {
    console.log('=== loadToggleState called ===');
    
    // Ensure settings is initialized
    initializeSettings();
    
    // Wait a bit for DOM to be ready
    setTimeout(() => {
        const toggle = document.getElementById('showTotalCountToggle');
        const status = document.getElementById('countToggleStatus');
        
        console.log('Toggle element found:', !!toggle);
        console.log('Status element found:', !!status);
        
        if (!toggle) {
            console.error('Toggle element not found in loadToggleState!');
            return;
        }
        
        if (!status) {
            console.error('Status element not found in loadToggleState!');
            return;
        }
        
        const savedState = localStorage.getItem('showTotalCount');
        console.log('Saved state from localStorage:', savedState);
        
        if (savedState !== null) {
            toggle.checked = savedState === 'true';
            settings.tableViews.showTotalCount = toggle.checked;
            console.log('Set toggle checked to:', toggle.checked);
        } else {
            console.log('No saved state, using default (checked)');
            toggle.checked = true;
            settings.tableViews.showTotalCount = true;
        }
        
        // Update status badge
        if (toggle.checked) {
            status.className = 'badge bg-success';
            status.innerHTML = '<i class="fas fa-eye me-1"></i>Enabled';
        } else {
            status.className = 'badge bg-secondary';
            status.innerHTML = '<i class="fas fa-eye-slash me-1"></i>Disabled';
        }
        console.log('Status badge updated');
        console.log('=== loadToggleState completed ===');
    }, 100);
}

// Initialize settings on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('Settings page loaded successfully');
    
    // Initialize settings object first
    initializeSettings();
    
    // Initialize tab functionality
    initializeTabs();
    
    // Load toggle state
    loadToggleState();
    
    // Add multiple event listeners for toggle
    setTimeout(() => {
        const toggle = document.getElementById('showTotalCountToggle');
        if (toggle) {
            console.log('Adding event listeners to toggle');
            
            // Change event
            toggle.addEventListener('change', function() {
                console.log('Toggle change event fired');
                toggleRowCountDisplay();
            });
            
            // Click event
            toggle.addEventListener('click', function() {
                console.log('Toggle click event fired');
                setTimeout(() => {
                    toggleRowCountDisplay();
                }, 10);
            });
            
            // Input event
            toggle.addEventListener('input', function() {
                console.log('Toggle input event fired');
                toggleRowCountDisplay();
            });
            
        } else {
            console.error('Toggle element not found for event listener');
        }
    }, 200);
    
    loadSettings();
    checkConnectionStatus();
    updateConfigProgress();
    
    // Add event listeners for real-time updates
    document.querySelectorAll('input, select').forEach(element => {
        element.addEventListener('change', function() {
            updateSettings();
            updateConfigProgress();
        });
    });
    
    // Initialize enhanced status updates
    setInterval(updateLastUpdatedTime, 30000); // Update every 30 seconds
});

// Initialize tab functionality
function initializeTabs() {
    const tabLinks = document.querySelectorAll('.nav-tabs .nav-link');
    const tabPanes = document.querySelectorAll('.tab-pane');
    
    console.log('Initializing tabs:', tabLinks.length, 'links and', tabPanes.length, 'panes');
    
    // Hide all tab panes initially
    tabPanes.forEach(pane => {
        pane.classList.remove('show', 'active');
        pane.style.display = 'none';
    });
    
    // Show only the first tab pane
    if (tabPanes.length > 0) {
        tabPanes[0].classList.add('show', 'active');
        tabPanes[0].style.display = 'block';
    }
    
    // Add click event listeners to tab links
    tabLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Remove active class from all links
            tabLinks.forEach(l => l.classList.remove('active'));
            
            // Add active class to clicked link
            this.classList.add('active');
            
            // Get target tab pane
            const targetId = this.getAttribute('data-bs-target');
            const targetPane = document.querySelector(targetId);
            
            if (targetPane) {
                // Hide all panes
                tabPanes.forEach(pane => {
                    pane.classList.remove('show', 'active');
                    pane.style.display = 'none';
                });
                
                // Show target pane
                targetPane.classList.add('show', 'active');
                targetPane.style.display = 'block';
                
                console.log('Switched to tab:', targetId);
            }
        });
    });
}

// Load settings from localStorage or server
function loadSettings() {
    const savedSettings = localStorage.getItem('postgresqlViewerSettings');
    if (savedSettings) {
        settings = JSON.parse(savedSettings);
        applySettings();
    }
}

// Save settings to localStorage
function saveSettings() {
    localStorage.setItem('postgresqlViewerSettings', JSON.stringify(settings));
}

// Apply settings to form elements
function applySettings() {
    // Database settings
    if (settings.database.host) document.getElementById('host').value = settings.database.host;
    if (settings.database.port) document.getElementById('port').value = settings.database.port;
    if (settings.database.database) document.getElementById('database').value = settings.database.database;
    if (settings.database.user) document.getElementById('user').value = settings.database.user;
    
    // Visualization settings
    if (settings.visualization.defaultChartType) document.getElementById('defaultChartType').value = settings.visualization.defaultChartType;
    if (settings.visualization.chartAnimation !== undefined) document.getElementById('chartAnimation').checked = settings.visualization.chartAnimation;
    if (settings.visualization.chartColors) document.getElementById('chartColors').value = settings.visualization.chartColors;
    if (settings.visualization.maxDataPoints) document.getElementById('maxDataPoints').value = settings.visualization.maxDataPoints;
    
    // User settings
    if (settings.user.email) document.getElementById('email').value = settings.user.email;
    if (settings.user.fullName) document.getElementById('fullName').value = settings.user.fullName;
    if (settings.user.timezone) document.getElementById('timezone').value = settings.user.timezone;
    if (settings.user.theme) document.getElementById('theme').value = settings.user.theme;
    if (settings.user.language) document.getElementById('language').value = settings.user.language;
    if (settings.user.dateFormat) document.getElementById('dateFormat').value = settings.user.dateFormat;
    if (settings.user.numberFormat) document.getElementById('numberFormat').value = settings.user.numberFormat;
    
    // System settings
    if (settings.system.queryTimeout) document.getElementById('queryTimeout').value = settings.system.queryTimeout;
    if (settings.system.maxRows) document.getElementById('maxRows').value = settings.system.maxRows;
    if (settings.system.cacheSize) document.getElementById('cacheSize').value = settings.system.cacheSize;
    if (settings.system.enableCaching !== undefined) document.getElementById('enableCaching').checked = settings.system.enableCaching;
    
    // Security settings
    if (settings.security.sessionTimeout) document.getElementById('sessionTimeout').value = settings.security.sessionTimeout;
    if (settings.security.requireReauth !== undefined) document.getElementById('requireReauth').checked = settings.security.requireReauth;
    if (settings.security.logAccess !== undefined) document.getElementById('logAccess').checked = settings.security.logAccess;
}

// Update settings object from form
function updateSettings() {
    settings.database = {
        host: document.getElementById('host').value,
        port: parseInt(document.getElementById('port').value),
        database: document.getElementById('database').value,
        user: document.getElementById('user').value,
        password: document.getElementById('password').value
    };
    
    settings.visualization = {
        defaultChartType: document.getElementById('defaultChartType').value,
        chartAnimation: document.getElementById('chartAnimation').checked,
        chartColors: document.getElementById('chartColors').value,
        maxDataPoints: parseInt(document.getElementById('maxDataPoints').value)
    };
    
    settings.user = {
        email: document.getElementById('email').value,
        fullName: document.getElementById('fullName').value,
        timezone: document.getElementById('timezone').value,
        theme: document.getElementById('theme').value,
        language: document.getElementById('language').value,
        dateFormat: document.getElementById('dateFormat').value,
        numberFormat: document.getElementById('numberFormat').value
    };
    
    settings.system = {
        queryTimeout: parseInt(document.getElementById('queryTimeout').value),
        maxRows: parseInt(document.getElementById('maxRows').value),
        cacheSize: parseInt(document.getElementById('cacheSize').value),
        enableCaching: document.getElementById('enableCaching').checked
    };
    
    settings.security = {
        sessionTimeout: parseInt(document.getElementById('sessionTimeout').value),
        requireReauth: document.getElementById('requireReauth').checked,
        logAccess: document.getElementById('logAccess').checked
    };
    
    saveSettings();
}

// Enhanced test database connection with visual feedback
async function testConnection() {
    const formData = new FormData(document.getElementById('databaseConfigForm'));
    const config = Object.fromEntries(formData);
    
    // Show connecting status
    const indicator = document.getElementById('connectionIndicator');
    const text = document.getElementById('connectionText');
    const subtext = document.getElementById('connectionSubtext');
    const statusCard = document.getElementById('connectionStatusCard');
    
    // Set connecting state
    statusCard.classList.remove('success', 'error');
    statusCard.classList.add('warning');
    indicator.className = 'connection-indicator connecting';
    text.textContent = 'Testing...';
    subtext.textContent = 'Verifying database connection';
    
    try {
        const response = await fetch('/api/test_connection', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(config)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('Connection successful!', 'success');
            updateConnectionStatus(true, result.message);
        } else {
            showAlert('Connection failed: ' + result.message, 'danger');
            updateConnectionStatus(false, result.message);
        }
    } catch (error) {
        showAlert('Error testing connection: ' + error.message, 'danger');
        updateConnectionStatus(false, error.message);
    }
}

// Save database configuration
async function saveDatabaseConfig() {
    updateSettings();
    
    try {
        const response = await fetch('/api/save_config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(settings.database)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('Database configuration saved successfully!', 'success');
            updateConnectionStatus(true, 'Connected');
        } else {
            showAlert('Failed to save configuration: ' + result.message, 'danger');
        }
    } catch (error) {
        showAlert('Error saving configuration: ' + error.message, 'danger');
    }
}

// Check connection status
async function checkConnectionStatus() {
    try {
        const response = await fetch('/api/connection/status');
        const result = await response.json();
        
        updateConnectionStatus(result.success, result.message);
        
        if (result.success && result.db_info) {
            updateDatabaseInfo(result.db_info);
        }
    } catch (error) {
        updateConnectionStatus(false, 'Error checking status');
    }
}

// Enhanced connection status display
function updateConnectionStatus(connected, message) {
    const indicator = document.getElementById('connectionIndicator');
    const text = document.getElementById('connectionText');
    const subtext = document.getElementById('connectionSubtext');
    const statusCard = document.getElementById('connectionStatusCard');
    
    // Remove existing status classes
    statusCard.classList.remove('success', 'warning', 'error');
    
    if (connected) {
        indicator.className = 'connection-indicator connected';
        text.textContent = 'Connected';
        subtext.textContent = 'Database connection is active';
        statusCard.classList.add('success');
    } else {
        indicator.className = 'connection-indicator disconnected';
        text.textContent = 'Disconnected';
        subtext.textContent = message || 'No database connection';
        statusCard.classList.add('error');
    }
    
    updateLastUpdatedTime();
}

// Update configuration progress
function updateConfigProgress() {
    const requiredFields = ['host', 'port', 'database', 'user', 'password'];
    let filledFields = 0;
    
    requiredFields.forEach(field => {
        const element = document.getElementById(field);
        if (element && element.value.trim()) {
            filledFields++;
        }
    });
    
    const progress = (filledFields / requiredFields.length) * 100;
    const progressBar = document.getElementById('configProgress');
    const progressText = document.getElementById('progressText');
    
    progressBar.style.setProperty('--progress', `${progress}%`);
    progressText.textContent = `${Math.round(progress)}% Complete`;
    
    // Update progress bar color based on completion
    if (progress === 100) {
        progressBar.classList.remove('warning');
        progressBar.classList.add('success');
    } else if (progress > 0) {
        progressBar.classList.remove('success');
        progressBar.classList.add('warning');
    } else {
        progressBar.classList.remove('success', 'warning');
    }
}

// Update last updated timestamp
function updateLastUpdatedTime() {
    const lastUpdated = document.getElementById('lastUpdated');
    if (lastUpdated) {
        const now = new Date();
        lastUpdated.textContent = now.toLocaleTimeString();
    }
}

// Show settings saved status
function showSettingsSaved() {
    const statusIndicator = document.getElementById('settingsStatus');
    statusIndicator.classList.remove('d-none');
    
    setTimeout(() => {
        statusIndicator.classList.add('d-none');
    }, 3000);
}

// Enhanced database information display
function updateDatabaseInfo(dbInfo) {
    const dbInfoDiv = document.getElementById('dbInfo');
    const dbInfoCard = document.getElementById('dbInfoCard');
    
    // Remove existing status classes
    dbInfoCard.classList.remove('success', 'warning', 'error');
    dbInfoCard.classList.add('success');
    
    dbInfoDiv.innerHTML = `
        <div class="row g-2">
            <div class="col-6">
                <div class="d-flex align-items-center">
                    <i class="fas fa-info-circle text-info me-2"></i>
                    <div>
                        <small class="text-muted">Version</small>
                        <div class="fw-semibold small">${dbInfo.version || 'Unknown'}</div>
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div class="d-flex align-items-center">
                    <i class="fas fa-table text-primary me-2"></i>
                    <div>
                        <small class="text-muted">Tables</small>
                        <div class="fw-semibold small">${dbInfo.table_count || 0}</div>
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div class="d-flex align-items-center">
                    <i class="fas fa-hdd text-warning me-2"></i>
                    <div>
                        <small class="text-muted">Size</small>
                        <div class="fw-semibold small">${dbInfo.size || 'Unknown'}</div>
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div class="d-flex align-items-center">
                    <i class="fas fa-clock text-success me-2"></i>
                    <div>
                        <small class="text-muted">Updated</small>
                        <div class="fw-semibold small">${new Date().toLocaleTimeString()}</div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Toggle password visibility
function togglePassword() {
    const passwordInput = document.getElementById('password');
    const toggleButton = passwordInput.nextElementSibling;
    const icon = toggleButton.querySelector('i');
    
    if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        icon.className = 'fas fa-eye-slash';
    } else {
        passwordInput.type = 'password';
        icon.className = 'fas fa-eye';
    }
}

// Enhanced save all settings with visual feedback
function saveAllSettings() {
    updateSettings();
    showSettingsSaved();
    showAlert('All settings saved successfully!', 'success');
    
    // Trigger a brief animation on the save button
    const saveBtn = event.target;
    saveBtn.classList.add('btn-success');
    saveBtn.innerHTML = '<i class="fas fa-check me-2"></i>Saved!';
    
    setTimeout(() => {
        saveBtn.classList.remove('btn-success');
        saveBtn.classList.add('btn-primary');
        saveBtn.innerHTML = '<i class="fas fa-save me-2"></i>Save All Settings';
    }, 2000);
}

// Show alert
function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.insertBefore(alertDiv, document.body.firstChild);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.parentNode.removeChild(alertDiv);
        }
    }, 5000);
}

// Refresh connection
function refreshConnection() {
    checkConnectionStatus();
}

// Disconnect database
async function disconnectDatabase() {
    try {
        const response = await fetch('/api/disconnect', { method: 'POST' });
        const result = await response.json();
        
        if (result.success) {
            updateConnectionStatus(false, 'Disconnected');
            showAlert('Database disconnected successfully', 'info');
        } else {
            showAlert('Failed to disconnect: ' + result.message, 'danger');
        }
    } catch (error) {
        showAlert('Error disconnecting: ' + error.message, 'danger');
    }
}

// Change password
async function changePassword() {
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    
    if (!currentPassword || !newPassword || !confirmPassword) {
        showAlert('Please fill in all password fields', 'warning');
        return;
    }
    
    if (newPassword !== confirmPassword) {
        showAlert('New passwords do not match', 'warning');
        return;
    }
    
    if (newPassword.length < 8) {
        showAlert('New password must be at least 8 characters long', 'warning');
        return;
    }
    
    try {
        const response = await fetch('/api/change_password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                currentPassword,
                newPassword
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('Password changed successfully!', 'success');
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        } else {
            showAlert('Failed to change password: ' + result.message, 'danger');
        }
    } catch (error) {
        showAlert('Error changing password: ' + error.message, 'danger');
    }
}

// Clear all sessions
async function clearAllSessions() {
    if (!confirm('Are you sure you want to clear all sessions? This will log out all users.')) {
        return;
    }
    
    try {
        const response = await fetch('/api/clear_sessions', { method: 'POST' });
        const result = await response.json();
        
        if (result.success) {
            showAlert('All sessions cleared successfully', 'success');
        } else {
            showAlert('Failed to clear sessions: ' + result.message, 'danger');
        }
    } catch (error) {
        showAlert('Error clearing sessions: ' + error.message, 'danger');
    }
}

// Load view configuration status
function loadViewConfigurationStatus() {
    // Check if we have view configurations
    fetch('/api/view-config/status')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateViewConfigurationStatus(data.configurations);
            }
        })
        .catch(error => {
            console.log('View configuration status not available');
        });
}

// Update view configuration status display
function updateViewConfigurationStatus(configurations) {
    const listViewStatus = document.getElementById('listViewStatus');
    const detailViewStatus = document.getElementById('detailViewStatus');
    const recentConfigurationsTable = document.getElementById('recentConfigurationsTable');

    if (configurations && configurations.length > 0) {
        // Update status indicators
        listViewStatus.textContent = `${configurations.length} table(s) configured`;
        detailViewStatus.textContent = `${configurations.length} table(s) configured`;
        
        // Update recent configurations table
        recentConfigurationsTable.innerHTML = '';
        configurations.slice(0, 5).forEach(config => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${config.table_name}</td>
                <td>${config.database_name || 'Current Database'}</td>
                <td>${new Date(config.updated_at * 1000).toLocaleDateString()}</td>
                <td>
                    <a href="/view-config" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-edit"></i> Edit
                    </a>
                </td>
            `;
            recentConfigurationsTable.appendChild(row);
        });
    }
}

// Global variables for layout editor
let currentDatabaseId = null;
let currentTableName = null;
let currentTableColumns = [];
let currentLayoutConfig = null;
let layoutEditorInitialized = false;

// Load available tables for layout configuration
function loadTablesForLayout() {
    // Get current database info and load tables
    fetch('/api/tables')
        .then(response => response.json())
        .then(data => {
            const tableSelect = document.getElementById('layoutTableSelect');
            tableSelect.innerHTML = '<option value="">Select a table...</option>';
            
            if (data.success && data.tables) {
                data.tables.forEach(table => {
                    tableSelect.innerHTML += `<option value="${table}">${table}</option>`;
                });
            }
        })
        .catch(error => {
            console.error('Error loading tables:', error);
        });
}

// Load table layout configuration
function loadTableLayout() {
    const tableSelect = document.getElementById('layoutTableSelect');
    const tableName = tableSelect.value;
    
    if (!tableName) {
        document.getElementById('layoutDisplayArea').style.display = 'none';
        document.getElementById('addPartitionBtn').disabled = true;
        return;
    }
    
    currentTableName = tableName;
    document.getElementById('addPartitionBtn').disabled = false;
    
    // Load table columns
    fetch(`/api/table/${tableName}/columns`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                currentTableColumns = data.columns.map(col => ({
                    name: col.column_name,
                    type: col.data_type
                }));
                
                // Load existing configuration
                loadExistingConfiguration(tableName);
            }
        })
        .catch(error => {
            console.error('Error loading table columns:', error);
            showAlert('Error loading table columns', 'danger');
        });
}

// Load existing configuration for the table
function loadExistingConfiguration(tableName) {
    // First get current database ID
    fetch('/api/view-config/status')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                currentDatabaseId = data.current_database_id;
                
                if (!currentDatabaseId) {
                    throw new Error('No current database connected');
                }
                
                // Try to load existing configuration
                return fetch(`/api/view-config/load/${currentDatabaseId}/${tableName}`);
            }
        })
        .then(response => {
            if (response && response.ok) {
                return response.json();
            } else {
                // No existing configuration, create default
                return {
                    configuration: {
                        detail: {
                            partitions: [
                                {
                                    name: "General Information",
                                    fields: []
                                }
                            ]
                        }
                    }
                };
            }
        })
        .then(data => {
            currentLayoutConfig = data.configuration;
            displayLayoutEditor();
        })
        .catch(error => {
            console.error('Error loading configuration:', error);
            // Create default configuration
            currentLayoutConfig = {
                detail: {
                    partitions: [
                        {
                            name: "General Information",
                            fields: []
                        }
                    ]
                }
            };
            displayLayoutEditor();
        });
}

// Display the layout editor
function displayLayoutEditor() {
    document.getElementById('layoutDisplayArea').style.display = 'block';
    
    // Populate available fields
    populateAvailableFields();
    
    // Populate partitions editor
    populatePartitionsEditor();
    
    // Initialize drag and drop if not already done
    if (!layoutEditorInitialized) {
        initializeLayoutDragDrop();
        layoutEditorInitialized = true;
    }
}

// Populate available fields list
function populateAvailableFields() {
    const container = document.getElementById('availableFieldsList');
    const usedFields = new Set();
    
    // Collect already used fields
    if (currentLayoutConfig.detail && currentLayoutConfig.detail.partitions) {
        currentLayoutConfig.detail.partitions.forEach(partition => {
            partition.fields.forEach(field => usedFields.add(field));
        });
    }
    
    // Display available fields
    container.innerHTML = '';
    currentTableColumns.forEach(column => {
        if (!usedFields.has(column.name)) {
            const fieldElement = createDraggableField(column);
            container.appendChild(fieldElement);
        }
    });
    
    if (container.children.length === 0) {
        container.innerHTML = '<div class="text-muted text-center">All fields are assigned to partitions</div>';
    }
}

// Create draggable field element
function createDraggableField(column) {
    const fieldDiv = document.createElement('div');
    fieldDiv.className = 'draggable-field mb-2';
    fieldDiv.draggable = true;
    fieldDiv.dataset.fieldName = column.name;
    fieldDiv.dataset.fieldType = column.type;
    
    fieldDiv.innerHTML = `
        <div class="d-flex justify-content-between align-items-center p-2 border rounded">
            <div>
                <strong>${column.name}</strong>
                <small class="text-muted d-block">${column.type}</small>
            </div>
            <i class="fas fa-grip-vertical text-muted"></i>
        </div>
    `;
    
    // Add drag event listeners
    fieldDiv.addEventListener('dragstart', handleFieldDragStart);
    fieldDiv.addEventListener('dragend', handleFieldDragEnd);
    
    return fieldDiv;
}

// Populate partitions editor
function populatePartitionsEditor() {
    const container = document.getElementById('partitionsEditor');
    container.innerHTML = '';
    
    if (currentLayoutConfig.detail && currentLayoutConfig.detail.partitions) {
        currentLayoutConfig.detail.partitions.forEach((partition, index) => {
            const partitionElement = createPartitionElement(partition, index);
            container.appendChild(partitionElement);
        });
    }
}

// Create partition element
function createPartitionElement(partition, index) {
    const partitionDiv = document.createElement('div');
    partitionDiv.className = 'partition-editor mb-3';
    partitionDiv.dataset.partitionIndex = index;
    
    partitionDiv.innerHTML = `
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <input type="text" class="form-control partition-name-input" value="${partition.name}" 
                           onchange="updatePartitionName(${index}, this.value)">
                    <button class="btn btn-sm btn-outline-danger ms-2" onclick="removePartition(${index})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="card-body partition-drop-zone" data-partition-index="${index}">
                <div class="partition-fields">
                    ${partition.fields.map(field => createAssignedFieldElement(field)).join('')}
                </div>
                <div class="drop-placeholder ${partition.fields.length > 0 ? 'd-none' : ''}">
                    <i class="fas fa-plus-circle"></i>
                    <span>Drop fields here</span>
                </div>
            </div>
        </div>
    `;
    
    return partitionDiv;
}

// Create assigned field element
function createAssignedFieldElement(fieldName) {
    const fieldData = currentTableColumns.find(col => col.name === fieldName);
    return `
        <div class="assigned-field d-flex justify-content-between align-items-center p-2 mb-2 bg-light border rounded" 
             data-field-name="${fieldName}">
            <div>
                <strong>${fieldName}</strong>
                <small class="text-muted d-block">${fieldData ? fieldData.type : 'unknown'}</small>
            </div>
            <button class="btn btn-sm btn-outline-danger" onclick="removeFieldFromPartition('${fieldName}')">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
}

// Initialize drag and drop functionality
function initializeLayoutDragDrop() {
    // This will be called when partitions are populated
    document.addEventListener('dragover', handleDragOver);
    document.addEventListener('drop', handleDrop);
}

// Drag and drop event handlers
function handleFieldDragStart(e) {
    e.dataTransfer.setData('text/plain', e.target.dataset.fieldName);
    e.target.classList.add('dragging');
}

function handleFieldDragEnd(e) {
    e.target.classList.remove('dragging');
}

function handleDragOver(e) {
    e.preventDefault();
}

function handleDrop(e) {
    e.preventDefault();
    const fieldName = e.dataTransfer.getData('text/plain');
    const dropZone = e.target.closest('.partition-drop-zone');
    
    if (!dropZone || !fieldName) return;
    
    const partitionIndex = parseInt(dropZone.dataset.partitionIndex);
    addFieldToPartition(fieldName, partitionIndex);
}

// Add field to partition
function addFieldToPartition(fieldName, partitionIndex) {
    if (!currentLayoutConfig.detail.partitions[partitionIndex]) return;
    
    // Remove from current partition if it exists
    removeFieldFromAllPartitions(fieldName);
    
    // Add to new partition
    currentLayoutConfig.detail.partitions[partitionIndex].fields.push(fieldName);
    
    // Refresh the display
    populateAvailableFields();
    populatePartitionsEditor();
}

// Remove field from partition
function removeFieldFromPartition(fieldName) {
    removeFieldFromAllPartitions(fieldName);
    populateAvailableFields();
    populatePartitionsEditor();
}

// Remove field from all partitions
function removeFieldFromAllPartitions(fieldName) {
    currentLayoutConfig.detail.partitions.forEach(partition => {
        const index = partition.fields.indexOf(fieldName);
        if (index > -1) {
            partition.fields.splice(index, 1);
        }
    });
}

// Add new partition
function addNewPartition() {
    if (!currentLayoutConfig.detail.partitions) {
        currentLayoutConfig.detail.partitions = [];
    }
    
    currentLayoutConfig.detail.partitions.push({
        name: "New Partition",
        fields: []
    });
    
    populatePartitionsEditor();
}

// Remove partition
function removePartition(index) {
    if (currentLayoutConfig.detail.partitions.length <= 1) {
        showAlert('At least one partition is required', 'warning');
        return;
    }
    
    // Move fields back to available
    const partition = currentLayoutConfig.detail.partitions[index];
    // Fields will automatically become available when partition is removed
    
    currentLayoutConfig.detail.partitions.splice(index, 1);
    populateAvailableFields();
    populatePartitionsEditor();
}

// Update partition name
function updatePartitionName(index, newName) {
    if (currentLayoutConfig.detail.partitions[index]) {
        currentLayoutConfig.detail.partitions[index].name = newName;
    }
}

// Save layout changes
function saveLayoutChanges() {
    if (!currentDatabaseId || !currentTableName) {
        showAlert('Please select a table first', 'warning');
        return;
    }
    
    const configData = {
        database_id: currentDatabaseId,
        table_name: currentTableName,
        configuration: currentLayoutConfig
    };
    
    fetch('/api/view-config/save', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(configData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Layout configuration saved successfully!', 'success');
            loadViewConfigurationStatus(); // Refresh the status
        } else {
            showAlert('Error saving configuration: ' + (data.error || 'Unknown error'), 'danger');
        }
    })
    .catch(error => {
        console.error('Error saving configuration:', error);
        showAlert('Error saving configuration', 'danger');
    });
}

// Get current database ID from status API
function getCurrentDatabaseId() {
    // Return the stored database ID if available
    if (currentDatabaseId) {
        return currentDatabaseId;
    }
    
    // Fetch from server if not available
    fetch('/api/view-config/status')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.configurations.length > 0) {
                // Find a configuration for the current database
                const currentConfig = data.configurations.find(config => config.is_current);
                if (currentConfig) {
                    currentDatabaseId = currentConfig.database_id;
                }
            }
        })
        .catch(error => {
            console.error('Error getting current database ID:', error);
        });
        
    return currentDatabaseId || 'unknown';
}

// User Management Functions
function generatePassword() {
    const length = 12;
    const charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*";
    let password = "";
    
    // Ensure at least one of each type
    password += "ABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(Math.random() * 26)]; // Uppercase
    password += "abcdefghijklmnopqrstuvwxyz"[Math.floor(Math.random() * 26)]; // Lowercase
    password += "0123456789"[Math.floor(Math.random() * 10)]; // Number
    password += "!@#$%^&*"[Math.floor(Math.random() * 8)]; // Special
    
    // Fill the rest
    for (let i = 4; i < length; i++) {
        password += charset[Math.floor(Math.random() * charset.length)];
    }
    
    // Shuffle the password
    password = password.split('').sort(() => 0.5 - Math.random()).join('');
    
    document.getElementById('generatedPassword').value = password;
    
    // Check strength of generated password
    checkPasswordStrength(password);
}

function copyPassword() {
    const passwordField = document.getElementById('generatedPassword');
    if (!passwordField.value) {
        showToast('Please enter or generate a password first', 'warning');
        return;
    }
    
    passwordField.select();
    passwordField.setSelectionRange(0, 99999); // For mobile devices
    
    try {
        document.execCommand('copy');
        showToast('Password copied to clipboard!', 'success');
    } catch (err) {
        console.error('Failed to copy password:', err);
        showToast('Failed to copy password', 'error');
    }
}

function togglePasswordVisibility() {
    const passwordField = document.getElementById('generatedPassword');
    const toggleBtn = document.getElementById('passwordToggleBtn');
    const icon = toggleBtn.querySelector('i');
    
    if (passwordField.type === 'password') {
        passwordField.type = 'text';
        icon.className = 'fas fa-eye-slash';
        toggleBtn.title = 'Hide password';
    } else {
        passwordField.type = 'password';
        icon.className = 'fas fa-eye';
        toggleBtn.title = 'Show password';
    }
}

function checkPasswordStrength(password) {
    const strengthBar = document.getElementById('passwordStrengthBar');
    const strengthText = document.getElementById('passwordStrengthText');
    
    if (!password) {
        strengthBar.style.width = '0%';
        strengthBar.className = 'progress-bar';
        strengthText.textContent = 'Enter a password';
        return;
    }
    
    let score = 0;
    let feedback = '';
    
    // Length check
    if (password.length >= 8) score += 25;
    if (password.length >= 12) score += 10;
    
    // Character variety checks
    if (/[a-z]/.test(password)) score += 15;
    if (/[A-Z]/.test(password)) score += 15;
    if (/[0-9]/.test(password)) score += 15;
    if (/[^A-Za-z0-9]/.test(password)) score += 20;
    
    // Set strength level and styling
    if (score < 30) {
        strengthBar.className = 'progress-bar bg-danger';
        strengthBar.style.width = '25%';
        feedback = 'Weak';
    } else if (score < 60) {
        strengthBar.className = 'progress-bar bg-warning';
        strengthBar.style.width = '50%';
        feedback = 'Fair';
    } else if (score < 80) {
        strengthBar.className = 'progress-bar bg-info';
        strengthBar.style.width = '75%';
        feedback = 'Good';
    } else {
        strengthBar.className = 'progress-bar bg-success';
        strengthBar.style.width = '100%';
        feedback = 'Strong';
    }
    
    strengthText.textContent = feedback;
}

function createUser() {
    console.log('createUser function called');
    
    const form = document.getElementById('createUserForm');
    if (!form) {
        console.error('Form not found');
        showToast('Form not found', 'error');
        return false;
    }
    
    const formData = new FormData(form);
    const password = document.getElementById('generatedPassword').value;
    
    console.log('Password value:', password);
    
    if (!password) {
        showToast('Please enter a password or click Generate', 'warning');
        return false;
    }
    
    if (password.length < 6) {
        showToast('Password must be at least 6 characters long', 'warning');
        return false;
    }
    
    const userData = {
        full_name: formData.get('full_name'),
        username: formData.get('username'),
        email: formData.get('email'),
        phone: formData.get('phone'),
        position: formData.get('position'),
        role: formData.get('role'),
        password: password
    };
    
    console.log('User data collected:', userData);
    
    // Validate required fields
    if (!userData.full_name || !userData.username || !userData.email || !userData.role) {
        showToast('Please fill in all required fields (Name, Username, Email, Role)', 'warning');
        return false;
    }
    
    // Validate email format
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(userData.email)) {
        showToast('Please enter a valid email address', 'warning');
        return false;
    }
    
    console.log('Sending user creation request...');
    
    fetch('/api/users/create', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(userData)
    })
    .then(response => {
        console.log('Response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        return response.json();
    })
    .then(result => {
        console.log('API response:', result);
        if (result.success) {
            showToast('User created successfully!', 'success');
            form.reset();
            document.getElementById('generatedPassword').value = '';
            checkPasswordStrength(''); // Reset password strength indicator
            refreshUserList();
        } else {
            showToast('Failed to create user: ' + result.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error creating user:', error);
        showToast('Error creating user: ' + error.message, 'error');
    });
    
    return false;
}

function showToast(message, type = 'info') {
    // Remove any existing toasts
    const existingToast = document.querySelector('.toast-notification');
    if (existingToast) {
        existingToast.remove();
    }
    
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `toast-notification alert alert-${type === 'error' ? 'danger' : type === 'warning' ? 'warning' : type === 'success' ? 'success' : 'info'} alert-dismissible fade show`;
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    `;
    
    toast.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fas fa-${type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : type === 'success' ? 'check-circle' : 'info-circle'} me-2"></i>
            <div class="flex-grow-1">${message}</div>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `;
    
    // Add to page
    document.body.appendChild(toast);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (toast && toast.parentNode) {
            toast.remove();
        }
    }, 5000);
}

function refreshUserList() {
    const userList = document.getElementById('userList');
    userList.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="sr-only">Loading...</span>
            </div>
            <p class="text-muted mt-2">Loading users...</p>
        </div>
    `;
    
    fetch('/api/users/list')
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                displayUserList(result.users);
                updateUserStats(result.users);
            } else {
                userList.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Failed to load users: ${result.error}
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading users:', error);
            userList.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error loading users: ${error.message}
                </div>
            `;
        });
}

function displayUserList(users) {
    const userList = document.getElementById('userList');
    
    // Store users globally for modal access
    window.currentUsers = users;
    
    if (users.length === 0) {
        userList.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-users fa-3x text-muted mb-3"></i>
                <p class="text-muted">No users found. Create your first user to get started.</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    users.forEach(user => {
        const roleColor = {
            'admin': 'danger',
            'user': 'primary',
            'viewer': 'secondary'
        };
        
        html += `
            <div class="user-item border rounded p-3 mb-2">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-2">
                            <div class="user-avatar me-3">
                                <i class="fas fa-user-circle fa-2x text-primary"></i>
                            </div>
                            <div>
                                <h6 class="mb-0">${user.full_name}</h6>
                                <small class="text-muted">@${user.username}</small>
                            </div>
                        </div>
                        <div class="user-details">
                            <p class="mb-1">
                                <i class="fas fa-envelope me-1 text-muted"></i>
                                <small>${user.email}</small>
                            </p>
                            ${user.phone ? `
                                <p class="mb-1">
                                    <i class="fas fa-phone me-1 text-muted"></i>
                                    <small>${user.phone}</small>
                                </p>
                            ` : ''}
                            ${user.position ? `
                                <p class="mb-1">
                                    <i class="fas fa-briefcase me-1 text-muted"></i>
                                    <small>${user.position}</small>
                                </p>
                            ` : ''}
                        </div>
                    </div>
                    <div class="user-actions">
                        <span class="badge bg-${roleColor[user.role] || 'secondary'} mb-2">${user.role}</span>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="editUser('${user.id}')">
                                    <i class="fas fa-edit me-1"></i>Edit
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="resetUserPassword('${user.id}')">
                                    <i class="fas fa-key me-1"></i>Reset Password
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger" href="#" onclick="deleteUser('${user.id}')">
                                    <i class="fas fa-trash me-1"></i>Delete
                                </a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    userList.innerHTML = html;
    
    // Fix dropdown positioning for user items
    setTimeout(() => {
        const userDropdowns = document.querySelectorAll('.user-item .dropdown');
        userDropdowns.forEach(dropdown => {
            const button = dropdown.querySelector('.dropdown-toggle');
            const menu = dropdown.querySelector('.dropdown-menu');
            
            if (button && menu) {
                // Ensure proper z-index stacking
                dropdown.style.position = 'relative';
                dropdown.style.zIndex = '1000';
                
                // Add event listeners for dropdown show/hide
                button.addEventListener('click', function(e) {
                    const container = document.getElementById('userList');
                    
                    // Close any other open dropdowns
                    userDropdowns.forEach(otherDropdown => {
                        if (otherDropdown !== dropdown) {
                            const otherMenu = otherDropdown.querySelector('.dropdown-menu');
                            if (otherMenu) {
                                otherMenu.classList.remove('show');
                            }
                        }
                    });
                    
                    // Remove dropdown-open class first
                    container.classList.remove('dropdown-open');
                    
                    setTimeout(() => {
                        if (menu.classList.contains('show')) {
                            // Add dropdown-open class for CSS fallback
                            container.classList.add('dropdown-open');
                            
                            // Get button position and container dimensions
                            const buttonRect = button.getBoundingClientRect();
                            const containerRect = container.getBoundingClientRect();
                            const menuHeight = menu.offsetHeight || 150; // Estimated menu height
                            
                            // Check if dropdown would be clipped at bottom
                            const spaceBelow = containerRect.bottom - buttonRect.bottom;
                            const spaceAbove = buttonRect.top - containerRect.top;
                            
                            menu.style.position = 'absolute';
                            menu.style.zIndex = '99999';
                            menu.style.right = '0';
                            menu.style.left = 'auto';
                            menu.style.transform = 'none';
                            dropdown.style.zIndex = '1002';
                            
                            // Position dropdown above if not enough space below
                            if (spaceBelow < menuHeight && spaceAbove > menuHeight) {
                                menu.style.top = 'auto';
                                menu.style.bottom = '100%';
                                menu.style.marginBottom = '0.125rem';
                                menu.style.marginTop = '0';
                            } else {
                                menu.style.top = '100%';
                                menu.style.bottom = 'auto';
                                menu.style.marginTop = '0.125rem';
                                menu.style.marginBottom = '0';
                            }
                        } else {
                            // Remove dropdown-open class when menu is hidden
                            container.classList.remove('dropdown-open');
                        }
                    }, 1);
                });
                
                // Also listen for Bootstrap dropdown events
                dropdown.addEventListener('hidden.bs.dropdown', function() {
                    const container = document.getElementById('userList');
                    container.classList.remove('dropdown-open');
                });
            }
        });
    }, 100);
}

function updateUserStats(users) {
    document.getElementById('totalUsers').textContent = users.length;
    document.getElementById('activeUsers').textContent = users.filter(u => u.active !== false).length;
}

// Global variable to store current user being edited
let currentEditUserId = null;

function editUser(userId) {
    currentEditUserId = userId;
    
    // Fetch user details
    fetch(`/api/users/${userId}`)
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                const user = result.user;
                
                // Populate form fields
                document.getElementById('editUserId').value = user.id;
                document.getElementById('editFullName').value = user.full_name || '';
                document.getElementById('editUsername').value = user.username || '';
                document.getElementById('editEmail').value = user.email || '';
                document.getElementById('editPhone').value = user.phone || '';
                document.getElementById('editPosition').value = user.position || '';
                document.getElementById('editRole').value = user.role || 'user';
                document.getElementById('editIsActive').checked = user.is_active !== false;
                document.getElementById('editPassword').value = ''; // Clear password field
                
                // Update user info display
                document.getElementById('editUserName').textContent = user.full_name || user.username;
                const createdDate = user.created_at ? new Date(user.created_at).toLocaleDateString() : 'Unknown';
                document.getElementById('editUserCreated').textContent = `Created: ${createdDate}`;
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
                modal.show();
            } else {
                showToast('Failed to load user details: ' + result.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error loading user details:', error);
            showToast('Error loading user details', 'error');
        });
}

function toggleEditPasswordVisibility() {
    const passwordField = document.getElementById('editPassword');
    const toggleBtn = document.getElementById('editPasswordToggleBtn');
    const icon = toggleBtn.querySelector('i');
    
    if (passwordField.type === 'password') {
        passwordField.type = 'text';
        icon.className = 'fas fa-eye-slash';
        toggleBtn.title = 'Hide password';
    } else {
        passwordField.type = 'password';
        icon.className = 'fas fa-eye';
        toggleBtn.title = 'Show password';
    }
}

function generateEditPassword() {
    const length = 12;
    const charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*";
    let password = "";
    
    for (let i = 0; i < length; i++) {
        password += charset.charAt(Math.floor(Math.random() * charset.length));
    }
    
    document.getElementById('editPassword').value = password;
    document.getElementById('editPassword').type = 'text'; // Show generated password
    
    // Update toggle button
    const toggleBtn = document.getElementById('editPasswordToggleBtn');
    const icon = toggleBtn.querySelector('i');
    icon.className = 'fas fa-eye-slash';
    toggleBtn.title = 'Hide password';
    
    showToast('Password generated successfully!', 'success');
}

// Global variable to store current user being reset
let currentResetUserId = null;

function resetUserPassword(userId) {
    // Find user information
    const users = window.currentUsers || [];
    const user = users.find(u => u.id === userId);
    const userName = user ? user.full_name || user.username : 'Unknown User';
    
    // Store user ID and update modal
    currentResetUserId = userId;
    document.getElementById('resetUserName').textContent = userName;
    
    // Reset modal form
    document.getElementById('generatePassword').checked = true;
    document.getElementById('customPassword').checked = false;
    document.getElementById('customPasswordSection').classList.add('d-none');
    document.getElementById('modalNewPassword').value = '';
    document.getElementById('modalConfirmPassword').value = '';
    document.getElementById('modalPasswordMatch').textContent = '';
    document.getElementById('passwordStrength').style.width = '0%';
    document.getElementById('strengthText').textContent = 'Enter a password to see strength';
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('passwordResetModal'));
    
    // Initialize listeners before showing modal
    initializePasswordResetModalListeners();
    
    // Show modal
    modal.show();
}

function initializePasswordResetModalListeners() {
    console.log('Initializing password reset modal listeners');
    
    const generateRadio = document.getElementById('generatePassword');
    const customRadio = document.getElementById('customPassword');
    const customSection = document.getElementById('customPasswordSection');
    const newPasswordInput = document.getElementById('modalNewPassword');
    const confirmPasswordInput = document.getElementById('modalConfirmPassword');
    const togglePasswordBtn = document.getElementById('toggleModalPassword');
    const confirmBtn = document.getElementById('confirmPasswordReset');
    
    // Check if all elements exist
    if (!generateRadio || !customRadio || !customSection || !newPasswordInput || !confirmPasswordInput || !togglePasswordBtn || !confirmBtn) {
        console.error('Password reset modal elements not found');
        return;
    }
    
    // Handle reset option changes
    function updatePasswordSection() {
        console.log('Radio button changed. Custom selected:', customRadio.checked);
        if (customRadio.checked) {
            customSection.classList.remove('d-none');
            console.log('Showing custom password section');
            setTimeout(() => {
                newPasswordInput.focus();
            }, 100);
        } else {
            customSection.classList.add('d-none');
            console.log('Hiding custom password section');
        }
    }
    
    generateRadio.addEventListener('change', function() {
        console.log('Generate radio changed:', this.checked);
        updatePasswordSection();
    });
    
    customRadio.addEventListener('change', function() {
        console.log('Custom radio changed:', this.checked);
        updatePasswordSection();
    });
    
    // Password visibility toggle
    togglePasswordBtn.addEventListener('click', function() {
        const type = newPasswordInput.getAttribute('type') === 'password' ? 'text' : 'password';
        newPasswordInput.setAttribute('type', type);
        confirmPasswordInput.setAttribute('type', type);
        
        const icon = this.querySelector('i');
        icon.classList.toggle('fa-eye');
        icon.classList.toggle('fa-eye-slash');
    });
    
    // Password strength checker
    function checkPasswordStrength(password) {
        console.log('Checking password strength for:', password);
        let strength = 0;
        let feedback = '';
        
        if (password.length >= 8) strength += 25;
        if (/[a-z]/.test(password)) strength += 25;
        if (/[A-Z]/.test(password)) strength += 25;
        if (/[0-9]/.test(password)) strength += 25;
        if (/[^A-Za-z0-9]/.test(password)) strength += 10;
        
        const progressBar = document.getElementById('passwordStrength');
        const strengthText = document.getElementById('strengthText');
        
        if (progressBar && strengthText) {
            progressBar.style.width = Math.min(strength, 100) + '%';
            progressBar.className = 'progress-bar';
            
            if (strength < 50) {
                progressBar.classList.add('bg-danger');
                feedback = 'Weak password';
            } else if (strength < 75) {
                progressBar.classList.add('bg-warning');
                feedback = 'Moderate password';
            } else if (strength < 100) {
                progressBar.classList.add('bg-info');
                feedback = 'Strong password';
            } else {
                progressBar.classList.add('bg-success');
                feedback = 'Very strong password';
            }
            
            strengthText.textContent = feedback;
            console.log('Password strength updated:', feedback);
        } else {
            console.error('Password strength elements not found');
        }
    }
    
    // Password confirmation checker
    function checkPasswordMatch() {
        const password = newPasswordInput.value;
        const confirm = confirmPasswordInput.value;
        const matchDiv = document.getElementById('modalPasswordMatch');
        
        if (confirm === '') {
            matchDiv.textContent = '';
            return;
        }
        
        if (password === confirm) {
            matchDiv.textContent = '✓ Passwords match';
            matchDiv.className = 'form-text text-success';
        } else {
            matchDiv.textContent = '✗ Passwords do not match';
            matchDiv.className = 'form-text text-danger';
        }
    }
    
    newPasswordInput.addEventListener('input', function() {
        console.log('Password input event triggered, value:', this.value);
        checkPasswordStrength(this.value);
        checkPasswordMatch();
    });
    
    confirmPasswordInput.addEventListener('input', function() {
        console.log('Confirm password input event triggered, value:', this.value);
        checkPasswordMatch();
    });
    
    // Handle password reset confirmation
    confirmBtn.addEventListener('click', function() {
        const isCustom = customRadio.checked;
        let requestData = {};
        
        if (isCustom) {
            const password = newPasswordInput.value;
            const confirm = confirmPasswordInput.value;
            
            // Validate custom password
            if (!password) {
                showToast('Please enter a password', 'error');
                return;
            }
            
            if (password !== confirm) {
                showToast('Passwords do not match', 'error');
                return;
            }
            
            if (password.length < 8) {
                showToast('Password must be at least 8 characters long', 'error');
                return;
            }
            
            // Check complexity
            const hasUpper = /[A-Z]/.test(password);
            const hasLower = /[a-z]/.test(password);
            const hasDigit = /[0-9]/.test(password);
            
            if (!hasUpper || !hasLower || !hasDigit) {
                showToast('Password must contain uppercase, lowercase, and numeric characters', 'error');
                return;
            }
            
            requestData.password = password;
        }
        
        // Disable button and show loading
        confirmBtn.disabled = true;
        confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Resetting...';
        
        // Make API request
        fetch(`/api/users/${currentResetUserId}/reset-password`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                showToast(result.message, 'success');
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('passwordResetModal'));
                modal.hide();
            } else {
                showToast('Failed to reset password: ' + result.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error resetting password:', error);
            showToast('Error resetting password: ' + error.message, 'error');
        })
        .finally(() => {
            // Re-enable button
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = '<i class="fas fa-key me-1"></i>Reset Password';
        });
    });
    
    console.log('Password reset modal listeners initialized successfully');
}

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    // Other initialization code can go here
});

function deleteUser(userId) {
    if (confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
        fetch(`/api/users/${userId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                showToast('User deleted successfully!', 'success');
                refreshUserList();
            } else {
                showToast('Failed to delete user: ' + result.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error deleting user:', error);
            showToast('Error deleting user: ' + error.message, 'error');
        });
    }
}

function resetAllPasswords() {
    if (confirm('Are you sure you want to reset ALL user passwords? This will affect all users except administrators.')) {
        showToast('Bulk password reset functionality coming soon!', 'info');
    }
}

function exportUsers() {
    fetch('/api/users/export')
        .then(response => response.blob())
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = 'users-export.csv';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            showToast('User list exported successfully!', 'success');
        })
        .catch(error => {
            console.error('Error exporting users:', error);
            showToast('Error exporting users: ' + error.message, 'error');
        });
}

// Add to existing DOMContentLoaded event listener
document.addEventListener('DOMContentLoaded', function() {
    // ... existing initialization code ...
    loadViewConfigurationStatus();
    loadTablesForLayout();
    
    // Initialize user management
    const createUserForm = document.getElementById('createUserForm');
    if (createUserForm) {
        createUserForm.addEventListener('submit', function(e) {
            e.preventDefault();
            console.log('Form submit event triggered');
            createUser();
        });
        console.log('Create user form event listener attached');
    } else {
        console.error('Create user form not found during initialization');
    }
    
    // Add real-time password strength checking
    const passwordField = document.getElementById('generatedPassword');
    if (passwordField) {
        passwordField.addEventListener('input', function() {
            checkPasswordStrength(this.value);
        });
        console.log('Password field event listener attached');
    } else {
        console.error('Password field not found during initialization');
    }
    
    // Don't auto-generate password - let user choose to type or generate
    
    // Load users when tab is clicked
    document.getElementById('users-tab').addEventListener('click', function() {
        setTimeout(() => {
            refreshUserList();
        }, 100);
    });
    
    // User search functionality
    document.getElementById('userSearch').addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const userItems = document.querySelectorAll('.user-item');
        
        userItems.forEach(item => {
            const text = item.textContent.toLowerCase();
            if (text.includes(searchTerm)) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    });
    
    // Handle edit user confirmation
    document.getElementById('confirmEditUser').addEventListener('click', function() {
        const form = document.getElementById('editUserForm');
        const formData = new FormData(form);
        
        // Validate required fields
        const fullName = document.getElementById('editFullName').value.trim();
        const username = document.getElementById('editUsername').value.trim();
        const email = document.getElementById('editEmail').value.trim();
        const role = document.getElementById('editRole').value;
        
        if (!fullName || !username || !email || !role) {
            showToast('Please fill in all required fields', 'error');
            return;
        }
        
        // Validate email format
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            showToast('Please enter a valid email address', 'error');
            return;
        }
        
        // Prepare update data
        const updateData = {
            full_name: fullName,
            username: username,
            email: email,
            phone: document.getElementById('editPhone').value.trim(),
            position: document.getElementById('editPosition').value.trim(),
            role: role,
            is_active: document.getElementById('editIsActive').checked
        };
        
        // Add password if provided
        const password = document.getElementById('editPassword').value.trim();
        if (password) {
            if (password.length < 6) {
                showToast('Password must be at least 6 characters long', 'error');
                return;
            }
            updateData.password = password;
        }
        
        // Show loading state
        const confirmBtn = document.getElementById('confirmEditUser');
        const originalText = confirmBtn.innerHTML;
        confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Saving...';
        confirmBtn.disabled = true;
        
        // Send update request
        fetch(`/api/users/${currentEditUserId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(updateData)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                showToast('User updated successfully!', 'success');
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('editUserModal'));
                modal.hide();
                
                // Refresh user list
                refreshUserList();
            } else {
                showToast('Failed to update user: ' + result.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error updating user:', error);
            showToast('Error updating user', 'error');
        })
        .finally(() => {
            // Restore button state
            confirmBtn.innerHTML = originalText;
            confirmBtn.disabled = false;
        });
    });
});

// =====================================
//   CACHE MANAGEMENT FUNCTIONS
// =====================================

// Load cache statistics
async function loadCacheStats() {
    try {
        const container = document.getElementById('cacheStatsContainer');
        container.innerHTML = `
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading cache statistics...</span>
                </div>
                <p class="mt-2 text-muted">Loading cache statistics...</p>
            </div>
        `;
        
        const response = await fetch('/api/cache/stats');
        const data = await response.json();
        
        if (data.success) {
            displayCacheStats(data.cache_stats);
            updatePerformanceCards(data.cache_stats);
        } else {
            container.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Failed to load cache statistics: ${data.error}
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading cache stats:', error);
        document.getElementById('cacheStatsContainer').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Error loading cache statistics: ${error.message}
            </div>
        `;
    }
}

// Display cache statistics
function displayCacheStats(stats) {
    const container = document.getElementById('cacheStatsContainer');
    
    let statsHtml = '<div class="row g-3">';
    
    Object.entries(stats).forEach(([cacheName, cacheStats]) => {
        const hitRate = (cacheStats.hit_rate * 100).toFixed(1);
        const utilizationRate = (cacheStats.current_size / cacheStats.max_size * 100).toFixed(1);
        
        statsHtml += `
            <div class="col-md-6">
                <div class="cache-stat-card p-3 border rounded">
                    <h6 class="fw-bold text-capitalize">${cacheName.replace(/_/g, ' ')}</h6>
                    <div class="d-flex justify-content-between mb-2">
                        <small class="text-muted">Hit Rate:</small>
                        <span class="badge bg-${hitRate > 80 ? 'success' : hitRate > 50 ? 'warning' : 'danger'}">${hitRate}%</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <small class="text-muted">Size:</small>
                        <span>${cacheStats.current_size}/${cacheStats.max_size}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <small class="text-muted">Requests:</small>
                        <span>${cacheStats.total_requests}</span>
                    </div>
                    <div class="progress" style="height: 4px;">
                        <div class="progress-bar bg-${utilizationRate > 90 ? 'danger' : utilizationRate > 70 ? 'warning' : 'success'}" 
                             style="width: ${utilizationRate}%"></div>
                    </div>
                    <small class="text-muted">${utilizationRate}% utilized</small>
                </div>
            </div>
        `;
    });
    
    statsHtml += '</div>';
    container.innerHTML = statsHtml;
}

// Update performance cards
function updatePerformanceCards(stats) {
    const container = document.getElementById('cachePerformanceCards');
    
    // Calculate overall statistics
    let totalRequests = 0;
    let totalHits = 0;
    let totalSize = 0;
    let totalCapacity = 0;
    
    Object.values(stats).forEach(stat => {
        totalRequests += stat.total_requests;
        totalHits += stat.hits;
        totalSize += stat.current_size;
        totalCapacity += stat.max_size;
    });
    
    const overallHitRate = totalRequests > 0 ? (totalHits / totalRequests * 100).toFixed(1) : 0;
    const memoryUsage = totalCapacity > 0 ? (totalSize / totalCapacity * 100).toFixed(1) : 0;
    
    container.innerHTML = `
        <div class="col-md-3">
            <div class="card border-0 bg-primary text-white">
                <div class="card-body text-center">
                    <i class="fas fa-percentage fa-2x mb-2"></i>
                    <h4 class="mb-0">${overallHitRate}%</h4>
                    <small>Overall Hit Rate</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 bg-success text-white">
                <div class="card-body text-center">
                    <i class="fas fa-database fa-2x mb-2"></i>
                    <h4 class="mb-0">${totalRequests}</h4>
                    <small>Total Requests</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 bg-info text-white">
                <div class="card-body text-center">
                    <i class="fas fa-memory fa-2x mb-2"></i>
                    <h4 class="mb-0">${memoryUsage}%</h4>
                    <small>Memory Usage</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 bg-warning text-white">
                <div class="card-body text-center">
                    <i class="fas fa-layer-group fa-2x mb-2"></i>
                    <h4 class="mb-0">${Object.keys(stats).length}</h4>
                    <small>Active Caches</small>
                </div>
            </div>
        </div>
    `;
}

// Clear cache
async function clearCache() {
    try {
        const cacheType = document.getElementById('cacheTypeSelect').value;
        const cacheName = cacheType || 'all caches';
        
        if (!confirm(`Are you sure you want to clear ${cacheName}? This cannot be undone.`)) {
            return;
        }
        
        const response = await fetch('/api/cache/clear', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                cache_name: cacheType || null
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast(data.message, 'success');
            loadCacheStats(); // Refresh stats
        } else {
            showToast('Failed to clear cache: ' + data.error, 'error');
        }
    } catch (error) {
        console.error('Error clearing cache:', error);
        showToast('Error clearing cache: ' + error.message, 'error');
    }
}

// Invalidate cache by pattern
async function invalidateCachePattern() {
    try {
        const cacheName = document.getElementById('invalidateCacheSelect').value;
        const pattern = document.getElementById('cachePatternInput').value;
        
        if (!pattern) {
            showToast('Please enter a pattern to match cache keys', 'warning');
            return;
        }
        
        const response = await fetch('/api/cache/invalidate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                cache_name: cacheName,
                pattern: pattern
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast(data.message, 'success');
            loadCacheStats(); // Refresh stats
            document.getElementById('cachePatternInput').value = ''; // Clear input
        } else {
            showToast('Failed to invalidate cache: ' + data.error, 'error');
        }
    } catch (error) {
        console.error('Error invalidating cache:', error);
        showToast('Error invalidating cache: ' + error.message, 'error');
    }
}

// Cleanup expired cache entries
async function cleanupExpiredCache() {
    try {
        const response = await fetch('/api/cache/cleanup', {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast(data.message, 'success');
            loadCacheStats(); // Refresh stats
        } else {
            showToast('Failed to cleanup cache: ' + data.error, 'error');
        }
    } catch (error) {
        console.error('Error cleaning up cache:', error);
        showToast('Error cleaning up cache: ' + error.message, 'error');
    }
}

// Load cache stats when cache tab is shown
document.addEventListener('DOMContentLoaded', function() {
    const cacheTab = document.getElementById('cache-tab');
    if (cacheTab) {
        cacheTab.addEventListener('shown.bs.tab', function() {
            loadCacheStats();
        });
    }
});

</script>

<!-- Password Reset Modal -->
<div class="modal fade" id="passwordResetModal" tabindex="-1" aria-labelledby="passwordResetModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="passwordResetModalLabel">
                    <i class="fas fa-key me-2"></i>Reset User Password
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <p class="text-muted mb-3">
                        <i class="fas fa-info-circle me-1"></i>
                        Choose how you want to reset the password for this user.
                    </p>
                </div>
                
                <!-- Reset Options -->
                <div class="mb-4">
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="radio" name="resetOption" id="generatePassword" value="generate" checked>
                        <label class="form-check-label" for="generatePassword">
                            <strong>Generate Random Password</strong>
                            <small class="d-block text-muted">System will create a secure 12-character password</small>
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="resetOption" id="customPassword" value="custom">
                        <label class="form-check-label" for="customPassword">
                            <strong>Set Custom Password</strong>
                            <small class="d-block text-muted">Enter a specific password for this user</small>
                        </label>
                    </div>
                </div>

                <!-- Custom Password Input (hidden by default) -->
                <div id="customPasswordSection" class="d-none">
                    <div class="mb-3">
                        <label for="modalNewPassword" class="form-label">New Password</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="modalNewPassword" placeholder="Enter new password">
                            <button class="btn btn-outline-secondary" type="button" id="toggleModalPassword">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div id="modalPasswordHelp" class="form-text">
                            Password must be at least 8 characters long and contain uppercase, lowercase, and numeric characters.
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="modalConfirmPassword" class="form-label">Confirm Password</label>
                        <input type="password" class="form-control" id="modalConfirmPassword" placeholder="Confirm new password">
                        <div id="modalPasswordMatch" class="form-text"></div>
                    </div>
                    
                    <!-- Password Strength Indicator -->
                    <div class="mb-3">
                        <label class="form-label small">Password Strength</label>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar" id="passwordStrength" role="progressbar" style="width: 0%"></div>
                        </div>
                        <small class="text-muted" id="strengthText">Enter a password to see strength</small>
                    </div>
                </div>

                <!-- User Info -->
                <div class="alert alert-info">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-user me-2"></i>
                        <div>
                            <strong>Resetting password for:</strong>
                            <span id="resetUserName">User Name</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" id="confirmPasswordReset">
                    <i class="fas fa-key me-1"></i>Reset Password
                </button>
            </div>
        </div>
        
        <!-- Cache Management -->
        <div class="tab-pane fade" id="cache" role="tabpanel" aria-labelledby="cache-tab">
            <div class="row">
                <!-- Cache Statistics -->
                <div class="col-lg-6">
                    <div class="card settings-card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-chart-pie me-2"></i>Cache Statistics
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="cache-stats-container" id="cacheStatsContainer">
                                <div class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading cache statistics...</span>
                                    </div>
                                    <p class="mt-2 text-muted">Loading cache statistics...</p>
                                </div>
                            </div>
                            <div class="d-flex gap-2 mt-3">
                                <button class="btn btn-primary btn-sm" onclick="loadCacheStats()">
                                    <i class="fas fa-refresh me-1"></i>Refresh Stats
                                </button>
                                <button class="btn btn-warning btn-sm" onclick="cleanupExpiredCache()">
                                    <i class="fas fa-broom me-1"></i>Cleanup Expired
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Cache Management Actions -->
                <div class="col-lg-6">
                    <div class="card settings-card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-tools me-2"></i>Cache Management
                            </h5>
                        </div>
                        <div class="card-body">
                            <!-- Clear Cache Section -->
                            <div class="mb-4">
                                <h6 class="fw-bold">
                                    <i class="fas fa-trash me-1"></i>Clear Cache
                                </h6>
                                <div class="row g-2">
                                    <div class="col-md-8">
                                        <select class="form-select" id="cacheTypeSelect">
                                            <option value="">All Caches</option>
                                            <option value="database_queries">Database Queries</option>
                                            <option value="api_responses">API Responses</option>
                                            <option value="table_metadata">Table Metadata</option>
                                            <option value="user_data">User Data</option>
                                            <option value="configuration">Configuration</option>
                                            <option value="static_assets">Static Assets</option>
                                            <option value="visualization_data">Visualization Data</option>
                                            <option value="file_uploads">File Uploads</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <button class="btn btn-danger w-100" onclick="clearCache()">
                                            <i class="fas fa-trash me-1"></i>Clear
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Cache Invalidation Section -->
                            <div class="mb-4">
                                <h6 class="fw-bold">
                                    <i class="fas fa-search me-1"></i>Invalidate by Pattern
                                </h6>
                                <div class="row g-2">
                                    <div class="col-md-5">
                                        <select class="form-select" id="invalidateCacheSelect">
                                            <option value="database_queries">Database Queries</option>
                                            <option value="api_responses">API Responses</option>
                                            <option value="table_metadata">Table Metadata</option>
                                            <option value="user_data">User Data</option>
                                            <option value="configuration">Configuration</option>
                                            <option value="static_assets">Static Assets</option>
                                            <option value="visualization_data">Visualization Data</option>
                                            <option value="file_uploads">File Uploads</option>
                                        </select>
                                    </div>
                                    <div class="col-md-5">
                                        <input type="text" class="form-control" id="cachePatternInput" 
                                               placeholder="e.g., table_.*" title="Regular expression pattern">
                                    </div>
                                    <div class="col-md-2">
                                        <button class="btn btn-warning w-100" onclick="invalidateCachePattern()">
                                            <i class="fas fa-eraser me-1"></i>Go
                                        </button>
                                    </div>
                                </div>
                                <small class="text-muted">Use regex patterns to match cache keys</small>
                            </div>
                            
                            <!-- Cache Settings -->
                            <div>
                                <h6 class="fw-bold">
                                    <i class="fas fa-cog me-1"></i>Cache Settings
                                </h6>
                                <div class="row g-2">
                                    <div class="col-md-6">
                                        <label class="form-label">Auto-cleanup interval (minutes)</label>
                                        <input type="number" class="form-control" id="cacheCleanupInterval" 
                                               value="30" min="5" max="120">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Max cache size per type</label>
                                        <input type="number" class="form-control" id="maxCacheSize" 
                                               value="1000" min="100" max="10000">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Cache Performance Monitoring -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card settings-card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-tachometer-alt me-2"></i>Performance Monitoring
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row" id="cachePerformanceCards">
                                <!-- Performance cards will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editUserModalLabel">
                    <i class="fas fa-user-edit me-2"></i>Edit User
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editUserForm">
                    <input type="hidden" id="editUserId" name="user_id">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editFullName" class="form-label">
                                    <i class="fas fa-user me-1"></i>Full Name
                                </label>
                                <input type="text" class="form-control" id="editFullName" name="full_name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editUsername" class="form-label">
                                    <i class="fas fa-at me-1"></i>Username
                                </label>
                                <input type="text" class="form-control" id="editUsername" name="username" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editEmail" class="form-label">
                                    <i class="fas fa-envelope me-1"></i>Email Address
                                </label>
                                <input type="email" class="form-control" id="editEmail" name="email" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editPhone" class="form-label">
                                    <i class="fas fa-phone me-1"></i>Phone Number
                                </label>
                                <input type="tel" class="form-control" id="editPhone" name="phone">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editPosition" class="form-label">
                                    <i class="fas fa-briefcase me-1"></i>Position/Role
                                </label>
                                <input type="text" class="form-control" id="editPosition" name="position">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editRole" class="form-label">
                                    <i class="fas fa-shield me-1"></i>Access Level
                                </label>
                                <select class="form-control" id="editRole" name="role" required>
                                    <option value="">Select Access Level</option>
                                    <option value="admin">Administrator</option>
                                    <option value="user">Standard User</option>
                                    <option value="viewer">Viewer Only</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Status Toggle -->
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="editIsActive" name="is_active" checked>
                            <label class="form-check-label" for="editIsActive">
                                <i class="fas fa-toggle-on me-1"></i>User is Active
                            </label>
                        </div>
                    </div>
                    
                    <!-- Password Section -->
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-key me-1"></i>Password (Optional)
                        </label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="editPassword" name="password" 
                                   placeholder="Leave blank to keep current password">
                            <button class="btn btn-outline-secondary" type="button" onclick="toggleEditPasswordVisibility()" 
                                    title="Toggle password visibility" id="editPasswordToggleBtn">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-outline-info" type="button" onclick="generateEditPassword()" 
                                    title="Generate secure password">
                                <i class="fas fa-sync-alt"></i> Generate
                            </button>
                        </div>
                        <div class="form-text">
                            Leave password field empty to keep the current password unchanged.
                        </div>
                    </div>
                    
                    <!-- User Info Display -->
                    <div class="alert alert-info">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-info-circle me-2"></i>
                            <div>
                                <strong>Editing user:</strong>
                                <span id="editUserName">User Name</span>
                                <small class="d-block text-muted" id="editUserCreated">Created: -</small>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" id="confirmEditUser">
                    <i class="fas fa-save me-1"></i>Save Changes
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
