{% extends "base.html" %}

{% block title %}Dashboard - UTS 2.0{% endblock %}

{% block content %}
<!-- Header Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="mb-2 text-gradient">
                    <i class="fas fa-tachometer-alt me-2 pulse-glow"></i>Database Dashboard
                </h1>
                <p class="text-muted mb-0 fw-medium">Real-time monitoring and data exploration</p>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-primary icon-hover" onclick="refreshDashboard()">
                    <i class="fas fa-sync-alt me-1" id="refreshIcon"></i>Refresh
                </button>
                <button class="btn btn-outline-success icon-hover" onclick="checkConnection()" id="connectionBtn">
                    <i class="fas fa-plug me-1"></i>Test Connection
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Status Cards Row -->
<div class="row mb-4">
    <!-- Connection Status Card -->
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card h-100 {{ 'border-success pulse-glow' if connection_status else 'border-danger' }}">
            <div class="card-body text-center">
                <div class="connection-indicator mb-3 {{ 'connected floating' if connection_status }}">
                    <i class="fas fa-{{ 'check-circle' if connection_status else 'times-circle' }} fa-3x text-{{ 'success' if connection_status else 'danger' }}"></i>
                </div>
                <h5 class="card-title fw-semibold">Connection Status</h5>
                <p class="card-text">
                    <span class="badge bg-{{ 'success' if connection_status else 'danger' }} fs-6" id="connectionStatus">
                        {{ 'Connected' if connection_status else 'Disconnected' }}
                    </span>
                    {% if connection_status %}
                    <div class="mt-2">
                        <button class="btn btn-outline-danger btn-sm icon-hover" onclick="disconnectFromDashboard()">
                            <i class="fas fa-unlink me-1"></i>Disconnect
                        </button>
                    </div>
                    {% endif %}
                </p>
                <small class="text-muted" id="lastChecked">Last checked: Just now</small>
            </div>
        </div>
    </div>

    <!-- Database Info Card -->
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card h-100">
            <div class="card-body text-center">
                <div class="database-icon mb-3">
                    <i class="fas fa-database fa-3x text-primary"></i>
                </div>
                <h5 class="card-title fw-semibold">Tables Size</h5>
                <p class="card-text">
                    <span class="badge bg-primary fs-6" id="databaseName">
                        {% if stats and stats.database_name %}
                            {{ stats.database_name }}
                        {% else %}
                            Not Connected
                        {% endif %}
                    </span>
                </p>
                <small class="text-muted" id="dbSize">
                    {% if stats and stats.database_size %}
                        Total: {{ stats.database_size }}
                    {% else %}
                        No data available
                    {% endif %}
                </small>
            </div>
        </div>
    </div>

    <!-- Tables Count Card -->
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card h-100">
            <div class="card-body text-center">
                <div class="tables-icon mb-3">
                    <i class="fas fa-table fa-3x text-info"></i>
                </div>
                <h5 class="card-title fw-semibold">Tables</h5>
                <p class="card-text">
                    <span class="badge bg-info fs-6" id="tablesCount">
                        {{ tables|length if tables else '0' }}
                    </span>
                </p>
                <small class="text-muted">
                    {% if tables %}
                        {{ tables|length }} table{{ 's' if tables|length != 1 else '' }} available
                    {% else %}
                        No tables found
                    {% endif %}
                </small>
            </div>
        </div>
    </div>

    <!-- Total Records Card -->
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card h-100">
            <div class="card-body text-center">
                <div class="records-icon mb-3">
                    <i class="fas fa-list-ol fa-3x text-warning"></i>
                </div>
                <h5 class="card-title fw-semibold">Total Records</h5>
                <p class="card-text">
                    <span class="badge bg-warning fs-6" id="totalRecords">
                        {% if stats and stats.table_stats %}
                            {{ "{:,}".format(stats.table_stats|sum(attribute=5)) }}
                        {% else %}
                            0
                        {% endif %}
                    </span>
                </p>
                <small class="text-muted">
                    {% if stats and stats.table_stats %}
                        Across all tables
                    {% else %}
                        No data available
                    {% endif %}
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Tables Overview Section -->
{% if connection_status and tables %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-table me-2"></i>Database Tables
                </h5>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-primary btn-sm" onclick="toggleTableView()">
                                <i class="fas fa-th-large me-1"></i>Card View
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="refreshTableStats()">
                                <i class="fas fa-sync-alt me-1"></i>Refresh Stats
                            </button>
                        </div>
            </div>
            <div class="card-body">
                <!-- Search Bar -->
                <div class="mb-3">
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="fas fa-search"></i>
                        </span>
                        <input type="text" 
                               class="form-control" 
                               id="tableSearchInput" 
                               placeholder="Search tables by name..."
                               autocomplete="off">
                        <button class="btn btn-outline-secondary" 
                                type="button" 
                                id="clearSearchBtn" 
                                style="display: none;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                
                <div class="row" id="tablesContainer">
                    {% for table in tables %}
                    <div class="col-md-6 col-xl-4 mb-3 table-card">
                        <div class="card h-100 table-item" data-table="{{ table }}">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title mb-0 fw-semibold" title="{{ table }}">
                                        <i class="fas fa-table me-1 text-primary"></i>{{ table }}
                                    </h6>
                                </div>
                                
                                <div class="table-stats" data-table="{{ table }}">
                                    <div class="row text-center">
                                        <div class="col-4">
                                            <small class="text-muted d-block">Rows</small>
                                            <strong class="text-primary table-row-count">
                                                <div class="spinner-border spinner-border-sm" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                            </strong>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted d-block">Columns</small>
                                            <strong class="text-info table-column-count">
                                                <div class="spinner-border spinner-border-sm" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                            </strong>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted d-block">Size</small>
                                            <strong class="text-warning table-size">
                                                <div class="spinner-border spinner-border-sm" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                            </strong>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer bg-transparent">
                                <a href="{{ url_for('view_table', table_name=table) }}" class="btn btn-primary btn-sm w-100">
                                    <i class="fas fa-eye me-1"></i>View Data
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Activity Chart Section -->
{% if stats and stats.table_stats %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-pie me-2"></i>Table Activity Overview
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-lg-8">
                        <canvas id="activityChart" width="400" height="200"></canvas>
                    </div>
                    <div class="col-lg-4">
                        <div class="table-legend">
                            <h6 class="fw-semibold mb-3">Table Statistics</h6>
                            {% for stat in stats.table_stats[:5] %}
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="text-truncate" title="{{ stat[1] }}">{{ stat[1] }}</span>
                                <span class="badge bg-primary">{{ "{:,}".format(stat[5]) }}</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Quick Actions Section -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-bolt me-2"></i>Quick Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3 col-sm-6">
                        <a href="/databases" class="btn btn-outline-primary w-100 h-100 d-flex flex-column align-items-center justify-content-center py-3">
                            <i class="fas fa-database fa-2x mb-2"></i>
                            <span>Manage Databases</span>
                        </a>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <a href="/visualizations" class="btn btn-outline-info w-100 h-100 d-flex flex-column align-items-center justify-content-center py-3">
                            <i class="fas fa-chart-line fa-2x mb-2"></i>
                            <span>Create Visualizations</span>
                        </a>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <a href="/config" class="btn btn-outline-secondary w-100 h-100 d-flex flex-column align-items-center justify-content-center py-3">
                            <i class="fas fa-cog fa-2x mb-2"></i>
                            <span>System Settings</span>
                        </a>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <button class="btn btn-outline-success w-100 h-100 d-flex flex-column align-items-center justify-content-center py-3" onclick="refreshDashboard()">
                            <i class="fas fa-sync-alt fa-2x mb-2"></i>
                            <span>Refresh All Data</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Global variables
let activityChart = null;
let refreshInterval = null;

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    initializeChart();
    setupViewToggle();
    startAutoRefresh();
    setupSearchFilter();
    setupTableSearch();
    
    // Load table stats with a small delay to ensure DOM is ready
    setTimeout(() => {
        loadTableStats();
    }, 100);
    
    initializeTableDropdowns();
    addClickOutsideToClose();
});

// Chart initialization
function initializeChart() {
    {% if stats and stats.table_stats %}
    const ctx = document.getElementById('activityChart');
    if (ctx) {
        const data = {
            labels: [{% for stat in stats.table_stats[:5] %}'{{ stat[1] }}'{{ ',' if not loop.last }}{% endfor %}],
            datasets: [{
                label: 'Live Rows',
                data: [{% for stat in stats.table_stats[:5] %}{{ stat[5] }}{{ ',' if not loop.last }}{% endfor %}],
                backgroundColor: [
                    'rgba(54, 162, 235, 0.8)',
                    'rgba(255, 99, 132, 0.8)',
                    'rgba(255, 205, 86, 0.8)',
                    'rgba(75, 192, 192, 0.8)',
                    'rgba(153, 102, 255, 0.8)'
                ],
                borderColor: [
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 99, 132, 1)',
                    'rgba(255, 205, 86, 1)',
                    'rgba(75, 192, 192, 1)',
                    'rgba(153, 102, 255, 1)'
                ],
                borderWidth: 2
            }]
        };

        const config = {
            type: 'doughnut',
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true
                        }
                    }
                }
            }
        };

        activityChart = new Chart(ctx, config);
    }
    {% endif %}
}

// Refresh dashboard
async function refreshDashboard() {
    try {
        showLoading(true);
        
        // Refresh connection status
        await updateConnectionStatus();
        
        // Refresh table stats with force refresh
        await loadTableStats(true, true);
        
        showToast('Dashboard refreshed successfully!', 'success');
    } catch (error) {
        showToast('Error refreshing dashboard: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}

// Update connection status
async function updateConnectionStatus() {
    try {
        const response = await fetch('/api/connection/status');
        const data = await response.json();
        
        const statusElement = document.getElementById('connectionStatus');
        const lastCheckedElement = document.getElementById('lastChecked');
        
        if (statusElement) {
            statusElement.textContent = data.success ? 'Connected' : 'Disconnected';
            statusElement.className = `badge bg-${data.success ? 'success' : 'danger'} fs-6`;
        }
        
        if (lastCheckedElement) {
            lastCheckedElement.textContent = `Last checked: ${new Date().toLocaleTimeString()}`;
        }
    } catch (error) {
        console.error('Error updating connection status:', error);
    }
}

// Cache for table stats to avoid repeated API calls
const tableStatsCache = new Map();
const CACHE_DURATION = 30000; // 30 seconds

// Load table stats with optimizations
async function loadTableStats(useFastMode = true, forceRefresh = false) {
    try {
        const tableNames = Array.from(document.querySelectorAll('.table-item')).map(card => 
            card.getAttribute('data-table')
        );
        
        if (tableNames.length === 0) {
            return;
        }
        
        // Check cache first (unless force refresh)
        if (!forceRefresh) {
            const cachedStats = getCachedStats(tableNames);
            if (cachedStats) {
                updateTableStatsDisplay(cachedStats);
                return;
            }
        }
        
        // Show loading state
        showTableStatsLoading(true);
        
        // Try the original working method first
        try {
            // Create URL with proper parameter format
            const url = new URL('/api/tables/lazy-stats', window.location.origin);
            tableNames.forEach(table => {
                url.searchParams.append('tables', table);
            });
            
            const response = await fetch(url.toString());
            const data = await response.json();
            
            if (data.success && data.stats) {
                // Cache the results
                cacheStats(data.stats);
                updateTableStatsDisplay(data.stats);
                return;
            }
        } catch (originalError) {
            // Fall through to fallback method
        }
        
        // Fallback to new method
        const url = new URL('/api/tables/lazy-stats', window.location.origin);
        tableNames.forEach(table => {
            url.searchParams.append('tables', table);
        });
        url.searchParams.append('fast', useFastMode.toString());
        url.searchParams.append('ultra_fast', 'false');
        
        const response = await fetch(url.toString());
        const data = await response.json();
        
        if (data.success && data.stats) {
            // Cache the results
            cacheStats(data.stats);
            updateTableStatsDisplay(data.stats);
        } else {
            showStatsError(tableNames, data.error || 'Failed to load table statistics');
        }
        
    } catch (error) {
        console.error('Error loading table stats:', error);
        showStatsError(tableNames, error.message);
    } finally {
        showTableStatsLoading(false);
    }
}

// Load a batch of table stats
async function loadTableStatsBatch(tableNames, useFastMode, isInitialLoad = false) {
    const params = new URLSearchParams({
        tables: tableNames.join(','),
        fast: useFastMode.toString(),
        ultra_fast: isInitialLoad.toString() // Use ultra-fast for initial loads
    });
    
    const response = await fetch(`/api/tables/lazy-stats?${params}`);
    const data = await response.json();
    
    if (data.success) {
        return data.stats;
    } else {
        throw new Error(data.error || 'Failed to load batch');
    }
}

// Cache management
function cacheStats(stats) {
    const timestamp = Date.now();
    Object.entries(stats).forEach(([tableName, tableStats]) => {
        tableStatsCache.set(tableName, {
            data: tableStats,
            timestamp: timestamp
        });
    });
}

function getCachedStats(tableNames) {
    const now = Date.now();
    const cachedStats = {};
    let hasValidCache = false;
    
    tableNames.forEach(tableName => {
        const cached = tableStatsCache.get(tableName);
        if (cached && (now - cached.timestamp) < CACHE_DURATION) {
            cachedStats[tableName] = cached.data;
            hasValidCache = true;
        }
    });
    
    return hasValidCache ? cachedStats : null;
}

// Show/hide loading state for table stats
function showTableStatsLoading(show) {
    const loadingElements = document.querySelectorAll('.table-stats .spinner-border');
    
    loadingElements.forEach(element => {
        if (show) {
            element.style.display = 'inline-block';
        } else {
            element.style.display = 'none';
        }
    });
}

// Update table stats display
function updateTableStatsDisplay(stats) {
    Object.entries(stats).forEach(([tableName, tableStats]) => {
        const cardStats = document.querySelector(`.table-stats[data-table="${tableName}"]`);
        if (cardStats) {
            const rowCount = cardStats.querySelector('.table-row-count');
            const columnCount = cardStats.querySelector('.table-column-count');
            const tableSize = cardStats.querySelector('.table-size');
            
            if (rowCount) {
                const displayValue = typeof tableStats.row_count === 'number' ? 
                    tableStats.row_count.toLocaleString() : tableStats.row_count;
                // Clear any existing content (including spinners) and set the value
                rowCount.innerHTML = '';
                rowCount.textContent = displayValue;
            }
            if (columnCount) {
                // Clear any existing content (including spinners) and set the value
                columnCount.innerHTML = '';
                columnCount.textContent = tableStats.column_count;
            }
            if (tableSize) {
                // Clear any existing content (including spinners) and set the value
                tableSize.innerHTML = '';
                tableSize.textContent = tableStats.table_size;
            }
        }
    });
    
    // Update total tables size
    updateTotalTablesSize(stats);
}

// Calculate and update total tables size
function updateTotalTablesSize(stats) {
    let totalSizeBytes = 0;
    
    Object.values(stats).forEach(tableStats => {
        if (tableStats.table_size) {
            const sizeStr = tableStats.table_size.toLowerCase();
            let sizeBytes = 0;
            
            if (sizeStr.includes('kb')) {
                sizeBytes = parseFloat(sizeStr) * 1024;
            } else if (sizeStr.includes('mb')) {
                sizeBytes = parseFloat(sizeStr) * 1024 * 1024;
            } else if (sizeStr.includes('gb')) {
                sizeBytes = parseFloat(sizeStr) * 1024 * 1024 * 1024;
            } else if (sizeStr.includes('bytes')) {
                sizeBytes = parseFloat(sizeStr);
            }
            
            totalSizeBytes += sizeBytes;
        }
    });
    
    // Format the total size
    const formattedSize = formatBytes(totalSizeBytes);
    
    // Update the database size display
    const dbSizeElement = document.getElementById('dbSize');
    if (dbSizeElement) {
        dbSizeElement.textContent = `Total: ${formattedSize}`;
    }
}

// Format bytes to human readable format
function formatBytes(bytes) {
    if (bytes === 0) return '0 bytes';
    
    const k = 1024;
    const sizes = ['bytes', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

// Show stats error
function showStatsError(tableNames, error) {
    tableNames.forEach(tableName => {
        const cardStats = document.querySelector(`.table-stats[data-table="${tableName}"]`);
        if (cardStats) {
            const elements = cardStats.querySelectorAll('.table-row-count, .table-column-count, .table-size');
            elements.forEach(el => el.innerHTML = '<small class="text-muted">Error</small>');
        }
    });
}

// Check connection
async function checkConnection() {
    try {
        showLoading(true);
        const response = await fetch('/api/connection/test');
        const data = await response.json();
        
        if (data.success) {
            showToast('Connection successful!', 'success');
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showToast('Connection failed: ' + data.error, 'error');
        }
    } catch (error) {
        showToast('Connection error: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}

// Disconnect from dashboard
async function disconnectFromDashboard() {
    try {
        showLoading(true);
        const response = await fetch('/api/connection/disconnect', {
            method: 'POST'
        });
        const data = await response.json();
        
        if (data.success) {
            showToast('Disconnected successfully!', 'success');
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showToast('Disconnect failed: ' + data.error, 'error');
        }
    } catch (error) {
        showToast('Disconnect error: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}

// Auto refresh
function startAutoRefresh() {
    refreshInterval = setInterval(() => {
        updateConnectionStatus();
        loadTableStats(true, false); // Use fast mode, don't force refresh
    }, 30000); // Refresh every 30 seconds
}

// Stop auto refresh
function stopAutoRefresh() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
        refreshInterval = null;
    }
}

// Show loading state
function showLoading(show) {
    const refreshIcon = document.getElementById('refreshIcon');
    if (refreshIcon) {
        if (show) {
            refreshIcon.classList.add('fa-spin');
        } else {
            refreshIcon.classList.remove('fa-spin');
        }
    }
}

// Show toast message
function showToast(message, type = 'info') {
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type} border-0`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    // Add to page
    document.body.appendChild(toast);
    
    // Show toast
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    // Remove after hide
    toast.addEventListener('hidden.bs.toast', () => {
        document.body.removeChild(toast);
    });
}

// Setup view toggle
function setupViewToggle() {
    // This function can be expanded for view switching functionality
}

// Setup search filter
function setupSearchFilter() {
    // This function can be expanded for search functionality
}

// Initialize table dropdowns
function initializeTableDropdowns() {
    // This function can be expanded for table dropdown functionality
}

// Add click outside to close
function addClickOutsideToClose() {
    // This function can be expanded for dropdown functionality
}

// Toggle table view
function toggleTableView() {
    // This function can be expanded for table view switching
}

// Refresh table stats
function refreshTableStats() {
    loadTableStats(true, true); // Use fast mode but force refresh
    showToast('Table statistics refreshed!', 'success');
}

// Setup table search functionality
function setupTableSearch() {
    const searchInput = document.getElementById('tableSearchInput');
    const clearBtn = document.getElementById('clearSearchBtn');
    const tableCards = document.querySelectorAll('.table-card');
    
    if (!searchInput) return;
    
    // Search input event listener
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase().trim();
        filterTableCards(searchTerm, tableCards);
        
        // Show/hide clear button
        if (searchTerm.length > 0) {
            clearBtn.style.display = 'block';
        } else {
            clearBtn.style.display = 'none';
        }
    });
    
    // Clear button event listener
    clearBtn.addEventListener('click', function() {
        searchInput.value = '';
        searchInput.focus();
        filterTableCards('', tableCards);
        clearBtn.style.display = 'none';
    });
    
    // Escape key to clear search
    searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            this.value = '';
            filterTableCards('', tableCards);
            clearBtn.style.display = 'none';
        }
    });
}

// Filter table cards based on search term
function filterTableCards(searchTerm, tableCards) {
    let visibleCount = 0;
    
    tableCards.forEach(card => {
        const tableName = card.querySelector('.table-item').getAttribute('data-table');
        const isMatch = tableName.toLowerCase().includes(searchTerm);
        
        if (isMatch) {
            card.style.display = 'block';
            visibleCount++;
        } else {
            card.style.display = 'none';
        }
    });
    
    // Show/hide no results message
    showNoResultsMessage(visibleCount === 0 && searchTerm.length > 0);
}

// Show/hide no results message
function showNoResultsMessage(show) {
    let noResultsMsg = document.getElementById('noResultsMessage');
    
    if (show && !noResultsMsg) {
        // Create no results message
        noResultsMsg = document.createElement('div');
        noResultsMsg.id = 'noResultsMessage';
        noResultsMsg.className = 'col-12 text-center py-5';
        noResultsMsg.innerHTML = `
            <div class="text-muted">
                <i class="fas fa-search fa-3x mb-3"></i>
                <h5>No tables found</h5>
                <p>Try adjusting your search terms</p>
            </div>
        `;
        
        // Insert after search bar
        const searchBar = document.querySelector('.mb-3');
        searchBar.insertAdjacentElement('afterend', noResultsMsg);
    } else if (!show && noResultsMsg) {
        noResultsMsg.remove();
    }
}


// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    stopAutoRefresh();
});
</script>
{% endblock %}